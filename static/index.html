<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šçŸ¥å®šæ—¶å‘é€ç³»ç»Ÿ</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMjggMTI4Ij48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImdyYWQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiM2NjdlZWEiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiM3NjRiYTIiLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48cmVjdCB4PSIxNiIgeT0iMTYiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgcng9IjI4IiBmaWxsPSJ1cmwoI2dyYWQpIi8+PHBhdGggZD0iTTMyIDUyYzAtNC40MTggMy41ODItOCA4LThoNDhjNC40MTggMCA4IDMuNTgyIDggOHYyNGMwIDQuNDE4LTMuNTgyIDgtOCA4SDQwYy00LjQxOCAwLTgtMy41ODItOC04VjUyeiIgZmlsbD0iI2ZmZiIgb3BhY2l0eT0iMC45NSIvPjxwYXRoIGQ9Ik0zNiA1MGwyOCAyMiAyOC0yMiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjNzY0YmEyIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjxjaXJjbGUgY3g9IjkyIiBjeT0iNDAiIHI9IjEwIiBmaWxsPSIjMjdhZTYwIiBzdHJva2U9IiNmZmYiIHN0cm9rZS13aWR0aD0iNCIvPjxwYXRoIGQ9Ik04OCA0MGwzIDMgNS02IiBmaWxsPSJub25lIiBzdHJva2U9IiNmZmYiIHN0cm9rZS13aWR0aD0iMyIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+PC9zdmc+">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            color: white;
            margin-bottom: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left;
            gap: 24px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .brand-logo {
            width: 68px;
            height: 68px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.12);
            padding: 8px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
        }

        .brand-logo svg {
            width: 100%;
            height: 100%;
            display: block;
        }

        .brand-copy h1 {
            margin-bottom: 6px;
        }

        .brand-copy p {
            margin: 0;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .user-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            font-size: 0.9rem;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 15px;
            margin-left: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        /* å·²ä¿å­˜æ¸ é“ä¸‹æ‹‰æ ·å¼ï¼Œä½¿å…¶ä¸å…¶ä»–è¡¨å•æ§ä»¶ä¸€è‡´ */
        .user-channel-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            color: #333;
            background: white;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            margin-bottom: 15px;
            background-image: linear-gradient(45deg, transparent 50%, #667eea 50%),
                              linear-gradient(135deg, #667eea 50%, transparent 50%),
                              linear-gradient(to right, #ccc, #ccc);
            background-position: calc(100% - 20px) calc(50% - 6px), calc(100% - 15px) calc(50% - 6px), 100% 0;
            background-size: 6px 6px, 6px 6px, 1px 1.5em;
            background-repeat: no-repeat;
        }

        .user-channel-select:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 4px rgba(102,126,234,0.06);
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .config-fields {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .config-fields .form-group {
            margin-bottom: 15px;
        }

        .config-fields .form-group:last-child {
            margin-bottom: 0;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-info {
            background: #3498db;
            color: white;
        }

        .task-list {
            max-height: 600px;
            overflow-y: auto;
            padding: 2px; /* ä¸ºå¯èƒ½çš„é˜´å½±æ•ˆæœæä¾›ç¼“å†²ç©ºé—´ */
            margin: -2px; /* æŠµæ¶ˆå†…è¾¹è·å¯¹å¸ƒå±€çš„å½±å“ */
        }

        .task-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
        }

        /* åŸæœ‰çš„æ‚¬åœæ•ˆæœå·²åœ¨å“åº”å¼éƒ¨åˆ†é‡æ–°å®šä¹‰ */

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .task-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 5px;
        }

        .task-content {
            color: #666;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .task-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            font-size: 0.9rem;
            color: #777;
        }

        .task-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-sent {
            background: #d4edda;
            color: #155724;
        }

        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }

        .status-cancelled {
            background: #e2e3e5;
            color: #383d41;
        }

        .channel-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-bar select {
            flex: 1;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        .notification.success {
            background: #27ae60;
        }

        .notification.error {
            background: #e74c3c;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
        }

        .login-card {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .login-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .login-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .login-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .channel-management {
            margin-top: 20px;
        }

        .channel-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .channel-info {
            flex: 1;
        }

        .channel-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .channel-type {
            color: #666;
            font-size: 0.9rem;
        }

        .channel-actions {
            display: flex;
            gap: 10px;
        }

        /* å“åº”å¼è®¾è®¡å¢å¼º */

        /* å¹³æ¿è®¾å¤‡é€‚é… */
        @media (max-width: 1200px) {
            .container {
                padding: 0 15px;
            }

            .card {
                padding: 20px;
            }

            header h1 {
                font-size: 2.2rem;
            }

            .main-content {
                gap: 15px;
            }
        }

        /* å°å¹³æ¿è®¾å¤‡é€‚é… */
        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            header {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }

            .brand {
                flex-direction: column;
                text-align: center;
            }

            .brand-logo {
                width: 56px;
                height: 56px;
            }

            header h1 {
                font-size: 2rem;
            }

            .user-info {
                align-self: center;
            }
        }

        /* æ‰‹æœºè®¾å¤‡é€‚é… */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 0 10px;
            }

            header {
                margin-bottom: 25px;
            }

            header h1 {
                font-size: 1.8rem;
                margin-bottom: 8px;
            }

            header p {
                font-size: 1rem;
            }

            .card {
                padding: 15px;
                margin-bottom: 15px;
            }

            .card h2 {
                font-size: 1.3rem;
            }

            .form-group input,
            .form-group textarea,
            .form-group select {
                padding: 10px;
                font-size: 16px; /* é˜²æ­¢ iOS è‡ªåŠ¨ç¼©æ”¾ */
            }

            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }

            .task-meta {
                flex-direction: column;
                gap: 8px;
            }

            .task-header {
                flex-direction: column;
                gap: 10px;
            }

            .filter-bar {
                flex-direction: column;
                gap: 10px;
            }

            .notification {
                max-width: calc(100vw - 40px);
                right: 20px;
                left: 20px;
            }

            .channel-actions {
                flex-direction: column;
                gap: 8px;
            }

            .channel-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .modal-content {
                margin: 10% auto;
                padding: 15px;
                width: 95%;
            }

            .login-container {
                margin: 50px 10px;
                max-width: none;
            }

            .login-card {
                padding: 25px;
            }
        }

        /* å°å±æ‰‹æœºè®¾å¤‡é€‚é… */
        @media (max-width: 480px) {
            header h1 {
                font-size: 1.5rem;
            }

            .card {
                padding: 12px;
            }

            .card h2 {
                font-size: 1.2rem;
            }

            .task-item {
                padding: 12px;
            }

            .status-badge,
            .channel-badge {
                font-size: 0.75rem;
                padding: 3px 8px;
            }

            .btn-sm {
                padding: 5px 10px;
                font-size: 12px;
            }

            .task-actions {
                flex-direction: column;
                gap: 8px;
            }

            .task-actions .btn {
                width: 100%;
            }
        }

        /* è¶…å®½å±é€‚é… */
        @media (min-width: 1400px) {
            .container {
                max-width: 1600px;
            }

            .main-content {
                gap: 30px;
            }

            .task-list {
                max-height: 700px;
            }
        }

        /* æ¨ªå±æ¨¡å¼é€‚é… */
        @media (max-height: 600px) and (orientation: landscape) {
            .login-container {
                margin: 20px auto;
            }

            .modal-content {
                margin: 2% auto;
                max-height: 90vh;
                overflow-y: auto;
            }

            .task-list {
                max-height: 400px;
            }
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        /* å“åº”å¼äº¤äº’ä¼˜åŒ– */

        /* å¢åŠ å¯ç‚¹å‡»åŒºåŸŸ */
        .btn,
        .login-tab,
        .task-item,
        .channel-item {
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        /* ç§»åŠ¨ç«¯æŒ‰é’®æœ€å°ç‚¹å‡»åŒºåŸŸ */
        @media (max-width: 768px) {
            .btn {
                min-height: 44px; /* iOS æ¨èçš„æœ€å°ç‚¹å‡»åŒºåŸŸ */
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .btn-sm {
                min-height: 36px;
                padding: 8px 12px;
            }

            /* ä¼˜åŒ–å°å±å¹•è§¦æ‘¸ä½“éªŒ */
            .form-group input,
            .form-group textarea,
            .form-group select {
                min-height: 44px;
                padding: 10px 12px;
            }

            /* ä»»åŠ¡æ“ä½œæŒ‰é’®ä¼˜åŒ– */
            .task-actions {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                margin-top: 12px;
            }

            .task-actions .btn {
                flex: 1;
                min-width: 100px;
            }

            /* ç¼–è¾‘æ¨¡æ€æ¡†ç§»åŠ¨ç«¯ä¼˜åŒ– */
            #editTaskModal .modal-content {
                margin: 5% auto;
                padding: 15px;
                max-height: 90vh;
                overflow-y: auto;
            }

            #editTaskModal form {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }

            #editTaskModal .form-group {
                margin-bottom: 0;
            }

            #editTaskModal .modal-content h2 {
                font-size: 1.3rem;
                margin-bottom: 15px;
            }

            /* ç¼–è¾‘è¡¨å•åº•éƒ¨æŒ‰é’®ä¼˜åŒ– */
            #editTaskModal form > div:last-child {
                display: flex;
                flex-direction: column;
                gap: 10px;
                margin-top: 20px;
            }
        }

        /* ç¼–è¾‘æ¨¡æ€æ¡†æ ·å¼ä¼˜åŒ– */
        #editTaskModal .modal-content {
            max-width: 600px;
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s ease;
        }

        #editTaskModal form {
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 10px;
        }

        /* ç¦ç”¨å­—æ®µæ ·å¼ */
        .form-group input:disabled,
        .form-group select:disabled,
        .form-group textarea:disabled {
            background-color: #f8f9fa;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* è­¦å‘Šæç¤ºæ ·å¼ */
        .warning-hint {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 8px 12px;
            margin-top: 5px;
            font-size: 0.85rem;
            color: #856404;
        }

        /* ä¿¡æ¯æç¤ºæ ·å¼ */
        .info-hint {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 4px;
            padding: 8px 12px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            color: #0c5460;
        }

        /* ç¼–è¾‘è¡¨å•æ»šåŠ¨æ¡ä¼˜åŒ– */
        #editTaskModal form::-webkit-scrollbar {
            width: 4px;
        }

        #editTaskModal form::-webkit-scrollbar-track {
            background: transparent;
        }

        #editTaskModal form::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.2);
            border-radius: 2px;
        }

        #editTaskModal form::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.4);
        }

        /* æ»šåŠ¨æ¡ç¾åŒ–ä¼˜åŒ– - é€‚ç”¨äºæ‰€æœ‰è®¾å¤‡ */
        .task-list {
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: rgba(102, 126, 234, 0.3) transparent; /* Firefox */
        }

        .task-list::-webkit-scrollbar {
            width: 6px;
        }

        .task-list::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 3px;
        }

        .task-list::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 3px;
            transition: background 0.3s ease;
        }

        .task-list:hover::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.6);
        }

        .task-list::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.8);
        }

        /* è§¦æ‘¸è®¾å¤‡å®Œå…¨éšè—æ»šåŠ¨æ¡ */
        @media (pointer: coarse) {
            * {
                -webkit-overflow-scrolling: touch;
            }

            .task-list {
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none; /* Firefox */
                -ms-overflow-style: none; /* IE/Edge */
            }

            .task-list::-webkit-scrollbar {
                display: none; /* Chrome/Safari */
            }
        }

        /* é¼ æ ‡è®¾å¤‡æ˜¾ç¤ºæ›´ç²¾è‡´çš„æ»šåŠ¨æ¡ */
        @media (pointer: fine) {
            .task-list {
                scrollbar-width: thin;
                scrollbar-color: rgba(102, 126, 234, 0.2) transparent;
            }

            .task-list::-webkit-scrollbar {
                width: 4px;
            }

            .task-list::-webkit-scrollbar-track {
                background: transparent;
            }

            .task-list::-webkit-scrollbar-thumb {
                background: rgba(102, 126, 234, 0.2);
                border-radius: 2px;
                transition: all 0.2s ease;
            }

            .task-list:hover::-webkit-scrollbar-thumb {
                background: rgba(102, 126, 234, 0.4);
                width: 6px;
            }

            .task-list::-webkit-scrollbar-thumb:hover {
                background: rgba(102, 126, 234, 0.6);
            }
        }

        /* æ‚¬åœæ•ˆæœä¼˜åŒ– - é¿å…è§¦å‘æ»šåŠ¨æ¡ */
        @media (hover: hover) and (pointer: fine) {
            .btn:hover {
                transform: translateY(-2px);
            }

            .task-item {
                transition: all 0.3s ease;
                position: relative;
            }

            .task-item:hover {
                background: #f0f4ff;
                border-left-color: #5568d3;
                box-shadow: 0 3px 15px rgba(102, 126, 234, 0.15);
                /* ç§»é™¤ transform: translateX(5px); é¿å…è§¦å‘æ°´å¹³æ»šåŠ¨æ¡ */
            }

            .channel-item:hover {
                background: #f0f0f0;
            }

            .login-tab:hover {
                background: rgba(102, 126, 234, 0.05);
            }
        }

        /* æ— æ‚¬åœè®¾å¤‡ä½¿ç”¨è§¦æ‘¸åé¦ˆ */
        @media (hover: none) and (pointer: coarse) {
            .btn:active {
                transform: scale(0.98);
            }

            .task-item:active {
                transform: scale(0.98);
            }

            .channel-item:active {
                background: #f0f0f0;
            }

            .login-tab:active {
                background: rgba(102, 126, 234, 0.1);
            }
        }

        /* é«˜DPIå±å¹•ä¼˜åŒ– */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .status-badge,
            .channel-badge {
                border-width: 0.5px;
            }

            .task-item {
                border-left-width: 2px;
            }

            .btn {
                border-width: 0.5px;
            }
        }

        /* æ·±è‰²æ¨¡å¼æ”¯æŒï¼ˆå¯é€‰ï¼‰ */
        @media (prefers-color-scheme: dark) {
            /* è¿™é‡Œå¯ä»¥æ·»åŠ æ·±è‰²æ¨¡å¼æ”¯æŒï¼Œå½“å‰ä¸ºæµ…è‰²æ¨¡å¼ */
        }

        /* å‡å°‘åŠ¨ç”»ï¼ˆæ ¹æ®ç”¨æˆ·åå¥½ï¼‰ */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- ç™»å½•ç•Œé¢ -->
    <div id="loginPage" style="display: none;">
        <div class="login-container">
            <div class="login-card">
                <div class="login-tabs">
                    <div class="login-tab active" onclick="switchTab('login')">ç™»å½•</div>
                    <div class="login-tab" onclick="switchTab('register')">æ³¨å†Œ</div>
                </div>

                <!-- ç™»å½•è¡¨å• -->
                <div id="loginTab" class="tab-content active">
                    <h2 style="text-align: center; margin-bottom: 30px; color: #333;">ç™»å½•é€šçŸ¥ç³»ç»Ÿ</h2>
                    <form id="loginForm">
                        <div class="form-group">
                            <label for="loginUsername">ç”¨æˆ·åæˆ–é‚®ç®±</label>
                            <input type="text" id="loginUsername" name="username" required placeholder="è¯·è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±">
                        </div>
                        <div class="form-group">
                            <label for="loginPassword">å¯†ç </label>
                            <input type="password" id="loginPassword" name="password" required placeholder="è¯·è¾“å…¥å¯†ç ">
                        </div>
                        <button type="submit" class="btn btn-primary">ç™»å½•</button>
                    </form>
                </div>

                <!-- æ³¨å†Œè¡¨å• -->
                <div id="registerTab" class="tab-content">
                    <h2 style="text-align: center; margin-bottom: 30px; color: #333;">æ³¨å†Œæ–°è´¦å·</h2>
                    <form id="registerForm">
                        <div class="form-group">
                            <label for="registerUsername">ç”¨æˆ·å</label>
                            <input type="text" id="registerUsername" name="username" required placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                        </div>
                        <div class="form-group">
                            <label for="registerEmail">é‚®ç®±</label>
                            <input type="email" id="registerEmail" name="email" required placeholder="è¯·è¾“å…¥é‚®ç®±">
                        </div>
                        <div class="form-group">
                            <label for="registerPassword">å¯†ç </label>
                            <input type="password" id="registerPassword" name="password" required placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" minlength="6">
                        </div>
                        <button type="submit" class="btn btn-primary">æ³¨å†Œ</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ç•Œé¢ -->
    <div id="mainApp" style="display: none;">
        <div class="container">
            <header>
                <div class="brand">
                    <div class="brand-logo" aria-hidden="true">
                        <svg viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg" focusable="false" role="presentation">
                            <defs>
                                <linearGradient id="brandLogoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#667eea" />
                                    <stop offset="100%" stop-color="#764ba2" />
                                </linearGradient>
                                <filter id="brandLogoShadow" x="-10%" y="-10%" width="120%" height="120%">
                                    <feDropShadow dx="0" dy="4" stdDeviation="6" flood-color="#4c3e8a" flood-opacity="0.35" />
                                </filter>
                            </defs>
                            <g filter="url(#brandLogoShadow)">
                                <rect x="16" y="16" width="96" height="96" rx="28" fill="url(#brandLogoGradient)" />
                                <path d="M32 52c0-4.418 3.582-8 8-8h48c4.418 0 8 3.582 8 8v24c0 4.418-3.582 8-8 8H40c-4.418 0-8-3.582-8-8V52z" fill="#ffffff" opacity="0.95" />
                                <path d="M36 50l28 22 28-22" fill="none" stroke="#764ba2" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M50 78l14 12 14-12" fill="none" stroke="#764ba2" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M48 38c0-6.627 5.373-12 12-12h8c6.627 0 12 5.373 12 12" fill="none" stroke="#ffffff" stroke-width="4" stroke-linecap="round" />
                                <circle cx="92" cy="40" r="10" fill="#27ae60" stroke="#ffffff" stroke-width="4" />
                                <path d="M88 40l3 3 5-6" fill="none" stroke="#ffffff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
                            </g>
                        </svg>
                    </div>
                    <div class="brand-copy">
                        <h1>ğŸ“¬ é€šçŸ¥å®šæ—¶å‘é€ç³»ç»Ÿ</h1>
                        <p>æ”¯æŒå¤šæ¸ é“å®šæ—¶å‘é€é€šçŸ¥ï¼Œè®©æ‚¨çš„æ¶ˆæ¯å‡†æ—¶åˆ°è¾¾</p>
                    </div>
                </div>
                <div class="user-info">
                    <span>ğŸ‘¤ <span id="currentUsername"></span></span>
                    <button class="logout-btn" onclick="logout()">é€€å‡º</button>
                </div>
            </header>

            <div class="main-content">
                <!-- åˆ›å»ºä»»åŠ¡è¡¨å• -->
                <div class="card">
                    <h2>åˆ›å»ºé€šçŸ¥ä»»åŠ¡</h2>
                    <form id="taskForm">
                        <div class="form-group">
                            <label for="title">é€šçŸ¥æ ‡é¢˜ *</label>
                            <input type="text" id="title" name="title" placeholder="è¯·è¾“å…¥é€šçŸ¥æ ‡é¢˜" required>
                        </div>

                        <div class="form-group">
                            <label for="content">é€šçŸ¥å†…å®¹ *</label>
                            <textarea id="content" name="content" placeholder="è¯·è¾“å…¥é€šçŸ¥å†…å®¹" required></textarea>
                        </div>

                        <div class="form-group">
                            <label for="channel">é€šçŸ¥æ¸ é“ *</label>
                            <select id="channel" name="channel" required>
                                <option value="">è¯·é€‰æ‹©é€šçŸ¥æ¸ é“</option>
                            </select>
                        </div>

                        <div id="configFields" class="config-fields" style="display: none;">
                            <!-- åŠ¨æ€ç”Ÿæˆé…ç½®å­—æ®µ -->
                        </div>

                        <div class="form-group">
                            <label for="scheduledTime">è®¡åˆ’å‘é€æ—¶é—´ *</label>
                            <input type="datetime-local" id="scheduledTime" name="scheduledTime" required>
                        </div>

                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="isRecurring" name="isRecurring">
                                <label for="isRecurring" style="margin-bottom: 0;">é‡å¤ä»»åŠ¡</label>
                            </div>
                        </div>

                        <div class="form-group" id="cronGroup" style="display: none;">
                            <label for="cronExpression">Cron è¡¨è¾¾å¼</label>
                            <input type="text" id="cronExpression" name="cronExpression" placeholder="å¦‚: 0 9 * * * (æ¯å¤©9ç‚¹)">
                            <small style="color: #999; display: block; margin-top: 5px;">
                                ç¤ºä¾‹: 0 9 * * * (æ¯å¤©9ç‚¹) | 0 */2 * * * (æ¯2å°æ—¶) | 0 9 * * 1 (æ¯å‘¨ä¸€9ç‚¹)
                            </small>
                        </div>

                        <button type="submit" class="btn btn-primary">åˆ›å»ºä»»åŠ¡</button>
                    </form>

                    <!-- æ¸ é“ç®¡ç† -->
                    <div class="channel-management">
                        <h3 style="margin-top: 30px; margin-bottom: 15px; color: #333; font-size: 1.2rem;">æˆ‘çš„é€šçŸ¥æ¸ é“</h3>
                        <button class="btn btn-sm btn-info" onclick="openChannelModal()">æ·»åŠ æ¸ é“</button>
                        <div id="userChannels" class="channel-list">
                            <!-- åŠ¨æ€ç”Ÿæˆç”¨æˆ·æ¸ é“åˆ—è¡¨ -->
                        </div>
                    </div>
                </div>

                <!-- ä»»åŠ¡åˆ—è¡¨ -->
                <div class="card">
                    <h2>ä»»åŠ¡åˆ—è¡¨</h2>
                    <div class="filter-bar">
                        <select id="statusFilter">
                            <option value="">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="pending">å¾…å‘é€</option>
                            <option value="sent">å·²å‘é€</option>
                            <option value="failed">å‘é€å¤±è´¥</option>
                            <option value="cancelled">å·²å–æ¶ˆ</option>
                        </select>
                        <button class="btn btn-info btn-sm" onclick="loadTasks()">åˆ·æ–°</button>
                    </div>
                    <div id="taskList" class="task-list">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>åŠ è½½ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¸ é“é…ç½®æ¨¡æ€æ¡† -->
    <div id="channelModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeChannelModal()">&times;</span>
            <h2>æ·»åŠ é€šçŸ¥æ¸ é“</h2>
            <form id="channelForm">
                <input type="hidden" id="editingChannelId" value="">
                <div class="form-group">
                    <label for="channelName">æ¸ é“åç§° *</label>
                    <input type="text" id="channelName" name="channelName" required placeholder="å¦‚ï¼šä¼ä¸šå¾®ä¿¡é€šçŸ¥">
                </div>

                <div class="form-group">
                    <label for="channelType">æ¸ é“ç±»å‹ *</label>
                    <select id="channelType" name="channelType" required>
                        <option value="">è¯·é€‰æ‹©æ¸ é“ç±»å‹</option>
                    </select>
                </div>

                <div id="channelConfigFields" class="config-fields">
                    <!-- åŠ¨æ€ç”Ÿæˆé…ç½®å­—æ®µ -->
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="isDefaultChannel" name="isDefault">
                        <label for="isDefaultChannel" style="margin-bottom: 0;">è®¾ä¸ºé»˜è®¤æ¸ é“</label>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">æ·»åŠ æ¸ é“</button>
            </form>
        </div>
    </div>

    <!-- ä»»åŠ¡ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="editTaskModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditTaskModal()">&times;</span>
            <h2>ç¼–è¾‘ä»»åŠ¡</h2>
            <form id="editTaskForm">
                <input type="hidden" id="editTaskId" name="taskId">

                <div class="form-group">
                    <label for="editTitle">é€šçŸ¥æ ‡é¢˜ *</label>
                    <input type="text" id="editTitle" name="title" placeholder="è¯·è¾“å…¥é€šçŸ¥æ ‡é¢˜" required>
                </div>

                <div class="form-group">
                    <label for="editContent">é€šçŸ¥å†…å®¹ *</label>
                    <textarea id="editContent" name="content" placeholder="è¯·è¾“å…¥é€šçŸ¥å†…å®¹" required></textarea>
                </div>

                <div class="form-group">
                    <label>é€šçŸ¥æ¸ é“</label>
                    <select id="editChannel" disabled>
                        <option value="">æ¸ é“å·²ç¡®å®šï¼Œä¸å¯æ›´æ”¹</option>
                    </select>
                    <div class="warning-hint">
                        âš ï¸ å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œç¼–è¾‘ä»»åŠ¡æ—¶ä¸èƒ½æ›´æ”¹é€šçŸ¥æ¸ é“
                    </div>
                </div>

                <div id="editConfigFields" class="config-fields" style="display: none;">
                    <!-- åŠ¨æ€ç”Ÿæˆé…ç½®å­—æ®µ -->
                </div>

                <div class="form-group">
                    <label for="editScheduledTime">è®¡åˆ’å‘é€æ—¶é—´ *</label>
                    <input type="datetime-local" id="editScheduledTime" name="scheduledTime" required>
                </div>

                <div class="form-group">
                    <label>é‡å¤ä»»åŠ¡è®¾ç½®</label>
                    <div class="checkbox-group">
                        <input type="checkbox" id="editIsRecurring" name="isRecurring" disabled>
                        <label for="editIsRecurring" style="margin-bottom: 0;">é‡å¤ä»»åŠ¡ï¼ˆä¸å¯ä¿®æ”¹ï¼‰</label>
                    </div>
                    <div class="warning-hint">
                        âš ï¸ é‡å¤ä»»åŠ¡è®¾ç½®ä¸å¯æ›´æ”¹ï¼Œå¦‚éœ€ä¿®æ”¹è¯·åˆ›å»ºæ–°ä»»åŠ¡
                    </div>
                </div>

                <div id="editCronGroup" class="form-group" style="display: none;">
                    <label for="editCronExpression">Cron è¡¨è¾¾å¼</label>
                    <input type="text" id="editCronExpression" name="cronExpression" readonly style="background: #f5f5f5;">
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">ä¿å­˜ä¿®æ”¹</button>
                    <button type="button" class="btn btn-danger" onclick="closeEditTaskModal()" style="flex: 1;">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let channels = [];
        let currentUser = null;
        let userChannels = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
        });

        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        async function checkAuthStatus() {
            const token = localStorage.getItem('token');
            if (!token) {
                showLoginPage();
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    showMainApp();
                } else {
                    localStorage.removeItem('token');
                    showLoginPage();
                }
            } catch (error) {
                localStorage.removeItem('token');
                showLoginPage();
            }
        }

        // æ˜¾ç¤ºç™»å½•é¡µé¢
        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            initLoginEvents();
        }

        // æ˜¾ç¤ºä¸»åº”ç”¨
        function showMainApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('currentUsername').textContent = currentUser.username;
            loadChannels();
            loadUserChannels();
            loadTasks();
            initAppEvents();
            setDefaultTime();
        }

        // åˆ‡æ¢ç™»å½•/æ³¨å†Œæ ‡ç­¾
        function switchTab(tab) {
            const tabs = document.querySelectorAll('.login-tab');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));

            if (tab === 'login') {
                tabs[0].classList.add('active');
                document.getElementById('loginTab').classList.add('active');
            } else {
                tabs[1].classList.add('active');
                document.getElementById('registerTab').classList.add('active');
            }
        }

        // åˆå§‹åŒ–ç™»å½•äº‹ä»¶
        function initLoginEvents() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
        }

        // å¤„ç†ç™»å½•
        async function handleLogin(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const loginData = {
                username: formData.get('username'),
                password: formData.get('password')
            };

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(loginData)
                });

                const result = await response.json();

                if (response.ok) {
                    localStorage.setItem('token', result.data.token);
                    currentUser = result.data.user;
                    showMainApp();
                    showNotification('ç™»å½•æˆåŠŸï¼', 'success');
                } else {
                    showNotification(result.error, 'error');
                }
            } catch (error) {
                showNotification('ç™»å½•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¤„ç†æ³¨å†Œ
        async function handleRegister(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const registerData = {
                username: formData.get('username'),
                email: formData.get('email'),
                password: formData.get('password')
            };

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(registerData)
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•', 'success');
                    switchTab('login');
                    e.target.reset();
                } else {
                    showNotification(result.error, 'error');
                }
            } catch (error) {
                showNotification('æ³¨å†Œå¤±è´¥: ' + error.message, 'error');
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('token');
            currentUser = null;
            checkAuthStatus();
        }

        // åˆå§‹åŒ–åº”ç”¨äº‹ä»¶
        function initAppEvents() {
            document.getElementById('taskForm').addEventListener('submit', submitTaskForm);
            document.getElementById('channel').addEventListener('change', onChannelChange);
            document.getElementById('statusFilter').addEventListener('change', loadTasks);
            document.getElementById('isRecurring').addEventListener('change', function() {
                document.getElementById('cronGroup').style.display = this.checked ? 'block' : 'none';
            });
            // æ¸ é“è¡¨å•æäº¤ä¸ç±»å‹å˜æ›´ç›‘å¬ï¼ˆç»‘å®šä¸€æ¬¡ï¼‰
            const channelForm = document.getElementById('channelForm');
            if (channelForm && !channelForm._bound) {
                channelForm.addEventListener('submit', handleChannelFormSubmit);
                channelForm._bound = true;
            }
            const channelTypeSel = document.getElementById('channelType');
            if (channelTypeSel && !channelTypeSel._bound) {
                channelTypeSel.addEventListener('change', onChannelTypeChange);
                channelTypeSel._bound = true;
            }
        }

        // åŠ è½½é€šçŸ¥æ¸ é“ç±»å‹
        async function loadChannels() {
            try {
                const response = await fetch(`${API_BASE}/channels`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const data = await response.json();
                channels = data.channels;

                // å¡«å……ä»»åŠ¡è¡¨å•ä¸­çš„æ¸ é“é€‰æ‹©
                const taskChannelSelect = document.getElementById('channel');
                channels.forEach(channel => {
                    const option = document.createElement('option');
                    option.value = channel.value;
                    option.textContent = channel.label;
                    option.dataset.fields = JSON.stringify(channel.config_fields);
                    taskChannelSelect.appendChild(option);
                });

                // å¡«å……æ¸ é“æ¨¡æ€æ¡†ä¸­çš„æ¸ é“ç±»å‹é€‰æ‹©
                const modalChannelSelect = document.getElementById('channelType');
                channels.forEach(channel => {
                    const option = document.createElement('option');
                    option.value = channel.value;
                    option.textContent = channel.label;
                    option.dataset.fields = JSON.stringify(channel.config_fields);
                    modalChannelSelect.appendChild(option);
                });
            } catch (error) {
                showNotification('åŠ è½½æ¸ é“å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½ç”¨æˆ·ä¸“å±æ¸ é“
        async function loadUserChannels() {
            try {
                const response = await fetch(`${API_BASE}/user/channels`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const data = await response.json();
                userChannels = data.channels;

                renderUserChannels();
            } catch (error) {
                showNotification('åŠ è½½ç”¨æˆ·æ¸ é“å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ¸²æŸ“ç”¨æˆ·æ¸ é“åˆ—è¡¨
        function renderUserChannels() {
            const container = document.getElementById('userChannels');
            if (userChannels.length === 0) {
                container.innerHTML = '<div class="empty-state"><i>ğŸ“­</i><p>æš‚æ— æ¸ é“é…ç½®</p></div>';
                return;
            }

            container.innerHTML = '';
            userChannels.forEach(channel => {
                const channelItem = document.createElement('div');
                channelItem.className = 'channel-item';

                const channelTypeLabel = channels.find(c => c.value === channel.channel_type)?.label || channel.channel_type;

                channelItem.innerHTML = `
                    <div class="channel-info">
                        <div class="channel-name">${channel.channel_name} ${channel.is_default ? '(é»˜è®¤)' : ''}</div>
                        <div class="channel-type">${channelTypeLabel}</div>
                    </div>
                    <div class="channel-actions">
                        <button class="btn btn-sm btn-info" onclick="editUserChannel(${channel.id})">ç¼–è¾‘</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUserChannel(${channel.id})">åˆ é™¤</button>
                    </div>
                `;
                container.appendChild(channelItem);
            });
        }

        // æ‰“å¼€æ¸ é“é…ç½®æ¨¡æ€æ¡†
        function openChannelModal() {
            // ä»¥åˆ›å»ºæ¨¡å¼æ‰“å¼€æ¨¡æ€æ¡†
            document.getElementById('editingChannelId').value = '';
            document.getElementById('channelModal').style.display = 'block';
            document.getElementById('channelForm').reset();
            document.getElementById('channelConfigFields').innerHTML = '';
            document.getElementById('channelType').disabled = false;
            // è®¾ç½®æ ‡é¢˜ä¸ºâ€œæ·»åŠ é€šçŸ¥æ¸ é“â€
            const title = document.querySelector('#channelModal .modal-content h2');
            if (title) title.textContent = 'æ·»åŠ é€šçŸ¥æ¸ é“';
        }

        // å…³é—­æ¸ é“é…ç½®æ¨¡æ€æ¡†
        function closeChannelModal() {
            document.getElementById('channelModal').style.display = 'none';
            document.getElementById('channelForm').reset();
            document.getElementById('channelConfigFields').innerHTML = '';
            document.getElementById('editingChannelId').value = '';
            document.getElementById('channelType').disabled = false;
        }

        // æ¸ é“ç±»å‹æ”¹å˜æ—¶æ›´æ–°é…ç½®å­—æ®µ
        function onChannelTypeChange() {
            const channelSelect = document.getElementById('channelType');
            const selectedOption = channelSelect.options[channelSelect.selectedIndex];
            const configFieldsDiv = document.getElementById('channelConfigFields');

            if (!selectedOption.value) {
                configFieldsDiv.innerHTML = '';
                return;
            }

            const fields = JSON.parse(selectedOption.dataset.fields || '[]');
            configFieldsDiv.innerHTML = '';

            fields.forEach(field => {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';

                const label = document.createElement('label');
                label.textContent = getFieldLabel(field);
                formGroup.appendChild(label);

                const input = document.createElement('input');
                input.type = field.includes('token') || field.includes('secret') ? 'password' : 'text';
                input.id = `channelConfig_${field}`;
                input.name = field;
                input.placeholder = `è¯·è¾“å…¥${getFieldLabel(field)}`;
                input.required = true;
                formGroup.appendChild(input);

                configFieldsDiv.appendChild(formGroup);
            });
        }

        // å¤„ç†æ¸ é“è¡¨å•ï¼ˆåˆ›å»ºæˆ–ç¼–è¾‘ï¼‰
        async function handleChannelFormSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const editingId = document.getElementById('editingChannelId').value;
            const channelSelect = document.getElementById('channelType');
            const selectedOption = channelSelect.options[channelSelect.selectedIndex];
            const configFields = JSON.parse(selectedOption?.dataset?.fields || '[]');

            // æ„å»ºé…ç½®å¯¹è±¡
            const channelConfig = {};
            configFields.forEach(field => {
                const el = document.getElementById(`channelConfig_${field}`) || document.getElementById(`editConfig_${field}`) || document.getElementById(`config_${field}`);
                const value = el ? el.value : '';
                channelConfig[field] = value;
            });

            const commonData = {
                channel_name: formData.get('channelName'),
                channel_config: channelConfig,
                is_default: formData.get('isDefault') === 'on'
            };

            try {
                let response;
                if (!editingId) {
                    // åˆ›å»º
                    const postData = Object.assign({}, commonData, { channel_type: formData.get('channelType') });
                    response = await fetch(`${API_BASE}/user/channels`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify(postData)
                    });
                } else {
                    // ç¼–è¾‘ï¼ˆåªå…è®¸ä¿®æ”¹åç§°ã€é…ç½®ã€æ˜¯å¦é»˜è®¤ï¼‰
                    response = await fetch(`${API_BASE}/user/channels/${editingId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify(commonData)
                    });
                }

                const result = await response.json();

                if (response.ok) {
                    showNotification(editingId ? 'æ¸ é“æ›´æ–°æˆåŠŸï¼' : 'æ¸ é“åˆ›å»ºæˆåŠŸï¼', 'success');
                    closeChannelModal();
                    loadUserChannels();
                } else {
                    showNotification(result.error || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                showNotification('æ“ä½œå¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ é™¤ç”¨æˆ·æ¸ é“
        async function deleteUserChannel(channelId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¸ é“é…ç½®å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/user/channels/${channelId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification('æ¸ é“åˆ é™¤æˆåŠŸ', 'success');
                    loadUserChannels();
                } else {
                    showNotification(result.error, 'error');
                }
            } catch (error) {
                showNotification('åˆ é™¤æ¸ é“å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ç¼–è¾‘ç”¨æˆ·æ¸ é“ï¼ˆæ‰“å¼€æ¨¡æ€æ¡†å¹¶å¡«å……æ•°æ®ï¼‰
        function editUserChannel(channelId) {
            const channel = userChannels.find(uc => uc.id == channelId);
            if (!channel) {
                showNotification('æ¸ é“ä¸å­˜åœ¨', 'error');
                return;
            }

            document.getElementById('editingChannelId').value = channel.id;
            document.getElementById('channelModal').style.display = 'block';
            // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜
            const title = document.querySelector('#channelModal .modal-content h2');
            if (title) title.textContent = 'ç¼–è¾‘é€šçŸ¥æ¸ é“';

            // å¡«å……åŸºæœ¬ä¿¡æ¯
            document.getElementById('channelName').value = channel.channel_name || '';
            const channelTypeSel = document.getElementById('channelType');
            channelTypeSel.value = channel.channel_type;
            channelTypeSel.disabled = true; // ä¸å…è®¸ä¿®æ”¹æ¸ é“ç±»å‹

            // è§¦å‘ç”Ÿæˆé…ç½®å­—æ®µ
            onChannelTypeChange();

            // å¡«å……é…ç½®å­—æ®µ
            const selectedOption = channelTypeSel.options[channelTypeSel.selectedIndex];
            const fields = JSON.parse(selectedOption.dataset.fields || '[]');
            const cfg = channel.channel_config || {};
            fields.forEach(field => {
                const input = document.getElementById(`channelConfig_${field}`);
                if (input) input.value = cfg[field] || '';
            });

            // å¡«å……é»˜è®¤æ¸ é“é€‰é¡¹
            document.getElementById('isDefaultChannel').checked = !!channel.is_default;
        }

        // æ¸ é“æ”¹å˜æ—¶æ›´æ–°é…ç½®å­—æ®µ
        function onChannelChange() {
            const channelSelect = document.getElementById('channel');
            const selectedOption = channelSelect.options[channelSelect.selectedIndex];
            const configFieldsDiv = document.getElementById('configFields');

            if (!selectedOption.value) {
                configFieldsDiv.style.display = 'none';
                return;
            }

            const fields = JSON.parse(selectedOption.dataset.fields || '[]');
            configFieldsDiv.innerHTML = '';

            // å…ˆæ˜¾ç¤ºç”¨æˆ·å·²ä¿å­˜çš„æ¸ é“é€‰é¡¹
            const userChannelSelect = document.createElement('select');
            userChannelSelect.id = 'userChannelSelect';
            userChannelSelect.className = 'user-channel-select';

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'é€‰æ‹©å·²ä¿å­˜çš„æ¸ é“ï¼ˆå¯é€‰ï¼‰';
            userChannelSelect.appendChild(defaultOption);

            userChannels.forEach(userChannel => {
                if (userChannel.channel_type === selectedOption.value) {
                    const option = document.createElement('option');
                    option.value = userChannel.id;
                    option.textContent = `${userChannel.channel_name} ${userChannel.is_default ? '(é»˜è®¤)' : ''}`;
                    userChannelSelect.appendChild(option);
                }
            });

            if (userChannels.some(uc => uc.channel_type === selectedOption.value)) {
                configFieldsDiv.appendChild(userChannelSelect);
            }

            fields.forEach(field => {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';

                const label = document.createElement('label');
                label.textContent = getFieldLabel(field);
                formGroup.appendChild(label);

                const input = document.createElement('input');
                input.type = field.includes('token') || field.includes('secret') ? 'password' : 'text';
                input.id = `config_${field}`;
                input.name = field;
                input.placeholder = `è¯·è¾“å…¥${getFieldLabel(field)}`;
                formGroup.appendChild(input);

                configFieldsDiv.appendChild(formGroup);
            });

            configFieldsDiv.style.display = 'block';

            // ç›‘å¬ç”¨æˆ·æ¸ é“é€‰æ‹©
            userChannelSelect.addEventListener('change', function() {
                const selectedChannelId = this.value;
                if (selectedChannelId) {
                    const selectedChannel = userChannels.find(uc => uc.id == selectedChannelId);
                    if (selectedChannel) {
                        const config = selectedChannel.channel_config;
                        fields.forEach(field => {
                            const input = document.getElementById(`config_${field}`);
                            if (input && config[field]) {
                                input.value = config[field];
                            }
                        });
                    }
                }
            });
        }

        // è·å–å­—æ®µä¸­æ–‡æ ‡ç­¾
        function getFieldLabel(field) {
            const labels = {
                'corpid': 'ä¼ä¸šID',
                'corpsecret': 'åº”ç”¨Secret',
                'agentid': 'åº”ç”¨ID',
                'webhook_url': 'Webhook URL',
                'appid': 'åº”ç”¨ID',
                'appsecret': 'åº”ç”¨Secret',
                'receiver_type': 'æ¥æ”¶è€…ç±»å‹',
                'receiver_id': 'æ¥æ”¶è€…ID',
                'token': 'Token'
            };
            return labels[field] || field;
        }

        // åŠ è½½ä»»åŠ¡åˆ—è¡¨
        async function loadTasks() {
            const taskList = document.getElementById('taskList');
            const statusFilter = document.getElementById('statusFilter').value;

            taskList.innerHTML = '<div class="loading"><div class="spinner"></div><p>åŠ è½½ä¸­...</p></div>';

            try {
                const url = statusFilter
                    ? `${API_BASE}/tasks?status=${statusFilter}&page_size=100`
                    : `${API_BASE}/tasks?page_size=100`;

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const data = await response.json();

                if (data.tasks && data.tasks.length > 0) {
                    taskList.innerHTML = '';
                    data.tasks.forEach(task => {
                        taskList.appendChild(createTaskElement(task));
                    });
                } else {
                    taskList.innerHTML = '<div class="empty-state"><i>ğŸ“­</i><p>æš‚æ— ä»»åŠ¡</p></div>';
                }
            } catch (error) {
                taskList.innerHTML = '<div class="empty-state"><i>âŒ</i><p>åŠ è½½å¤±è´¥: ' + error.message + '</p></div>';
            }
        }

        // åˆ›å»ºä»»åŠ¡å…ƒç´ 
        function createTaskElement(task) {
            const div = document.createElement('div');
            div.className = 'task-item';

            const statusClass = `status-${task.status}`;
            const statusText = {
                'pending': 'å¾…å‘é€',
                'sent': 'å·²å‘é€',
                'failed': 'å‘é€å¤±è´¥',
                'cancelled': 'å·²å–æ¶ˆ'
            }[task.status] || task.status;

            const channelText = channels.find(c => c.value === task.channel)?.label || task.channel;

            div.innerHTML = `
                <div class="task-header">
                    <div>
                        <div class="task-title">${escapeHtml(task.title)}</div>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                        <span class="channel-badge">${channelText}</span>
                    </div>
                </div>
                <div class="task-content">${escapeHtml(task.content)}</div>
                <div class="task-meta">
                    <span>ğŸ“… è®¡åˆ’æ—¶é—´: ${formatDateTime(task.scheduled_time)}</span>
                    ${task.sent_time ? `<span>âœ… å‘é€æ—¶é—´: ${formatDateTime(task.sent_time)}</span>` : ''}
                    ${task.is_recurring ? `<span>ğŸ” é‡å¤ä»»åŠ¡: ${task.cron_expression}</span>` : ''}
                    <span>ğŸ†” ID: ${task.id}</span>
                </div>
                ${task.error_msg ? `<div style="color: #e74c3c; margin-top: 10px;">âŒ é”™è¯¯: ${escapeHtml(task.error_msg)}</div>` : ''}
                ${task.status === 'pending' ? `
                <div class="task-actions">
                    <button class="btn btn-sm btn-info" onclick="editTask(${task.id})">ç¼–è¾‘</button>
                    <button class="btn btn-sm btn-danger" onclick="cancelTask(${task.id})">å–æ¶ˆä»»åŠ¡</button>
                </div>
                ` : ''}
            `;

            return div;
        }

        // æäº¤ä»»åŠ¡è¡¨å•
        async function submitTaskForm(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const channel = formData.get('channel');
            const channelSelect = document.getElementById('channel');
            const selectedOption = channelSelect.options[channelSelect.selectedIndex];
            const configFields = JSON.parse(selectedOption.dataset.fields || '[]');

            // æ„å»ºé…ç½®å¯¹è±¡
            const channelConfig = {};
            configFields.forEach(field => {
                const value = document.getElementById(`config_${field}`).value;
                channelConfig[field] = value;
            });

            // æ„å»ºä»»åŠ¡æ•°æ®
            const scheduledTimeValue = formData.get('scheduledTime');
            const taskData = {
                title: formData.get('title'),
                content: formData.get('content'),
                channel: channel,
                scheduled_time: scheduledTimeValue ? `${scheduledTimeValue}:00` : null,
                channel_config: channelConfig,
                is_recurring: formData.get('isRecurring') === 'on',
                cron_expression: formData.get('isRecurring') === 'on' ? formData.get('cronExpression') : null
            };

            try {
                const response = await fetch(`${API_BASE}/tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(taskData)
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification('ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼', 'success');
                    e.target.reset();
                    setDefaultTime();
                    document.getElementById('configFields').style.display = 'none';
                    document.getElementById('cronGroup').style.display = 'none';
                    loadTasks();
                } else {
                    showNotification('åˆ›å»ºå¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                showNotification('åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // å–æ¶ˆä»»åŠ¡
        async function cancelTask(taskId) {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/tasks/${taskId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification('ä»»åŠ¡å·²å–æ¶ˆ', 'success');
                    loadTasks();
                } else {
                    showNotification('å–æ¶ˆå¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                showNotification('å–æ¶ˆå¤±è´¥: ' + error.message, 'error');
            }
        }

        // è®¾ç½®é»˜è®¤æ—¶é—´ä¸ºå½“å‰æ—¶é—´+1å°æ—¶ï¼ˆä¸œå…«åŒºæœ¬åœ°æ—¶é—´ï¼‰
        function setDefaultTime() {
            const now = new Date();
            now.setHours(now.getHours() + 1);
            document.getElementById('scheduledTime').value = toLocalInputValue(now);
        }

        // å°† Date è½¬ä¸º datetime-local å¯ç”¨çš„æœ¬åœ°æ—¶é—´å­—ç¬¦ä¸²
        function toLocalInputValue(date) {
            const local = new Date(date.getTime() - date.getTimezoneOffset() * 60000);
            return local.toISOString().slice(0, 16);
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // è‡ªåŠ¨åˆ·æ–°ä»»åŠ¡åˆ—è¡¨ï¼ˆæ¯30ç§’ï¼‰
        setInterval(loadTasks, 30000);

        // å“åº”å¼å¢å¼ºåŠŸèƒ½
        function initResponsiveFeatures() {
            // æ·»åŠ è§¦æ‘¸åé¦ˆ
            document.addEventListener('touchstart', function(e) {
                if (e.target.classList.contains('btn') ||
                    e.target.classList.contains('task-item') ||
                    e.target.closest('.btn') ||
                    e.target.closest('.task-item')) {
                    const element = e.target.classList.contains('btn') ? e.target :
                                  e.target.closest('.btn') || e.target.closest('.task-item');
                    element.style.transform = 'scale(0.98)';
                    element.style.transition = 'transform 0.1s ease';
                }
            });

            document.addEventListener('touchend', function(e) {
                if (e.target.classList.contains('btn') ||
                    e.target.classList.contains('task-item') ||
                    e.target.closest('.btn') ||
                    e.target.closest('.task-item')) {
                    const element = e.target.classList.contains('btn') ? e.target :
                                  e.target.closest('.btn') || e.target.closest('.task-item');
                    setTimeout(() => {
                        element.style.transform = 'scale(1)';
                    }, 100);
                }
            });

            // ä¼˜åŒ–ç§»åŠ¨ç«¯æ»šåŠ¨ä½“éªŒ
            if ('ontouchstart' in window) {
                document.body.style.webkitOverflowScrolling = 'touch';

                // ä¸ºç§»åŠ¨ç«¯ä¼˜åŒ–è¾“å…¥æ¡†ç„¦ç‚¹
                const inputs = document.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    input.addEventListener('focus', function() {
                        // å»¶è¿Ÿæ»šåŠ¨ä»¥ç¡®ä¿è¾“å…¥æ¡†å¯è§
                        setTimeout(() => {
                            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 300);
                    });
                });
            }

            // æ™ºèƒ½å¸ƒå±€è°ƒæ•´
            adjustLayoutForScreenSize();
            window.addEventListener('resize', debounce(adjustLayoutForScreenSize, 250));
            window.addEventListener('orientationchange', debounce(adjustLayoutForScreenSize, 500));
        }

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // æ ¹æ®å±å¹•å°ºå¯¸è°ƒæ•´å¸ƒå±€
        function adjustLayoutForScreenSize() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            const isMobile = width <= 768;
            const isSmallMobile = width <= 480;

            // è°ƒæ•´ä»»åŠ¡åˆ—è¡¨é«˜åº¦
            const taskList = document.getElementById('taskList');
            if (taskList && taskList.style.display !== 'none') {
                if (isMobile) {
                    const viewportHeight = window.innerHeight;
                    const headerHeight = document.querySelector('header')?.offsetHeight || 200;
                    const formHeight = document.querySelector('.card')?.offsetHeight || 400;
                    const maxListHeight = Math.max(300, viewportHeight - headerHeight - formHeight - 150);
                    taskList.style.maxHeight = `${maxListHeight}px`;
                } else if (width >= 1400) {
                    taskList.style.maxHeight = '700px';
                } else {
                    taskList.style.maxHeight = '600px';
                }
            }

            // ç§»åŠ¨ç«¯ä¼˜åŒ–
            if (isMobile) {
                // ç¡®ä¿æ¨¡æ€æ¡†åœ¨ç§»åŠ¨ç«¯æ­£å¸¸æ˜¾ç¤º
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (modal.style.display === 'block') {
                        const modalContent = modal.querySelector('.modal-content');
                        if (modalContent) {
                            modalContent.style.maxHeight = '80vh';
                            modalContent.style.overflowY = 'auto';
                        }
                    }
                });

                // ä¼˜åŒ–é€šçŸ¥æ˜¾ç¤º
                const notifications = document.querySelectorAll('.notification');
                notifications.forEach(notification => {
                    notification.style.fontSize = isSmallMobile ? '14px' : '16px';
                    notification.style.padding = isSmallMobile ? '12px 20px' : '15px 25px';
                });
            }
        }

        // ä¼˜åŒ–ç§»åŠ¨ç«¯è¡¨å•ä½“éªŒ
        function optimizeMobileForms() {
            // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            if (isMobile) {
                // ä¸ºç§»åŠ¨è®¾å¤‡ä¼˜åŒ–è¾“å…¥ç±»å‹
                const emailInputs = document.querySelectorAll('input[type="email"]');
                emailInputs.forEach(input => {
                    input.setAttribute('autocomplete', 'email');
                });

                const passwordInputs = document.querySelectorAll('input[type="password"]');
                passwordInputs.forEach(input => {
                    input.setAttribute('autocomplete', 'current-password');
                });

                // ä¼˜åŒ–æ•°å­—è¾“å…¥
                const numberInputs = document.querySelectorAll('input[type="number"], input[type="tel"]');
                numberInputs.forEach(input => {
                    input.setAttribute('inputmode', 'numeric');
                    input.setAttribute('pattern', '[0-9]*');
                });
            }
        }

        // æ·»åŠ ä¸‹æ‹‰åˆ·æ–°åŠŸèƒ½ï¼ˆä»…ç§»åŠ¨ç«¯ï¼‰
        function initPullToRefresh() {
            let startY = 0;
            let isPulling = false;
            const pullThreshold = 80;

            const taskList = document.getElementById('taskList');
            if (!taskList) return;

            taskList.addEventListener('touchstart', function(e) {
                if (taskList.scrollTop === 0) {
                    startY = e.touches[0].clientY;
                    isPulling = true;
                }
            });

            taskList.addEventListener('touchmove', function(e) {
                if (!isPulling) return;

                const currentY = e.touches[0].clientY;
                const diff = currentY - startY;

                if (diff > 0 && diff < pullThreshold) {
                    taskList.style.transform = `translateY(${diff * 0.5}px)`;
                    taskList.style.transition = 'none';
                }
            });

            taskList.addEventListener('touchend', function(e) {
                if (!isPulling) return;

                isPulling = false;
                taskList.style.transform = '';
                taskList.style.transition = 'transform 0.3s ease';

                const currentY = e.changedTouches[0].clientY;
                const diff = currentY - startY;

                if (diff > pullThreshold) {
                    loadTasks();
                    showNotification('æ­£åœ¨åˆ·æ–°...', 'success');
                }
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–å“åº”å¼åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            // åœ¨åŸæœ‰çš„ checkAuthStatus() è°ƒç”¨åæ·»åŠ 
            setTimeout(() => {
                initResponsiveFeatures();
                optimizeMobileForms();

                // å¦‚æœæ˜¯ç§»åŠ¨è®¾å¤‡ä¸”æ”¯æŒè§¦æ‘¸ï¼Œå¯ç”¨ä¸‹æ‹‰åˆ·æ–°
                if ('ontouchstart' in window && window.innerWidth <= 768) {
                    initPullToRefresh();
                }
            }, 1000);
        });

        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œä¼˜åŒ–æ€§èƒ½
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // é¡µé¢éšè—æ—¶é™ä½åˆ·æ–°é¢‘ç‡
                clearInterval(window.taskRefreshInterval);
            } else {
                // é¡µé¢æ˜¾ç¤ºæ—¶æ¢å¤æ­£å¸¸åˆ·æ–°é¢‘ç‡
                window.taskRefreshInterval = setInterval(loadTasks, 30000);
                loadTasks(); // ç«‹å³åˆ·æ–°æ•°æ®
            }
        });

        // å­˜å‚¨åˆ·æ–°é—´éš”IDï¼Œä¾¿äºç®¡ç†
        window.taskRefreshInterval = setInterval(loadTasks, 30000);

        // ä»»åŠ¡ç¼–è¾‘ç›¸å…³å‡½æ•°

        // ç¼–è¾‘ä»»åŠ¡
        async function editTask(taskId) {
            try {
                // å…ˆè·å–ä»»åŠ¡è¯¦ç»†ä¿¡æ¯
                const response = await fetch(`${API_BASE}/tasks/${taskId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    showNotification('è·å–ä»»åŠ¡å¤±è´¥: ' + error.error, 'error');
                    return;
                }

                const task = await response.json();

                // è°ƒè¯•è¾“å‡º
                console.log('Task received from API:', {
                    id: task.id,
                    title: task.title,
                    channel: task.channel,
                    channel_config: task.channel_config,
                    channel_config_type: typeof task.channel_config
                });

                // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
                showEditTaskModal(task);

            } catch (error) {
                showNotification('è·å–ä»»åŠ¡å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºç¼–è¾‘ä»»åŠ¡æ¨¡æ€æ¡†
        function showEditTaskModal(task) {
            // æ·»åŠ åŠ è½½åŠ¨ç”»
            const modal = document.getElementById('editTaskModal');
            const modalContent = modal.querySelector('.modal-content');

            // é‡ç½®è¡¨å•
            document.getElementById('editTaskForm').reset();

            // å¡«å……è¡¨å•æ•°æ®
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editTitle').value = task.title;
            document.getElementById('editContent').value = task.content;

            // è®¾ç½®æ¸ é“ä¿¡æ¯
            const channelSelect = document.getElementById('editChannel');
            const channelOption = channels.find(c => c.value === task.channel);
            if (channelOption) {
                channelSelect.innerHTML = `<option value="${task.channel}" selected>${channelOption.label}</option>`;
            }

            // è®¾ç½®æ—¶é—´
            const scheduledTime = new Date(task.scheduled_time);
            // è½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´å¹¶æ ¼å¼åŒ–
            const localTime = new Date(scheduledTime.getTime() - scheduledTime.getTimezoneOffset() * 60000);
            document.getElementById('editScheduledTime').value = localTime.toISOString().slice(0, 16);

            // è®¾ç½®é‡å¤ä»»åŠ¡ä¿¡æ¯
            const isRecurringCheckbox = document.getElementById('editIsRecurring');
            isRecurringCheckbox.checked = task.is_recurring;

            if (task.is_recurring) {
                document.getElementById('editCronGroup').style.display = 'block';
                document.getElementById('editCronExpression').value = task.cron_expression;
            }

            // å¡«å……æ¸ é“é…ç½®å­—æ®µ
            fillEditConfigFields(task.channel, task.channel_config);

            // æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼ˆå¸¦åŠ¨ç”»æ•ˆæœï¼‰
            modal.style.display = 'block';
            setTimeout(() => {
                modalContent.style.transform = 'scale(1)';
                modalContent.style.opacity = '1';
            }, 10);

            // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
            document.getElementById('editTaskForm').addEventListener('submit', handleEditTaskSubmit);

            // èšç„¦åˆ°ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†
            setTimeout(() => {
                document.getElementById('editTitle').focus();
            }, 300);
        }

        // å¡«å……ç¼–è¾‘è¡¨å•çš„é…ç½®å­—æ®µ
        function fillEditConfigFields(channelType, channelConfig) {
            const channel = channels.find(c => c.value === channelType);
            if (!channel) return;

            // channel.config_fields å¯èƒ½æ˜¯æ•°ç»„ï¼ˆæ¥è‡ª API çš„åŸç”Ÿ JSONï¼‰æˆ–å­—ç¬¦ä¸²ï¼ˆå·²åºåˆ—åŒ–çš„ JSONï¼‰ï¼Œ
            // å…¼å®¹ä¸¤ç§æƒ…å†µä»¥é¿å… JSON.parse åœ¨æ¥æ”¶åˆ°æ•°ç»„æ—¶æŠ›å‡ºé”™è¯¯ï¼ˆæ•°ç»„ä¼šè¢« toString æˆé JSON å­—ç¬¦ä¸²ï¼‰ã€‚
            let configFields = [];
            try {
                if (typeof channel.config_fields === 'string') {
                    configFields = JSON.parse(channel.config_fields || '[]');
                } else if (Array.isArray(channel.config_fields)) {
                    configFields = channel.config_fields;
                } else {
                    configFields = [];
                }
            } catch (err) {
                console.error('è§£æ channel.config_fields å‡ºé”™ï¼Œå›é€€ä¸ºç©ºæ•°ç»„:', err, channel.config_fields);
                configFields = [];
            }
            const configFieldsDiv = document.getElementById('editConfigFields');

            // è°ƒè¯•è¾“å‡º
            console.log('fillEditConfigFields called with:', {
                channelType,
                channelConfigType: typeof channelConfig,
                channelConfigValue: channelConfig
            });

            // åç«¯ç°åœ¨è¿”å›æ­£ç¡®çš„JSONå¯¹è±¡ï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨
            let existingConfig = {};
            try {
                existingConfig = channelConfig || {};
                // ç¡®ä¿æ˜¯å¯¹è±¡
                if (typeof existingConfig !== 'object') {
                    console.warn('channelConfig is not an object, trying to parse:', existingConfig);
                    existingConfig = JSON.parse(existingConfig || '{}');
                }
            } catch (error) {
                console.error('Error processing channelConfig:', error);
                existingConfig = {};
            }

            configFieldsDiv.innerHTML = `
                <div class="info-hint">
                    â„¹ï¸ å½“å‰æ¸ é“é…ç½®å·²ä¿å­˜ï¼Œå¯åœ¨æ­¤ä¿®æ”¹
                </div>
            `;

            configFields.forEach(field => {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';

                const label = document.createElement('label');
                label.textContent = getFieldLabel(field);
                formGroup.appendChild(label);

                const input = document.createElement('input');
                input.type = field.includes('token') || field.includes('secret') ? 'password' : 'text';
                input.id = `editConfig_${field}`;
                input.name = field;
                input.placeholder = `è¯·è¾“å…¥${getFieldLabel(field)}`;
                input.value = existingConfig[field] || '';
                input.required = true;
                formGroup.appendChild(input);

                configFieldsDiv.appendChild(formGroup);
            });

            configFieldsDiv.style.display = 'block';
        }

        // å…³é—­ç¼–è¾‘ä»»åŠ¡æ¨¡æ€æ¡†
        function closeEditTaskModal() {
            const modal = document.getElementById('editTaskModal');
            const modalContent = modal.querySelector('.modal-content');

            // æ·»åŠ å…³é—­åŠ¨ç”»
            modalContent.style.transform = 'scale(0.9)';
            modalContent.style.opacity = '0';

            setTimeout(() => {
                modal.style.display = 'none';
                document.getElementById('editTaskForm').reset();
                document.getElementById('editTaskForm').removeEventListener('submit', handleEditTaskSubmit);
                modalContent.style.transform = 'scale(0.9)';
                modalContent.style.opacity = '0';
            }, 300);
        }

        // å¤„ç†ç¼–è¾‘ä»»åŠ¡è¡¨å•æäº¤
        async function handleEditTaskSubmit(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const taskId = formData.get('taskId');
            const channelSelect = document.getElementById('editChannel');
            const channelType = channelSelect.options[0].value;
            const channel = channels.find(c => c.value === channelType);
            // å…¼å®¹ channel.config_fields ä¸ºæ•°ç»„æˆ–å­—ç¬¦ä¸²çš„æƒ…å†µï¼Œé¿å… JSON.parse åœ¨æ¥æ”¶æ•°ç»„æ—¶æŠ¥é”™
            let configFields = [];
            try {
                if (channel) {
                    if (typeof channel.config_fields === 'string') {
                        configFields = JSON.parse(channel.config_fields || '[]');
                    } else if (Array.isArray(channel.config_fields)) {
                        configFields = channel.config_fields;
                    } else {
                        configFields = [];
                    }
                }
            } catch (err) {
                console.error('è§£æ channel.config_fields å‡ºé”™ï¼Œå›é€€ä¸ºç©ºæ•°ç»„:', err, channel && channel.config_fields);
                configFields = [];
            }

            // æ„å»ºé…ç½®å¯¹è±¡
            const channelConfig = {};
            configFields.forEach(field => {
                const value = document.getElementById(`editConfig_${field}`).value;
                channelConfig[field] = value;
            });

            // æ„å»ºä»»åŠ¡æ•°æ®
            const scheduledTimeValue = formData.get('scheduledTime');
            const taskData = {
                title: formData.get('title'),
                content: formData.get('content'),
                channel: channelType,
                scheduled_time: scheduledTimeValue ? `${scheduledTimeValue}:00` : null,
                channel_config: channelConfig
                // æ³¨æ„ï¼šä¸åŒ…å« is_recurring å’Œ cron_expressionï¼Œå› ä¸ºåç«¯ä¸å…è®¸ä¿®æ”¹è¿™äº›å­—æ®µ
            };

            try {
                const response = await fetch(`${API_BASE}/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(taskData)
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification('ä»»åŠ¡æ›´æ–°æˆåŠŸï¼', 'success');
                    closeEditTaskModal();
                    loadTasks();
                } else {
                    showNotification('æ›´æ–°å¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                showNotification('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>