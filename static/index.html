<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>消息推送系统</title>
    <link rel="icon" type="image/png" href="/static/img/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@400;500;600&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    
    <!-- 动态加载 CSS 以避免缓存 -->
    <script>
        (function() {
            var v = Date.now();
            document.write('<link rel="stylesheet" href="/static/css/styles.css?v=' + v + '">');
            document.write('<link rel="stylesheet" href="/static/css/calendar.css?v=' + v + '">');
        })();
    </script>
</head>
<body>
    <!-- 登录界面 -->
    <div id="loginPage" style="display: none;">
        <div class="login-container">
            <div class="login-card">
                <div class="login-tabs">
                    <div class="login-tab active" onclick="switchTab('login')">登录</div>
                    <div class="login-tab" onclick="switchTab('register')">注册</div>
                </div>

                <!-- 登录表单 -->
                <div id="loginTab" class="tab-content active">
                    <h2 style="text-align: center; margin-bottom: 30px; color: var(--text-strong);">登录通知系统</h2>
                    <form id="loginForm">
                        <div class="form-group">
                            <label for="loginUsername">用户名或邮箱</label>
                            <input type="text" id="loginUsername" name="username" required placeholder="请输入用户名或邮箱">
                        </div>
                        <div class="form-group">
                            <label for="loginPassword">密码</label>
                            <input type="password" id="loginPassword" name="password" required placeholder="请输入密码">
                        </div>
                        <button type="submit" class="btn btn-primary">登录</button>
                    </form>
                </div>

                <!-- 注册表单 -->
                <div id="registerTab" class="tab-content">
                    <h2 style="text-align: center; margin-bottom: 30px; color: var(--text-strong);">注册新账号</h2>
                    <form id="registerForm">
                        <div class="form-group">
                            <label for="registerUsername">用户名</label>
                            <input type="text" id="registerUsername" name="username" required placeholder="请输入用户名">
                        </div>
                        <div class="form-group">
                            <label for="registerEmail">邮箱</label>
                            <input type="email" id="registerEmail" name="email" required placeholder="请输入邮箱">
                        </div>
                        <div class="form-group">
                            <label for="registerPassword">密码</label>
                            <input type="password" id="registerPassword" name="password" required placeholder="请输入密码（至少6位）" minlength="6">
                        </div>
                        <button type="submit" class="btn btn-primary">注册</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 主应用界面 -->
    <div id="mainApp" style="display: none;">
        <!-- 版本更新横幅 -->
        <div id="update-banner" class="update-banner hidden"></div>
        
        <div class="container">
            <header>
                <div class="brand">
                    <div class="brand-logo" aria-hidden="true">
                        <svg viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg" focusable="false" role="presentation">
                            <defs>
                                <linearGradient id="brandLogoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#667eea" />
                                    <stop offset="100%" stop-color="#764ba2" />
                                </linearGradient>
                                <filter id="brandLogoShadow" x="-10%" y="-10%" width="120%" height="120%">
                                    <feDropShadow dx="0" dy="4" stdDeviation="6" flood-color="#4c3e8a" flood-opacity="0.35" />
                                </filter>
                            </defs>
                            <g filter="url(#brandLogoShadow)">
                                <rect x="16" y="16" width="96" height="96" rx="28" fill="url(#brandLogoGradient)" />
                                <path d="M32 52c0-4.418 3.582-8 8-8h48c4.418 0 8 3.582 8 8v24c0 4.418-3.582 8-8 8H40c-4.418 0-8-3.582-8-8V52z" fill="#ffffff" opacity="0.95" />
                                <path d="M36 50l28 22 28-22" fill="none" stroke="#764ba2" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M50 78l14 12 14-12" fill="none" stroke="#764ba2" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M48 38c0-6.627 5.373-12 12-12h8c6.627 0 12 5.373 12 12" fill="none" stroke="#ffffff" stroke-width="4" stroke-linecap="round" />
                                <circle cx="92" cy="40" r="10" fill="#27ae60" stroke="#ffffff" stroke-width="4" />
                                <path d="M88 40l3 3 5-6" fill="none" stroke="#ffffff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
                            </g>
                        </svg>
                    </div>
                    <div class="brand-copy">
                        <h1>📬 消息推送系统</h1>
                        <p>支持多渠道定时发送通知，让您的消息准时到达</p>
                    </div>
                </div>
                <div class="user-info">
                    <span>👤 <span id="currentUsername"></span></span>
                    <button id="exportDataBtn" class="btn btn-sm btn-ghost" onclick="exportData()">📤 导出</button>
                    <button id="importDataBtn" class="btn btn-sm btn-ghost" onclick="document.getElementById('importFileInput').click()">📥 导入</button>
                    <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="importData(event)">
                    <button id="openCalendarBtn" class="btn btn-sm btn-ghost" onclick="openCalendarView()">📅 日历</button>
                    <button class="btn btn-sm btn-ghost" onclick="openSyncModal()">🔄 订阅</button>
                    <button class="logout-btn" onclick="logout()">退出</button>
                </div>
            </header>

            <div class="mobile-tabs" role="tablist" aria-label="移动端视图切换">
                <button type="button" class="mobile-tab active" data-target="form" aria-pressed="true">创建任务</button>
                <button type="button" class="mobile-tab" data-target="list" aria-pressed="false">任务列表</button>
                <button type="button" class="mobile-tab" data-target="calendar" aria-pressed="false">日历</button>
            </div>

            <div class="main-content">
                <!-- 创建任务表单 -->
                <div class="card card-section active" data-section="form">
                    <h2>创建通知任务</h2>
                    <form id="taskForm">
                        <div class="form-group">
                            <label for="title">通知标题 *</label>
                            <input type="text" id="title" name="title" placeholder="请输入通知标题" required>
                        </div>

                        <div class="form-group">
                            <label for="content">通知内容 *</label>
                            <textarea id="content" name="content" placeholder="请输入通知内容" required></textarea>
                            <small style="color: var(--text-muted); display: block; margin-top: 5px; line-height: 1.5;">
                                支持变量: {{date}} 日期, {{time}} 时间, {{datetime}} 完整时间<br>
                                {{year}} 年, {{month}} 月, {{day}} 日, {{weekday_cn}} 星期, {{timestamp}} 时间戳
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="channel">通知渠道 *</label>
                            <div class="checkbox-group" style="margin-bottom: 10px;">
                                <input type="checkbox" id="enableMultiChannel" name="enableMultiChannel">
                                <label for="enableMultiChannel" style="margin-bottom: 0;">启用多渠道发送</label>
                            </div>
                            <div id="singleChannelSection">
                                <select id="channel" name="channel" required>
                                    <option value="">请选择通知渠道</option>
                                </select>
                            </div>
                            <div id="multiChannelSection" style="display: none;">
                                <div id="multiChannelList">
                                    <!-- 动态生成多渠道选择 -->
                                </div>
                                <button type="button" class="btn btn-sm btn-primary" onclick="addChannelSelection()" style="margin-top: 10px;">
                                    ➕ 添加渠道
                                </button>
                            </div>
                        </div>

                        <div id="configFields" class="config-fields" style="display: none;">
                            <!-- 单渠道模式：动态生成配置字段 -->
                        </div>
                        
                        <div id="multiConfigFields" style="display: none;">
                            <!-- 多渠道模式：动态生成多个配置区域 -->
                        </div>

                        <!-- 测试通知按钮 -->
                        <div id="testNotificationSection" class="form-group" style="display: none;">
                            <button type="button" class="btn btn-info" onclick="testNotification()" style="width: 100%;">
                                🧪 测试通知发送
                            </button>
                            <div id="testNotificationResult" style="margin-top: 10px;"></div>
                        </div>

                        <div class="form-group">
                            <label for="scheduledTime">计划发送时间 *</label>
                            <input type="datetime-local" id="scheduledTime" name="scheduledTime" required step="1">
                        </div>

                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="isRecurring" name="isRecurring">
                                <label for="isRecurring" style="margin-bottom: 0;">重复任务</label>
                            </div>
                        </div>

                        <div class="form-group" id="cronGroup" style="display: none;">
                            <label for="cronExpression">Cron 表达式</label>
                            <input type="text" id="cronExpression" name="cronExpression" placeholder="如: 0 9 * * * (每天9点) 或 0/30 * * * * * (每30秒)">
                            <small style="color: var(--text-muted); display: block; margin-top: 5px;">
                                示例: 0 9 * * * (每天9点) | 0 */2 * * * (每2小时) | */30 * * * * * (每30秒)
                            </small>
                        </div>

                        <button type="submit" class="btn btn-primary">创建任务</button>
                    </form>

                    <!-- 渠道管理 -->
                    <div class="channel-management">
                        <h3 style="margin-top: 30px; margin-bottom: 15px; color: var(--text-strong); font-size: 1.2rem;">我的通知渠道</h3>
                        <button class="btn btn-sm btn-info" onclick="openChannelModal()">保存渠道</button>
                        <div id="userChannels" class="channel-list">
                            <!-- 动态生成用户渠道列表 -->
                        </div>
                    </div>
                </div>

                <!-- 任务列表 -->
                <div class="card card-section active" data-section="list">
                    <h2>任务列表</h2>
                    <div class="filter-bar">
                        <select id="statusFilter">
                            <option value="">全部状态</option>
                            <option value="pending" selected>待发送</option>
                            <option value="sent">已发送</option>
                            <option value="failed">发送失败</option>
                            <option value="cancelled">已取消</option>
                        </select>
                        <select id="recurringFilter">
                            <option value="">全部任务</option>
                            <option value="recurring">重复任务</option>
                            <option value="non_recurring">一次性任务</option>
                        </select>
                        <select id="sortField">
                            <option value="scheduled_time" selected>按计划时间</option>
                            <option value="id">按任务ID</option>
                            <option value="status">按任务状态</option>
                            <option value="created_at">按创建时间</option>
                        </select>
                        <select id="sortOrder">
                            <option value="asc" selected>升序</option>
                            <option value="desc">降序</option>
                        </select>
                        <button class="btn btn-info btn-sm" onclick="loadTasks()">刷新</button>
                    </div>
                    <div id="taskList" class="task-list">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>加载中...</p>
                        </div>
                    </div>
                </div>

                <!-- 日历视图 -->
                <div class="card card-section" data-section="calendar" style="display: none;">
                    <h2>日历视图</h2>
                    <div id="calendarControls" class="calendar-controls" aria-hidden="false">
                        <button id="prevMonth" class="btn btn-sm btn-ghost">‹</button>
                        <div id="calendarMonthLabel" class="calendar-month-label"></div>
                        <button id="nextMonth" class="btn btn-sm btn-ghost">›</button>
                    </div>
                    <div id="calendarContainer" class="calendar-container" aria-live="polite">
                        <div id="calendarGrid" class="calendar-grid">
                            <!-- 日历格子与任务将由 JS 生成 -->
                        </div>
                    </div>
                    <div id="calendarDayTasks" class="calendar-day-tasks" style="margin-top: 12px;">
                        <!-- 点击某天显示当天任务列表 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 二次确认模态框 -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="confirm-icon">⚠️</div>
            <h3 id="confirmTitle">确认操作</h3>
            <p id="confirmMessage" class="confirm-message">确认要执行此操作吗？</p>
            <div class="confirm-actions">
                <button id="confirmCancelBtn" class="btn btn-sm btn-ghost">再想想</button>
                <button id="confirmOkBtn" class="btn btn-sm btn-danger">确认</button>
            </div>
        </div>
    </div>

    <!-- 渠道配置模态框 -->
    <div id="channelModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeChannelModal()">&times;</span>
            <h2>添加通知渠道</h2>
            <form id="channelForm">
                <input type="hidden" id="editingChannelId" value="">
                <div class="form-group">
                    <label for="channelName">渠道名称 *</label>
                    <input type="text" id="channelName" name="channelName" required placeholder="如：企业微信通知">
                </div>

                <div class="form-group">
                    <label for="channelType">渠道类型 *</label>
                    <select id="channelType" name="channelType" required>
                        <option value="">请选择渠道类型</option>
                    </select>
                </div>

                <div id="channelConfigFields" class="config-fields">
                    <!-- 动态生成配置字段 -->
                </div>

                <!-- 测试通知按钮 -->
                <div id="channelTestNotificationSection" class="form-group" style="display: none;">
                    <button type="button" class="btn btn-info" onclick="testChannelNotification()" style="width: 100%;">
                        🧪 测试通知发送
                    </button>
                    <div id="channelTestNotificationResult" style="margin-top: 10px;"></div>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="isDefaultChannel" name="isDefault">
                        <label for="isDefaultChannel" style="margin-bottom: 0;">设为默认渠道</label>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">添加渠道</button>
            </form>
        </div>
    </div>

    <!-- 日历同步模态框 -->
    <div id="syncModal" class="modal">
        <div class="modal-content" style="max-width: 650px;">
            <span class="close" onclick="closeSyncModal()">&times;</span>
            <h2>📅 日历订阅与同步</h2>
            
            <div class="login-tabs" style="margin-bottom: 20px;">
                <div class="login-tab active" onclick="switchSyncTab('export')">导出 (订阅)</div>
                <div class="login-tab" onclick="switchSyncTab('import')">导入 (同步)</div>
            </div>

            <!-- 导出/订阅 Tab -->
            <div id="syncExportTab" class="tab-content active">
                <div class="info-hint">
                    ℹ️ 将您的通知任务添加到 Google Calendar、Outlook 或 Apple Calendar 中。
                </div>
                <div class="form-group">
                    <label>您的专属订阅链接 (WebCal/iCal)</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="calendarFeedUrl" readonly style="background: #f5f5f5; color: #666;" placeholder="点击生成按钮获取链接...">
                        <button class="btn btn-info" onclick="copyFeedUrl()">复制</button>
                    </div>
                </div>
                <div style="text-align: right; margin-top: 10px;">
                    <button class="btn btn-sm btn-warning" onclick="generateCalendarToken()">🔄 重置/生成链接</button>
                </div>
                <div style="margin-top: 20px; font-size: 0.9rem; color: var(--text-muted);">
                    <p><strong>如何使用：</strong></p>
                    <ul style="padding-left: 20px; line-height: 1.6;">
                        <li><strong>Google Calendar:</strong> 设置 > 添加日历 > 通过网址添加</li>
                        <li><strong>Apple Calendar:</strong> 文件 > 新建日历订阅</li>
                        <li><strong>Outlook:</strong> 添加日历 > 从 Internet 订阅</li>
                    </ul>
                </div>
            </div>

            <!-- 导入/同步 Tab -->
            <div id="syncImportTab" class="tab-content">
                <div class="info-hint">
                    ℹ️ 订阅外部日历 (如节假日、公司日程)，自动创建通知任务。
                </div>
                
                <form id="externalCalendarForm" style="margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px dashed var(--divider);">
                    <div class="form-group">
                        <label>日历名称</label>
                        <input type="text" name="name" placeholder="如：公司会议日历" required>
                    </div>
                    <div class="form-group">
                        <label>iCal/ICS 链接</label>
                        <input type="url" name="url" placeholder="https://example.com/calendar.ics" required>
                    </div>
                    <div class="form-group">
                        <label>默认通知渠道</label>
                        <select name="channel_id" id="importChannelSelect">
                            <option value="">不发送通知 (仅导入)</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm">添加订阅</button>
                </form>

                <div id="externalCalendarList">
                    <!-- 动态生成列表 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 任务编辑模态框 -->
    <div id="editTaskModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditTaskModal()">&times;</span>
            <h2>编辑任务</h2>
            <form id="editTaskForm">
                <input type="hidden" id="editTaskId" name="taskId">

                <div class="form-group">
                    <label for="editTitle">通知标题 *</label>
                    <input type="text" id="editTitle" name="title" placeholder="请输入通知标题" required>
                </div>

                <div class="form-group">
                    <label for="editContent">通知内容 *</label>
                    <textarea id="editContent" name="content" placeholder="请输入通知内容" required></textarea>
                    <small style="color: var(--text-muted); display: block; margin-top: 5px; line-height: 1.5;">
                        支持变量: {{date}} 日期, {{time}} 时间, {{datetime}} 完整时间<br>
                        {{year}} 年, {{month}} 月, {{day}} 日, {{weekday_cn}} 星期, {{timestamp}} 时间戳
                    </small>
                </div>

                <div class="form-group">
                    <label>通知渠道</label>
                    <select id="editChannel" disabled>
                        <option value="">渠道已确定，不可更改</option>
                    </select>
                    <div class="warning-hint">
                        ⚠️ 出于安全考虑，编辑任务时不能更改通知渠道
                    </div>
                </div>

                <div id="editConfigFields" class="config-fields" style="display: none;">
                    <!-- 动态生成配置字段 -->
                </div>

                <div class="form-group">
                    <label for="editScheduledTime">计划发送时间 *</label>
                    <input type="datetime-local" id="editScheduledTime" name="scheduledTime" required step="1">
                </div>

                <div class="form-group">
                    <label>重复任务设置</label>
                    <div class="checkbox-group">
                        <input type="checkbox" id="editIsRecurring" name="isRecurring" disabled>
                        <label for="editIsRecurring" style="margin-bottom: 0;">重复任务（不可修改）</label>
                    </div>
                    <div class="warning-hint">
                        ⚠️ 重复任务设置不可更改，如需修改请创建新任务
                    </div>
                </div>

                <div id="editCronGroup" class="form-group" style="display: none;">
                    <label for="editCronExpression">Cron 表达式</label>
                    <input type="text" id="editCronExpression" name="cronExpression" readonly style="background: #f5f5f5;">
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">保存修改</button>
                    <button type="button" class="btn btn-danger" onclick="closeEditTaskModal()" style="flex: 1;">取消</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 添加：视图切换控制（在加载 app.js 和 calendar.js 之前） -->
    <script>
    // filepath: /Users/7ommmy/Code/DIY/Notify-Scheduler/static/index.html
    (function () {
        function showSection(section, show) {
            if (!section) return;
            section.style.display = show ? '' : 'none';
            section.classList.toggle('active', !!show);
        }
        function setHeaderToBack() {
            const btn = document.getElementById('openCalendarBtn');
            if (!btn) return;
            btn.textContent = '← 主页面';
            btn.onclick = openMainView;
            btn.setAttribute('aria-pressed', 'false');
        }
        function setHeaderToCalendar() {
            const btn = document.getElementById('openCalendarBtn');
            if (!btn) return;
            btn.textContent = '📅 日历';
            btn.onclick = openCalendarView;
            btn.setAttribute('aria-pressed', 'false');
        }

        // 切换到日历视图（header 按钮变为"返回主页面"）
        window.openCalendarView = function () {
            document.querySelectorAll('.card.card-section').forEach(section => {
                showSection(section, section.dataset.section === 'calendar');
            });
            // 同步移动端 tab
            document.querySelectorAll('.mobile-tab').forEach(t => {
                const isCal = t.dataset && t.dataset.target === 'calendar';
                t.classList.toggle('active', isCal);
                t.setAttribute('aria-pressed', isCal ? 'true' : 'false');
            });
            setHeaderToBack();
            // 使日历占据全宽的全局状态
            document.body.classList.add('calendar-active');
            setTimeout(() => { if (typeof window.loadCalendar === 'function') window.loadCalendar(); }, 10);
        };

        // 返回主页面（显示创建任务 + 任务列表）
        window.openMainView = function (target) {
            // 默认显示 form 和 list 两栏
            const showSections = ['form', 'list'];
            document.querySelectorAll('.card.card-section').forEach(section => {
                showSection(section, showSections.includes(section.dataset.section));
            });
            // 移动端 tab 恢复到创建任务
            document.querySelectorAll('.mobile-tab').forEach(t => {
                const active = t.dataset && (t.dataset.target === (target || 'form'));
                t.classList.toggle('active', active);
                t.setAttribute('aria-pressed', active ? 'true' : 'false');
            });
            setHeaderToCalendar();
            // 恢复常规布局
            document.body.classList.remove('calendar-active');
        };

        // 初始化日历任务列表的编辑功能
        function initCalendarTaskActions() {
            const calendarDayTasks = document.getElementById('calendarDayTasks');
            if (!calendarDayTasks) return;

            // 使用事件委托处理动态生成的按钮
            calendarDayTasks.addEventListener('click', function(e) {
                console.log('Calendar day tasks clicked:', e.target); // 调试日志
                
                // 查找编辑按钮（支持多种可能的选择器）
                let editBtn = e.target;
                
                // 如果点击的是按钮内的元素，向上查找按钮
                if (!editBtn.matches('button')) {
                    editBtn = editBtn.closest('button');
                }
                
                // 检查是否是编辑按钮
                if (editBtn && (
                    editBtn.classList.contains('calendar-task-edit') ||
                    editBtn.dataset.action === 'edit' ||
                    editBtn.textContent.includes('✏️')
                )) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const taskId = editBtn.dataset.taskId || editBtn.getAttribute('data-task-id');
                    console.log('Edit button clicked, taskId:', taskId); // 调试日志
                    
                    if (taskId) {
                        // 等待 openEditTaskModal 函数可用
                        const tryOpenModal = () => {
                            if (typeof window.openEditTaskModal === 'function') {
                                console.log('Opening edit modal for task:', taskId);
                                window.openEditTaskModal(taskId);
                            } else {
                                console.warn('openEditTaskModal not ready, retrying...');
                                setTimeout(tryOpenModal, 100);
                            }
                        };
                        tryOpenModal();
                    } else {
                        console.error('Task ID not found on button:', editBtn);
                    }
                    return;
                }

                // 处理取消按钮
                let cancelBtn = e.target;
                if (!cancelBtn.matches('button')) {
                    cancelBtn = cancelBtn.closest('button');
                }
                
                if (cancelBtn && cancelBtn.dataset.action === 'cancel') {
                    e.preventDefault();
                    e.stopPropagation();
                    const taskId = cancelBtn.dataset.taskId || cancelBtn.getAttribute('data-task-id');
                    console.log('Cancel button clicked, taskId:', taskId); // 调试日志
                    if (taskId && typeof window.cancelTask === 'function') {
                        window.cancelTask(taskId);
                    }
                }
            }, true); // 使用捕获阶段确保事件能被捕获

            // 使用 MutationObserver 监听任务列表的变化
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes.length > 0) {
                        console.log('Calendar day tasks updated, checking for buttons...'); // 调试日志
                        // 验证按钮是否正确生成
                        const buttons = calendarDayTasks.querySelectorAll('button[data-action="edit"]');
                        console.log('Found edit buttons:', buttons.length);
                    }
                });
            });

            observer.observe(calendarDayTasks, {
                childList: true,
                subtree: true
            });
        }

        // 当用户通过移动端 tab 切换时，保持 header 状态同步
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.mobile-tab').forEach(t => {
                t.addEventListener('click', function () {
                    const target = t.dataset && t.dataset.target;
                    if (target === 'calendar') {
                        setTimeout(() => { if (typeof window.loadCalendar === 'function') window.loadCalendar(); }, 10);
                        setHeaderToBack();
                    } else {
                        setHeaderToCalendar();
                    }
                });
            });

            // 初始化日历任务操作
            initCalendarTaskActions();
        });
    })();
    </script>
    
    <!-- 动态加载 JS 以避免缓存 -->
    <script>
        (function() {
            var v = Date.now();
            document.write('<script src="/static/js/app.js?v=' + v + '"><\/script>');
            document.write('<script src="/static/js/calendar.js?v=' + v + '"><\/script>');
        })();
    </script>    
    <!-- 底部信息显示 -->
    <div style="text-align: center; padding: 10px 0 2px; font-size: 14px; color: rgba(255, 255, 255, 0.5); display: flex; justify-content: center; align-items: center; gap: 4px; white-space: nowrap;">
        <span>
            Powered by <a href="https://github.com/TommyMerlin/Notify-Scheduler" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 500;">Notify-Scheduler</a>
        </span>
        <span id="version-info"></span>
    </div>
</body>
</html>