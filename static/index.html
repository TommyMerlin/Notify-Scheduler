<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šçŸ¥å®šæ—¶å‘é€ç³»ç»Ÿ</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMjggMTI4Ij48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImdyYWQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiM2NjdlZWEiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiM3NjRiYTIiLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48cmVjdCB4PSIxNiIgeT0iMTYiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgcng9IjI4IiBmaWxsPSJ1cmwoI2dyYWQpIi8+PHBhdGggZD0iTTMyIDUyYzAtNC40MTggMy41ODItOCA4LThoNDhjNC40MTggMCA4IDMuNTgyIDggOHYyNGMwIDQuNDE4LTMuNTgyIDgtOCA4SDQwYy00LjQxOCAwLTgtMy41ODItOC04VjUyeiIgZmlsbD0iI2ZmZiIgb3BhY2l0eT0iMC45NSIvPjxwYXRoIGQ9Ik0zNiA1MGwyOCAyMiAyOC0yMiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjNzY0YmEyIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjxjaXJjbGUgY3g9IjkyIiBjeT0iNDAiIHI9IjEwIiBmaWxsPSIjMjdhZTYwIiBzdHJva2U9IiNmZmYiIHN0cm9rZS13aWR0aD0iNCIvPjxwYXRoIGQ9Ik08OCA0MGwzIDMgNS02IiBmaWxsPSJub25lIiBzdHJva2U9IiNmZmYiIHN0cm9rZS13aWR0aD0iMyIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+PC9zdmc+">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@400;500;600&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #030712;
            --bg-accent: #0b1126;
            --bg-accent-2: #101735;
            --panel: rgba(10, 14, 35, 0.8);
            --panel-border: rgba(255, 255, 255, 0.12);
            --card: rgba(255, 255, 255, 0.95);
            --card-border: rgba(15, 23, 42, 0.08);
            --card-shadow: 0 30px 60px rgba(4, 6, 15, 0.25);
            --primary: #5f7bff;
            --primary-strong: #3a45ff;
            --accent: #5df2c8;
            --text-strong: #0f172a;
            --text-muted: #6b7280;
            --divider: rgba(99, 102, 241, 0.25);
            --radius-lg: 32px;
            --radius-md: 18px;
            --radius-sm: 12px;
            --select-arrow-icon: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20'%3E%3Ccircle cx='10' cy='10' r='8.5' fill='%23f5f7ff' stroke='%235f7bff' stroke-width='1.2'/%3E%3Cpath d='M6.5 8.5 10 12l3.5-3.5' fill='none' stroke='%235f7bff' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        }

        body {
            font-family: 'Figtree', 'Space Grotesk', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: radial-gradient(circle at 15% 20%, rgba(99, 102, 241, 0.4), transparent 45%),
                        radial-gradient(circle at 85% 0%, rgba(93, 242, 200, 0.25), transparent 40%),
                        linear-gradient(135deg, var(--bg-accent), var(--bg-accent-2));
            color: var(--text-strong);
            min-height: 100vh;
            padding: 40px 20px 60px;
            position: relative;
            overflow-x: hidden;
        }

        body::before,
        body::after {
            content: '';
            position: fixed;
            width: 380px;
            height: 380px;
            background: radial-gradient(circle, rgba(93, 242, 200, 0.4), transparent 65%);
            filter: blur(40px);
            opacity: 0.35;
            z-index: 0;
        }

        body::before {
            top: -120px;
            left: -60px;
        }

        body::after {
            bottom: -160px;
            right: -30px;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.35), transparent 60%);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        header {
            color: #f8fafc;
            margin-bottom: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left;
            gap: 24px;
            padding: 32px;
            border-radius: var(--radius-lg);
            background: var(--panel);
            border: 1px solid var(--panel-border);
            backdrop-filter: blur(24px);
            box-shadow: var(--card-shadow);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .brand-logo {
            width: 74px;
            height: 74px;
            border-radius: 24px;
            background: rgba(255, 255, 255, 0.08);
            padding: 10px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        .brand-logo svg {
            width: 100%;
            height: 100%;
            display: block;
        }

        .brand-copy h1 {
            margin-bottom: 8px;
            font-family: 'Space Grotesk', 'Figtree', sans-serif;
            font-size: 2.4rem;
            letter-spacing: 0.02em;
            color: #fff;
        }

        .brand-copy p {
            margin: 0;
            color: rgba(255, 255, 255, 0.75);
            font-size: 1.05rem;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1rem;
            color: rgba(248, 250, 252, 0.82);
        }

        .user-info {
            background: rgba(255, 255, 255, 0.12);
            padding: 16px 22px;
            border-radius: 999px;
            color: #f8fafc;
            font-size: 0.95rem;
            border: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: none;
            padding: 6px 18px;
            border-radius: 999px;
            cursor: pointer;
            transition: background 0.3s, transform 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .main-content {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(0, 1.15fr);
            gap: 28px;
            margin-bottom: 40px;
            align-items: start; /* allow columns to stretch */
        }

        .mobile-tabs {
            display: none;
            margin-bottom: 18px;
            padding: 6px;
            border-radius: 18px;
            background: rgba(15, 23, 42, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
        }

        .mobile-tab {
            border: none;
            border-radius: 14px;
            padding: 12px 16px;
            font-weight: 600;
            font-size: 0.95rem;
            text-align: center;
            color: rgba(248, 250, 252, 0.7);
            background: transparent;
            transition: background 0.25s ease, color 0.25s ease, transform 0.2s ease;
        }

        .mobile-tab.active {
            color: #0f172a;
            background: linear-gradient(135deg, var(--accent), #8bd3ff);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.18);
        }

        .card {
            background: var(--card);
            border-radius: var(--radius-md);
            padding: 28px;
            border: 1px solid var(--card-border);
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(18px);
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0; /* allow proper overflow in children */
        }

        .card h2 {
            color: var(--text-strong);
            margin-bottom: 24px;
            font-size: 1.5rem;
            font-family: 'Space Grotesk', sans-serif;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card h2::after {
            content: '';
            flex: 1;
            height: 2px;
            margin-left: 16px;
            background: linear-gradient(90deg, var(--divider), transparent);
        }

        .form-group {
            margin-bottom: 22px;
        }

        .form-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            color: var(--text-strong);
            font-weight: 600;
            letter-spacing: 0.01em;
        }

        .form-group input,
        .form-group textarea,
        .form-group select,
        .filter-bar select,
        .user-channel-select {
            width: 100%;
            padding: 14px 16px;
            border: 1.5px solid rgba(15, 23, 42, 0.1);
            border-radius: 16px;
            font-size: 15px;
            background: rgba(15, 23, 42, 0.02);
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
        }

        .form-group select,
        .filter-bar select,
        .user-channel-select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image:
                var(--select-arrow-icon),
                linear-gradient(to bottom, rgba(15, 23, 42, 0.12), rgba(15, 23, 42, 0.12));
            background-repeat: no-repeat;
            background-position: calc(100% - 20px) 50%, calc(100% - 56px) 50%;
            background-size: 20px auto, 1px 60%;
            padding-right: 64px;
            color: var(--text-strong);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(15, 23, 42, 0.45);
        }

        /* å·²ä¿å­˜æ¸ é“ä¸‹æ‹‰é¢å¤–é—´è· */
        .user-channel-select {
            margin-bottom: 15px;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus,
        .filter-bar select:focus,
        .user-channel-select:focus {
            outline: none;
            border-color: var(--primary);
            background-color: #fff;
            box-shadow: 0 15px 30px rgba(99, 102, 241, 0.12);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .config-fields {
            background: rgba(99, 102, 241, 0.05);
            padding: 18px;
            border-radius: var(--radius-sm);
            margin-top: 10px;
            border: 1px dashed rgba(99, 102, 241, 0.35);
        }

        .config-fields .form-group {
            margin-bottom: 15px;
        }

        .config-fields .form-group:last-child {
            margin-bottom: 0;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 999px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.01em;
        }

        .btn-primary {
            background: linear-gradient(120deg, var(--primary) 0%, var(--primary-strong) 100%);
            color: white;
            width: 100%;
            box-shadow: 0 18px 35px rgba(58, 69, 255, 0.35);
        }

        .btn-primary:hover {
            transform: translateY(-3px) scale(1.01);
            box-shadow: 0 22px 45px rgba(58, 69, 255, 0.45);
        }

        .btn-ghost {
            background: rgba(15, 23, 42, 0.06);
            color: var(--text-strong);
            border: 1px solid rgba(15, 23, 42, 0.08);
        }

        .btn-ghost:hover {
            background: rgba(15, 23, 42, 0.12);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 14px;
        }

        .btn-danger {
            background: linear-gradient(120deg, #ff5f6d, #ff9966);
            color: white;
            box-shadow: 0 10px 25px rgba(255, 95, 109, 0.35);
        }

        .btn-success {
            background: linear-gradient(120deg, #34d399, #10b981);
            color: white;
            box-shadow: 0 12px 28px rgba(16, 185, 129, 0.35);
        }

        .btn-info {
            background: linear-gradient(120deg, #38bdf8, #818cf8);
            color: white;
            box-shadow: 0 12px 28px rgba(56, 189, 248, 0.35);
        }

        .task-list {
            max-height: 620px;
            overflow-y: auto;
            padding: 8px;
            margin: 0;
            border-radius: var(--radius-sm);
            background: rgba(15, 23, 42, 0.02);
            border: 1px solid rgba(15, 23, 42, 0.05);
            flex: 1 1 auto;
            min-height: 0;
            max-height: none !important; /* override previous fixed max-height values */
        }

        /* Cap the task-list height so it won't grow indefinitely â€” once exceeding this it will scroll */
        #taskList,
        .task-list {
            /* keep flexible behavior but limit maximum height */
            flex: 1 1 auto;
            min-height: 0;
            max-height: min(720px, calc(100vh - 260px)) !important; /* cap height relative to viewport */
            overflow-y: auto;
        }

        /* Slightly smaller cap on narrow screens to account for taller header/controls */
        @media (max-width: 768px) {
            #taskList,
            .task-list {
                max-height: calc(100vh - 300px) !important;
            }
        }

        .task-item {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.97), rgba(243, 244, 255, 0.95));
            padding: 20px 22px 20px 32px;
            margin-bottom: 18px;
            border-radius: 20px;
            transition: all 0.35s ease;
            position: relative;
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.12);
            border: 1px solid rgba(15, 23, 42, 0.08);
        }

        .task-item.recurring {
            border: 1.5px solid rgba(93, 242, 200, 0.65);
            box-shadow: 0 18px 40px rgba(93, 242, 200, 0.12), var(--card-shadow);
        }

        /* è¿‡æœŸä»»åŠ¡æ ·å¼è°ƒæ•´ï¼ˆä¿®å¤ ::after æ‹¼å†™å¹¶ä¼˜åŒ–è§†è§‰ï¼‰ */
        .task-item.expired {
            background: linear-gradient(135deg, #e9e9e9, #e0e0e0);
            border-color: rgba(15, 23, 42, 0.04);
            box-shadow: none;
            color: rgba(15, 23, 42, 0.65);
        }
        .task-item.expired::after {
            background: linear-gradient(180deg, rgba(200,200,200,0.6), rgba(220,220,220,0.6));
            opacity: 0.8;
        }

        /* è¿‡æœŸä¸“ç”¨å¾½ç«  */
        .status-badge.status-expired {
            background: rgba(148,163,184,0.12);
            color: rgba(71,85,105,1);
            box-shadow: none;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .task-title {
            font-weight: 600;
            font-size: 1.15rem;
            color: var(--text-strong);
            margin-bottom: 6px;
            font-family: 'Space Grotesk', sans-serif;
        }

        .task-content {
            color: var(--text-muted);
            margin-bottom: 14px;
            line-height: 1.5;
        }

        .task-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            font-size: 0.92rem;
            color: rgba(15, 23, 42, 0.7);
        }

        .task-actions {
            display: flex;
            gap: 12px;
            margin-top: 18px;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 14px;
            border-radius: 999px;
            font-size: 0.82rem;
            font-weight: 600;
            letter-spacing: 0.01em;
        }

        .status-pending {
            background: rgba(250, 204, 21, 0.15);
            color: #b45309;
        }

        .status-sent {
            background: rgba(16, 185, 129, 0.15);
            color: #047857;
        }

        .status-failed {
            background: rgba(248, 113, 113, 0.18);
            color: #b91c1c;
        }

        .status-cancelled {
            background: rgba(148, 163, 184, 0.2);
            color: #475569;
        }

        .channel-badge {
            background: rgba(99, 102, 241, 0.15);
            color: var(--primary-strong);
            padding: 5px 14px;
            border-radius: 999px;
            font-size: 0.82rem;
        }

        /* é‡å¤ä»»åŠ¡é†’ç›®æ ‡è¯† */
        .recurring-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.82rem;
            font-weight: 700;
            letter-spacing: 0.02em;
            color: #0f172a;
            background: linear-gradient(135deg, rgba(93, 242, 200, 0.15), rgba(95, 123, 255, 0.1));
            border: 1px solid rgba(15, 23, 42, 0.12);
            box-shadow: 0 10px 22px rgba(16, 24, 40, 0.18);
            vertical-align: middle;
        }

        .recurring-badge::before {
            content: 'â†»';
            display: inline-block;
            font-weight: 900;
        }

        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 24px;
            background: rgba(15, 23, 42, 0.03);
            border: 1px solid rgba(15, 23, 42, 0.08);
            border-radius: 18px;
            padding: 12px;
        }

        .filter-bar select {
            flex: 1;
            min-width: 160px;
            width: auto;
        }

        .empty-state {
            text-align: center;
            padding: 48px 20px;
            color: rgba(15, 23, 42, 0.55);
            border-radius: 20px;
            border: 1px dashed rgba(99, 102, 241, 0.35);
            background: rgba(99, 102, 241, 0.04);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 18px 28px;
            border-radius: 18px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .notification.success {
            background: linear-gradient(120deg, #22c55e, #16a34a);
        }

        .notification.error {
            background: linear-gradient(120deg, #fb7185, #ef4444);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .login-container {
            max-width: 420px;
            margin: 80px auto;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 26px;
            padding: 40px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(15, 23, 42, 0.08);
            backdrop-filter: blur(14px);
        }

        .login-tabs {
            display: inline-flex;
            margin-bottom: 32px;
            border-radius: 999px;
            padding: 4px;
            background: rgba(99, 102, 241, 0.08);
            width: 100%;
        }

        .login-tab {
            flex: 1;
            padding: 12px 18px;
            text-align: center;
            cursor: pointer;
            border-radius: 999px;
            transition: all 0.3s;
            font-weight: 600;
            color: rgba(15, 23, 42, 0.6);
        }

        .login-tab.active {
            color: #fff;
            background: linear-gradient(120deg, var(--primary), var(--primary-strong));
            box-shadow: 0 15px 25px rgba(58, 69, 255, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .channel-management {
            margin-top: 32px;
        }

        .channel-management .btn-info {
            margin-bottom: 16px;
        }

        .channel-list {
            margin-top: 4px;
        }

        .channel-item {
            background: rgba(15, 23, 42, 0.03);
            padding: 18px;
            margin-bottom: 12px;
            border-radius: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(15, 23, 42, 0.08);
        }

        .channel-info {
            flex: 1;
        }

        .channel-name {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-strong);
        }

        .channel-type {
            color: rgba(15, 23, 42, 0.6);
            font-size: 0.9rem;
        }

        .channel-actions {
            display: flex;
            gap: 10px;
            min-width: 220px;
            flex: 0 0 auto;
        }

        .channel-actions .btn-sm {
            flex: 1;
            min-width: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 10px 16px !important;
            font-size: 13px !important;
            line-height: 1.2 !important;
            height: 36px !important;
            min-height: 36px !important;
            width: auto;
            box-sizing: border-box;
        }

        .channel-actions .btn-sm.btn-info,
        .channel-actions .btn-sm.btn-danger {
            height: 36px !important;
            min-height: 36px !important;
            padding: 10px 16px !important;
            line-height: 1.2 !important;
        }

        /* å“åº”å¼è®¾è®¡å¢å¼º */

        /* å¹³æ¿è®¾å¤‡é€‚é… */
        @media (max-width: 1200px) {
            .container {
                padding: 0 15px;
            }

            .card {
                padding: 20px;
            }

            header h1 {
                font-size: 2.2rem;
            }

            .main-content {
                gap: 15px;
            }
        }

        /* å°å¹³æ¿è®¾å¤‡é€‚é… */
        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            header {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }

            .brand {
                flex-direction: column;
                text-align: center;
            }

            .brand-logo {
                width: 56px;
                height: 56px;
            }

            header h1 {
                font-size: 2rem;
            }

            .user-info {
                align-self: center;
            }
        }

        /* æ‰‹æœºè®¾å¤‡é€‚é… */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 0 10px;
            }

            header {
                margin-bottom: 25px;
            }

            header h1 {
                font-size: 1.8rem;
                margin-bottom: 8px;
            }

            header p {
                font-size: 1rem;
            }

            .card {
                padding: 15px;
                margin-bottom: 15px;
            }

            .card h2 {
                font-size: 1.3rem;
            }

            .form-group input,
            .form-group textarea,
            .form-group select {
                padding: 10px;
                font-size: 16px; /* é˜²æ­¢ iOS è‡ªåŠ¨ç¼©æ”¾ */
            }

            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }

            .task-meta {
                flex-direction: column;
                gap: 8px;
            }

            .task-header {
                flex-direction: column;
                gap: 10px;
            }

            .filter-bar {
                flex-direction: column;
                gap: 10px;
            }

            .notification {
                max-width: calc(100vw - 40px);
                right: 20px;
                left: 20px;
            }

            .channel-actions {
                flex-direction: column;
                width: 100%;
                gap: 8px;
                min-width: 0;
            }

            .channel-actions .btn {
                width: 100%;
            }

            .channel-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .modal-content {
                margin: 10% auto;
                padding: 15px;
                width: 95%;
            }

            .login-container {
                margin: 50px 10px;
                max-width: none;
            }

            .login-card {
                padding: 25px;
            }
        }

        /* ç§»åŠ¨ç«¯è§†å›¾åˆ‡æ¢ */
        @media (max-width: 640px) {
            .mobile-tabs {
                display: grid;
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 8px;
                position: sticky;
                top: 12px;
                z-index: 5;
                backdrop-filter: blur(12px);
            }

            .card-section {
                display: none;
            }

            .card-section.active {
                display: block;
            }

            .main-content {
                margin-top: 10px;
            }
        }

        @media (min-width: 641px) {
            .card-section {
                display: block;
            }
        }

        /* å°å±æ‰‹æœºè®¾å¤‡é€‚é… */
        @media (max-width: 480px) {
            header h1 {
                font-size: 1.5rem;
            }

            .card {
                padding: 12px;
            }

            .card h2 {
                font-size: 1.2rem;
            }

            .task-item {
                padding: 12px 12px 12px 26px;
            }

            .status-badge,
            .channel-badge {
                font-size: 0.75rem;
                padding: 3px 8px;
            }

            .btn-sm {
                padding: 5px 10px;
                font-size: 12px;
            }

            .task-actions {
                flex-direction: column;
                gap: 8px;
            }

            .task-actions .btn {
                width: 100%;
            }
        }

        /* è¶…å®½å±é€‚é… */
        @media (min-width: 1400px) {
            .container {
                max-width: 1600px;
            }

            .main-content {
                gap: 30px;
            }

            .task-list {
                max-height: 700px;
            }
        }

        /* æ¨ªå±æ¨¡å¼é€‚é… */
        @media (max-height: 600px) and (orientation: landscape) {
            .login-container {
                margin: 20px auto;
            }

            .modal-content {
                margin: 2% auto;
                max-height: 90vh;
                overflow-y: auto;
            }

            .task-list {
                max-height: 400px;
            }
        }

        .loading {
            text-align: center;
            padding: 28px;
            color: rgba(15, 23, 42, 0.6);
        }

        .spinner {
            border: 3px solid rgba(99, 102, 241, 0.15);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 42px;
            height: 42px;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.96);
            margin: 5% auto;
            padding: 28px;
            border-radius: 24px;
            width: 90%;
            max-width: 560px;
            border: 1px solid rgba(15, 23, 42, 0.08);
            box-shadow: 0 30px 70px rgba(15, 23, 42, 0.25);
            backdrop-filter: blur(12px);
        }

        .modal.show .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        .close {
            color: rgba(15, 23, 42, 0.4);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: var(--primary);
        }

        /* å“åº”å¼äº¤äº’ä¼˜åŒ– */

        /* å¢åŠ å¯ç‚¹å‡»åŒºåŸŸ */
        .btn,
        .login-tab,
        .task-item,
        .channel-item {
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        /* ç§»åŠ¨ç«¯æŒ‰é’®æœ€å°ç‚¹å‡»åŒºåŸŸ */
        @media (max-width: 768px) {
            .btn {
                min-height: 44px; /* iOS æ¨èçš„æœ€å°ç‚¹å‡»åŒºåŸŸ */
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .btn-sm {
                min-height: 36px;
                padding: 8px 12px;
            }

            /* ä¼˜åŒ–å°å±å¹•è§¦æ‘¸ä½“éªŒ */
            .form-group input,
            .form-group textarea,
            .form-group select {
                min-height: 44px;
                padding: 10px 12px;
            }

            /* ä»»åŠ¡æ“ä½œæŒ‰é’®ä¼˜åŒ– */
            .task-actions {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                margin-top: 12px;
            }

            .task-actions .btn {
                flex: 1;
                min-width: 100px;
            }

            /* ç¼–è¾‘æ¨¡æ€æ¡†ç§»åŠ¨ç«¯ä¼˜åŒ– */
            #editTaskModal .modal-content {
                margin: 5% auto;
                padding: 15px;
                max-height: 90vh;
                overflow-y: auto;
            }

            #editTaskModal form {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }

            #editTaskModal .form-group {
                margin-bottom: 0;
            }

            #editTaskModal .modal-content h2 {
                font-size: 1.3rem;
                margin-bottom: 15px;
            }

            /* ç¼–è¾‘è¡¨å•åº•éƒ¨æŒ‰é’®ä¼˜åŒ– */
            #editTaskModal form > div:last-child {
                display: flex;
                flex-direction: column;
                gap: 10px;
                margin-top: 20px;
            }
        }

        /* ç¼–è¾‘æ¨¡æ€æ¡†æ ·å¼ä¼˜åŒ– */
        #editTaskModal .modal-content {
            max-width: 600px;
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s ease;
        }

        #confirmModal .modal-content {
            max-width: 420px;
            text-align: center;
            transform: scale(0.94);
            opacity: 0;
            transition: all 0.22s ease;
            padding: 26px 28px;
        }

        #confirmModal .confirm-icon {
            width: 52px;
            height: 52px;
            border-radius: 16px;
            background: rgba(255, 95, 109, 0.1);
            border: 1px solid rgba(255, 95, 109, 0.25);
            color: #e11d48;
            display: grid;
            place-items: center;
            font-size: 24px;
            margin: 0 auto 14px;
        }

        #confirmModal h3 {
            margin: 0 0 8px;
            font-size: 1.2rem;
        }

        #confirmModal .confirm-message {
            color: var(--text-muted);
            line-height: 1.6;
        }

        #confirmModal .confirm-actions {
            margin-top: 18px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        #confirmModal .confirm-actions .btn {
            flex: 1;
        }

        #confirmModal.show .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        #editTaskModal form {
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 10px;
        }

        /* ç¦ç”¨å­—æ®µæ ·å¼ */
        .form-group input:disabled,
        .form-group select:disabled,
        .form-group textarea:disabled {
            background-color: rgba(148, 163, 184, 0.2);
            cursor: not-allowed;
            opacity: 0.75;
        }

        /* è­¦å‘Šæç¤ºæ ·å¼ */
        .warning-hint {
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid rgba(251, 191, 36, 0.5);
            border-radius: 12px;
            padding: 10px 14px;
            margin-top: 8px;
            font-size: 0.85rem;
            color: #92400e;
        }

        /* ä¿¡æ¯æç¤ºæ ·å¼ */
        .info-hint {
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.35);
            border-radius: 12px;
            padding: 10px 14px;
            margin-bottom: 18px;
            font-size: 0.85rem;
            color: #1d4ed8;
        }

        /* ç¼–è¾‘è¡¨å•æ»šåŠ¨æ¡ä¼˜åŒ– */
        #editTaskModal form::-webkit-scrollbar {
            width: 4px;
        }

        #editTaskModal form::-webkit-scrollbar-track {
            background: transparent;
        }

        #editTaskModal form::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.2);
            border-radius: 2px;
        }

        #editTaskModal form::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 102, 241, 0.4);
        }

        /* æ»šåŠ¨æ¡ç¾åŒ–ä¼˜åŒ– - é€‚ç”¨äºæ‰€æœ‰è®¾å¤‡ */
        .task-list {
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: rgba(99, 102, 241, 0.3) transparent; /* Firefox */
        }

        .task-list::-webkit-scrollbar {
            width: 6px;
        }

        .task-list::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 3px;
        }

        .task-list::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.3);
            border-radius: 3px;
            transition: background 0.3s ease;
        }

        .task-list:hover::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.6);
        }

        .task-list::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 102, 241, 0.8);
        }

        /* è§¦æ‘¸è®¾å¤‡å®Œå…¨éšè—æ»šåŠ¨æ¡ */
        @media (pointer: coarse) {
            * {
                -webkit-overflow-scrolling: touch;
            }

            .task-list {
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none; /* Firefox */
                -ms-overflow-style: none; /* IE/Edge */
            }

            .task-list::-webkit-scrollbar {
                display: none; /* Chrome/Safari */
            }
        }

        /* é¼ æ ‡è®¾å¤‡æ˜¾ç¤ºæ›´ç²¾è‡´çš„æ»šåŠ¨æ¡ */
        @media (pointer: fine) {
            .task-list {
                scrollbar-width: thin;
                scrollbar-color: rgba(99, 102, 241, 0.2) transparent;
            }

            .task-list::-webkit-scrollbar {
                width: 4px;
            }

            .task-list::-webkit-scrollbar-track {
                background: transparent;
            }

            .task-list::-webkit-scrollbar-thumb {
                background: rgba(99, 102, 241, 0.2);
                border-radius: 2px;
                transition: all 0.2s ease;
            }

            .task-list:hover::-webkit-scrollbar-thumb {
                background: rgba(99, 102, 241, 0.4);
                width: 6px;
            }

            .task-list::-webkit-scrollbar-thumb:hover {
                background: rgba(99, 102, 241, 0.6);
            }
        }

        /* æ‚¬åœæ•ˆæœä¼˜åŒ– - é¿å…è§¦å‘æ»šåŠ¨æ¡ */
        @media (hover: hover) and (pointer: fine) {
            .btn:hover {
                transform: translateY(-2px);
            }

            .task-item {
                transition: all 0.3s ease;
                position: relative;
            }

            .task-item:hover {
                transform: translateY(-4px);
                box-shadow: 0 25px 55px rgba(99, 102, 241, 0.25);
            }

            .channel-item:hover {
                background: rgba(99, 102, 241, 0.08);
                border-color: rgba(99, 102, 241, 0.2);
            }

            .login-tab:hover {
                background: rgba(99, 102, 241, 0.12);
                color: var(--text-strong);
            }
        }

        /* æ— æ‚¬åœè®¾å¤‡ä½¿ç”¨è§¦æ‘¸åé¦ˆ */
        @media (hover: none) and (pointer: coarse) {
            .btn:active {
                transform: scale(0.98);
            }

            .task-item:active {
                transform: scale(0.98);
            }

            .channel-item:active {
                background: rgba(99, 102, 241, 0.12);
            }

            .login-tab:active {
                background: rgba(99, 102, 241, 0.2);
            }
        }

        /* é«˜DPIå±å¹•ä¼˜åŒ– */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .status-badge,
            .channel-badge {
                border-width: 0.5px;
            }

            .btn {
                border-width: 0.5px;
            }
        }

        /* æ·±è‰²æ¨¡å¼æ”¯æŒï¼ˆå¯é€‰ï¼‰ */
        @media (prefers-color-scheme: dark) {
            /* è¿™é‡Œå¯ä»¥æ·»åŠ æ·±è‰²æ¨¡å¼æ”¯æŒï¼Œå½“å‰ä¸ºæµ…è‰²æ¨¡å¼ */
        }

        /* å‡å°‘åŠ¨ç”»ï¼ˆæ ¹æ®ç”¨æˆ·åå¥½ï¼‰ */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Ensure columns can be equal-height and the task-list scrollbar stretches with the card height */
        .main-content {
            /* keep existing grid layout but allow children to stretch to match the tallest column */
            align-items: start;
        }

        /* Make cards use a column flex layout so their inner area can grow/shrink predictably */
        .card {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0; /* allow proper overflow in children */
        }

        /* Ensure card sections (grid items) don't impose a min-height that prevents shrinking */
        .card-section {
            min-height: 0;
        }

        /* Make the task list flexible: take remaining vertical space and allow its internal scrollbar to reflect the card height */
        #taskList,
        .task-list {
            flex: 1 1 auto;
            min-height: 0;
            max-height: none !important; /* override previous fixed max-height values */
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•ç•Œé¢ -->
    <div id="loginPage" style="display: none;">
        <div class="login-container">
            <div class="login-card">
                <div class="login-tabs">
                    <div class="login-tab active" onclick="switchTab('login')">ç™»å½•</div>
                    <div class="login-tab" onclick="switchTab('register')">æ³¨å†Œ</div>
                </div>

                <!-- ç™»å½•è¡¨å• -->
                <div id="loginTab" class="tab-content active">
                    <h2 style="text-align: center; margin-bottom: 30px; color: var(--text-strong);">ç™»å½•é€šçŸ¥ç³»ç»Ÿ</h2>
                    <form id="loginForm">
                        <div class="form-group">
                            <label for="loginUsername">ç”¨æˆ·åæˆ–é‚®ç®±</label>
                            <input type="text" id="loginUsername" name="username" required placeholder="è¯·è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±">
                        </div>
                        <div class="form-group">
                            <label for="loginPassword">å¯†ç </label>
                            <input type="password" id="loginPassword" name="password" required placeholder="è¯·è¾“å…¥å¯†ç ">
                        </div>
                        <button type="submit" class="btn btn-primary">ç™»å½•</button>
                    </form>
                </div>

                <!-- æ³¨å†Œè¡¨å• -->
                <div id="registerTab" class="tab-content">
                    <h2 style="text-align: center; margin-bottom: 30px; color: var(--text-strong);">æ³¨å†Œæ–°è´¦å·</h2>
                    <form id="registerForm">
                        <div class="form-group">
                            <label for="registerUsername">ç”¨æˆ·å</label>
                            <input type="text" id="registerUsername" name="username" required placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                        </div>
                        <div class="form-group">
                            <label for="registerEmail">é‚®ç®±</label>
                            <input type="email" id="registerEmail" name="email" required placeholder="è¯·è¾“å…¥é‚®ç®±">
                        </div>
                        <div class="form-group">
                            <label for="registerPassword">å¯†ç </label>
                            <input type="password" id="registerPassword" name="password" required placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" minlength="6">
                        </div>
                        <button type="submit" class="btn btn-primary">æ³¨å†Œ</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ç•Œé¢ -->
    <div id="mainApp" style="display: none;">
        <div class="container">
            <header>
                <div class="brand">
                    <div class="brand-logo" aria-hidden="true">
                        <svg viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg" focusable="false" role="presentation">
                            <defs>
                                <linearGradient id="brandLogoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#667eea" />
                                    <stop offset="100%" stop-color="#764ba2" />
                                </linearGradient>
                                <filter id="brandLogoShadow" x="-10%" y="-10%" width="120%" height="120%">
                                    <feDropShadow dx="0" dy="4" stdDeviation="6" flood-color="#4c3e8a" flood-opacity="0.35" />
                                </filter>
                            </defs>
                            <g filter="url(#brandLogoShadow)">
                                <rect x="16" y="16" width="96" height="96" rx="28" fill="url(#brandLogoGradient)" />
                                <path d="M32 52c0-4.418 3.582-8 8-8h48c4.418 0 8 3.582 8 8v24c0 4.418-3.582 8-8 8H40c-4.418 0-8-3.582-8-8V52z" fill="#ffffff" opacity="0.95" />
                                <path d="M36 50l28 22 28-22" fill="none" stroke="#764ba2" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M50 78l14 12 14-12" fill="none" stroke="#764ba2" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M48 38c0-6.627 5.373-12 12-12h8c6.627 0 12 5.373 12 12" fill="none" stroke="#ffffff" stroke-width="4" stroke-linecap="round" />
                                <circle cx="92" cy="40" r="10" fill="#27ae60" stroke="#ffffff" stroke-width="4" />
                                <path d="M88 40l3 3 5-6" fill="none" stroke="#ffffff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
                            </g>
                        </svg>
                    </div>
                    <div class="brand-copy">
                        <h1>ğŸ“¬ é€šçŸ¥å®šæ—¶å‘é€ç³»ç»Ÿ</h1>
                        <p>æ”¯æŒå¤šæ¸ é“å®šæ—¶å‘é€é€šçŸ¥ï¼Œè®©æ‚¨çš„æ¶ˆæ¯å‡†æ—¶åˆ°è¾¾</p>
                    </div>
                </div>
                <div class="user-info">
                    <span>ğŸ‘¤ <span id="currentUsername"></span></span>
                    <button class="logout-btn" onclick="logout()">é€€å‡º</button>
                </div>
            </header>

            <div class="mobile-tabs" role="tablist" aria-label="ç§»åŠ¨ç«¯è§†å›¾åˆ‡æ¢">
                <button type="button" class="mobile-tab active" data-target="form" aria-pressed="true">åˆ›å»ºä»»åŠ¡</button>
                <button type="button" class="mobile-tab" data-target="list" aria-pressed="false">ä»»åŠ¡åˆ—è¡¨</button>
            </div>

            <div class="main-content">
                <!-- åˆ›å»ºä»»åŠ¡è¡¨å• -->
                <div class="card card-section active" data-section="form">
                    <h2>åˆ›å»ºé€šçŸ¥ä»»åŠ¡</h2>
                    <form id="taskForm">
                        <div class="form-group">
                            <label for="title">é€šçŸ¥æ ‡é¢˜ *</label>
                            <input type="text" id="title" name="title" placeholder="è¯·è¾“å…¥é€šçŸ¥æ ‡é¢˜" required>
                        </div>

                        <div class="form-group">
                            <label for="content">é€šçŸ¥å†…å®¹ *</label>
                            <textarea id="content" name="content" placeholder="è¯·è¾“å…¥é€šçŸ¥å†…å®¹" required></textarea>
                        </div>

                        <div class="form-group">
                            <label for="channel">é€šçŸ¥æ¸ é“ *</label>
                            <select id="channel" name="channel" required>
                                <option value="">è¯·é€‰æ‹©é€šçŸ¥æ¸ é“</option>
                            </select>
                        </div>

                        <div id="configFields" class="config-fields" style="display: none;">
                            <!-- åŠ¨æ€ç”Ÿæˆé…ç½®å­—æ®µ -->
                        </div>

                        <!-- æµ‹è¯•é€šçŸ¥æŒ‰é’® -->
                        <div id="testNotificationSection" class="form-group" style="display: none;">
                            <button type="button" class="btn btn-info" onclick="testNotification()" style="width: 100%;">
                                ğŸ§ª æµ‹è¯•é€šçŸ¥å‘é€
                            </button>
                            <div id="testNotificationResult" style="margin-top: 10px;"></div>
                        </div>

                        <div class="form-group">
                            <label for="scheduledTime">è®¡åˆ’å‘é€æ—¶é—´ *</label>
                            <input type="datetime-local" id="scheduledTime" name="scheduledTime" required>
                        </div>

                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="isRecurring" name="isRecurring">
                                <label for="isRecurring" style="margin-bottom: 0;">é‡å¤ä»»åŠ¡</label>
                            </div>
                        </div>

                        <div class="form-group" id="cronGroup" style="display: none;">
                            <label for="cronExpression">Cron è¡¨è¾¾å¼</label>
                            <input type="text" id="cronExpression" name="cronExpression" placeholder="å¦‚: 0 9 * * * (æ¯å¤©9ç‚¹)">
                            <small style="color: var(--text-muted); display: block; margin-top: 5px;">
                                ç¤ºä¾‹: 0 9 * * * (æ¯å¤©9ç‚¹) | 0 */2 * * * (æ¯2å°æ—¶) | 0 9 * * 1 (æ¯å‘¨ä¸€9ç‚¹)
                            </small>
                        </div>

                        <button type="submit" class="btn btn-primary">åˆ›å»ºä»»åŠ¡</button>
                    </form>

                    <!-- æ¸ é“ç®¡ç† -->
                    <div class="channel-management">
                        <h3 style="margin-top: 30px; margin-bottom: 15px; color: var(--text-strong); font-size: 1.2rem;">æˆ‘çš„é€šçŸ¥æ¸ é“</h3>
                        <button class="btn btn-sm btn-info" onclick="openChannelModal()">æ·»åŠ æ¸ é“</button>
                        <div id="userChannels" class="channel-list">
                            <!-- åŠ¨æ€ç”Ÿæˆç”¨æˆ·æ¸ é“åˆ—è¡¨ -->
                        </div>
                    </div>
                </div>

                <!-- ä»»åŠ¡åˆ—è¡¨ -->
                <div class="card card-section active" data-section="list">
                    <h2>ä»»åŠ¡åˆ—è¡¨</h2>
                    <div class="filter-bar">
                        <select id="statusFilter">
                            <option value="">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="pending" selected>å¾…å‘é€</option>
                            <option value="sent">å·²å‘é€</option>
                            <option value="failed">å‘é€å¤±è´¥</option>
                            <option value="cancelled">å·²å–æ¶ˆ</option>
                        </select>
                        <select id="recurringFilter">
                            <option value="">å…¨éƒ¨ä»»åŠ¡</option>
                            <option value="recurring">é‡å¤ä»»åŠ¡</option>
                            <option value="non_recurring">ä¸€æ¬¡æ€§ä»»åŠ¡</option>
                        </select>
                        <select id="sortField">
                            <option value="scheduled_time" selected>æŒ‰è®¡åˆ’æ—¶é—´</option>
                            <option value="id">æŒ‰ä»»åŠ¡ID</option>
                            <option value="status">æŒ‰ä»»åŠ¡çŠ¶æ€</option>
                            <option value="created_at">æŒ‰åˆ›å»ºæ—¶é—´</option>
                        </select>
                        <select id="sortOrder">
                            <option value="asc" selected>å‡åº</option>
                            <option value="desc">é™åº</option>
                        </select>
                        <button class="btn btn-info btn-sm" onclick="loadTasks()">åˆ·æ–°</button>
                    </div>
                    <div id="taskList" class="task-list">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>åŠ è½½ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- äºŒæ¬¡ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="confirm-icon">âš ï¸</div>
            <h3 id="confirmTitle">ç¡®è®¤æ“ä½œ</h3>
            <p id="confirmMessage" class="confirm-message">ç¡®è®¤è¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
            <div class="confirm-actions">
                <button id="confirmCancelBtn" class="btn btn-sm btn-ghost">å†æƒ³æƒ³</button>
                <button id="confirmOkBtn" class="btn btn-sm btn-danger">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <!-- æ¸ é“é…ç½®æ¨¡æ€æ¡† -->
    <div id="channelModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeChannelModal()">&times;</span>
            <h2>æ·»åŠ é€šçŸ¥æ¸ é“</h2>
            <form id="channelForm">
                <input type="hidden" id="editingChannelId" value="">
                <div class="form-group">
                    <label for="channelName">æ¸ é“åç§° *</label>
                    <input type="text" id="channelName" name="channelName" required placeholder="å¦‚ï¼šä¼ä¸šå¾®ä¿¡é€šçŸ¥">
                </div>

                <div class="form-group">
                    <label for="channelType">æ¸ é“ç±»å‹ *</label>
                    <select id="channelType" name="channelType" required>
                        <option value="">è¯·é€‰æ‹©æ¸ é“ç±»å‹</option>
                    </select>
                </div>

                <div id="channelConfigFields" class="config-fields">
                    <!-- åŠ¨æ€ç”Ÿæˆé…ç½®å­—æ®µ -->
                </div>

                <!-- æµ‹è¯•é€šçŸ¥æŒ‰é’® -->
                <div id="channelTestNotificationSection" class="form-group" style="display: none;">
                    <button type="button" class="btn btn-info" onclick="testChannelNotification()" style="width: 100%;">
                        ğŸ§ª æµ‹è¯•é€šçŸ¥å‘é€
                    </button>
                    <div id="channelTestNotificationResult" style="margin-top: 10px;"></div>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="isDefaultChannel" name="isDefault">
                        <label for="isDefaultChannel" style="margin-bottom: 0;">è®¾ä¸ºé»˜è®¤æ¸ é“</label>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">æ·»åŠ æ¸ é“</button>
            </form>
        </div>
    </div>

    <!-- ä»»åŠ¡ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="editTaskModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditTaskModal()">&times;</span>
            <h2>ç¼–è¾‘ä»»åŠ¡</h2>
            <form id="editTaskForm">
                <input type="hidden" id="editTaskId" name="taskId">

                <div class="form-group">
                    <label for="editTitle">é€šçŸ¥æ ‡é¢˜ *</label>
                    <input type="text" id="editTitle" name="title" placeholder="è¯·è¾“å…¥é€šçŸ¥æ ‡é¢˜" required>
                </div>

                <div class="form-group">
                    <label for="editContent">é€šçŸ¥å†…å®¹ *</label>
                    <textarea id="editContent" name="content" placeholder="è¯·è¾“å…¥é€šçŸ¥å†…å®¹" required></textarea>
                </div>

                <div class="form-group">
                    <label>é€šçŸ¥æ¸ é“</label>
                    <select id="editChannel" disabled>
                        <option value="">æ¸ é“å·²ç¡®å®šï¼Œä¸å¯æ›´æ”¹</option>
                    </select>
                    <div class="warning-hint">
                        âš ï¸ å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œç¼–è¾‘ä»»åŠ¡æ—¶ä¸èƒ½æ›´æ”¹é€šçŸ¥æ¸ é“
                    </div>
                </div>

                <div id="editConfigFields" class="config-fields" style="display: none;">
                    <!-- åŠ¨æ€ç”Ÿæˆé…ç½®å­—æ®µ -->
                </div>

                <div class="form-group">
                    <label for="editScheduledTime">è®¡åˆ’å‘é€æ—¶é—´ *</label>
                    <input type="datetime-local" id="editScheduledTime" name="scheduledTime" required>
                </div>

                <div class="form-group">
                    <label>é‡å¤ä»»åŠ¡è®¾ç½®</label>
                    <div class="checkbox-group">
                        <input type="checkbox" id="editIsRecurring" name="isRecurring" disabled>
                        <label for="editIsRecurring" style="margin-bottom: 0;">é‡å¤ä»»åŠ¡ï¼ˆä¸å¯ä¿®æ”¹ï¼‰</label>
                    </div>
                    <div class="warning-hint">
                        âš ï¸ é‡å¤ä»»åŠ¡è®¾ç½®ä¸å¯æ›´æ”¹ï¼Œå¦‚éœ€ä¿®æ”¹è¯·åˆ›å»ºæ–°ä»»åŠ¡
                    </div>
                </div>

                <div id="editCronGroup" class="form-group" style="display: none;">
                    <label for="editCronExpression">Cron è¡¨è¾¾å¼</label>
                    <input type="text" id="editCronExpression" name="cronExpression" readonly style="background: #f5f5f5;">
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">ä¿å­˜ä¿®æ”¹</button>
                    <button type="button" class="btn btn-danger" onclick="closeEditTaskModal()" style="flex: 1;">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let channels = [];
        let currentUser = null;
        let userChannels = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
        });

        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        async function checkAuthStatus() {
            const token = localStorage.getItem('token');
            if (!token) {
                showLoginPage();
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    showMainApp();
                } else {
                    localStorage.removeItem('token');
                    showLoginPage();
                }
            } catch (error) {
                localStorage.removeItem('token');
                showLoginPage();
            }
        }

        // æ˜¾ç¤ºç™»å½•é¡µé¢
        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            initLoginEvents();
        }

        // æ˜¾ç¤ºä¸»åº”ç”¨
        function showMainApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('currentUsername').textContent = currentUser.username;
            loadChannels();
            loadUserChannels();
            loadTasks();
            initAppEvents();
            setDefaultTime();
        }

        // åˆ‡æ¢ç™»å½•/æ³¨å†Œæ ‡ç­¾
        function switchTab(tab) {
            const tabs = document.querySelectorAll('.login-tab');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));

            if (tab === 'login') {
                tabs[0].classList.add('active');
                document.getElementById('loginTab').classList.add('active');
            } else {
                tabs[1].classList.add('active');
                document.getElementById('registerTab').classList.add('active');
            }
        }

        // åˆå§‹åŒ–ç™»å½•äº‹ä»¶
        function initLoginEvents() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
        }

        // å¤„ç†ç™»å½•
        async function handleLogin(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const loginData = {
                username: formData.get('username'),
                password: formData.get('password')
            };

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(loginData)
                });

                const result = await response.json();

                if (response.ok) {
                    localStorage.setItem('token', result.data.token);
                    currentUser = result.data.user;
                    showMainApp();
                    showNotification('ç™»å½•æˆåŠŸï¼', 'success');
                } else {
                    showNotification(result.error, 'error');
                }
            } catch (error) {
                showNotification('ç™»å½•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¤„ç†æ³¨å†Œ
        async function handleRegister(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const registerData = {
                username: formData.get('username'),
                email: formData.get('email'),
                password: formData.get('password')
            };

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(registerData)
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•', 'success');
                    switchTab('login');
                    e.target.reset();
                } else {
                    showNotification(result.error, 'error');
                }
            } catch (error) {
                showNotification('æ³¨å†Œå¤±è´¥: ' + error.message, 'error');
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('token');
            currentUser = null;
            checkAuthStatus();
        }

        // åˆå§‹åŒ–åº”ç”¨äº‹ä»¶
        function initAppEvents() {
            document.getElementById('taskForm').addEventListener('submit', submitTaskForm);
            document.getElementById('channel').addEventListener('change', onChannelChange);
            document.getElementById('statusFilter').addEventListener('change', loadTasks);
            const recurringFilterEl = document.getElementById('recurringFilter');
            if (recurringFilterEl) recurringFilterEl.addEventListener('change', loadTasks);
            document.getElementById('sortField').addEventListener('change', loadTasks);
            document.getElementById('sortOrder').addEventListener('change', loadTasks);
            document.getElementById('isRecurring').addEventListener('change', function() {
                document.getElementById('cronGroup').style.display = this.checked ? 'block' : 'none';

                // å‹¾é€‰é‡å¤ä»»åŠ¡æ—¶ï¼šä¸å¯å†è®¾ç½®è®¡åˆ’å‘é€æ—¶é—´
                const scheduledTimeInput = document.getElementById('scheduledTime');
                if (scheduledTimeInput) {
                    if (this.checked) {
                        scheduledTimeInput.disabled = true;
                        scheduledTimeInput.removeAttribute('required');
                        scheduledTimeInput.value = '';
                    } else {
                        scheduledTimeInput.disabled = false;
                        scheduledTimeInput.setAttribute('required', 'required');
                        // æ¢å¤é»˜è®¤æ—¶é—´
                        setDefaultTime();
                    }
                }
            });
            // æ¸ é“è¡¨å•æäº¤ä¸ç±»å‹å˜æ›´ç›‘å¬ï¼ˆç»‘å®šä¸€æ¬¡ï¼‰
            const channelForm = document.getElementById('channelForm');
            if (channelForm && !channelForm._bound) {
                channelForm.addEventListener('submit', handleChannelFormSubmit);
                channelForm._bound = true;
            }
            const channelTypeSel = document.getElementById('channelType');
            if (channelTypeSel && !channelTypeSel._bound) {
                channelTypeSel.addEventListener('change', onChannelTypeChange);
                channelTypeSel._bound = true;
            }
        }

        // åŠ è½½é€šçŸ¥æ¸ é“ç±»å‹
        async function loadChannels() {
            try {
                const response = await fetch(`${API_BASE}/channels`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const data = await response.json();
                channels = data.channels;

                // å¡«å……ä»»åŠ¡è¡¨å•ä¸­çš„æ¸ é“é€‰æ‹©
                const taskChannelSelect = document.getElementById('channel');
                channels.forEach(channel => {
                    const option = document.createElement('option');
                    option.value = channel.value;
                    option.textContent = channel.label;
                    option.dataset.fields = JSON.stringify(channel.config_fields);
                    taskChannelSelect.appendChild(option);
                });

                // å¡«å……æ¸ é“æ¨¡æ€æ¡†ä¸­çš„æ¸ é“ç±»å‹é€‰æ‹©
                const modalChannelSelect = document.getElementById('channelType');
                channels.forEach(channel => {
                    const option = document.createElement('option');
                    option.value = channel.value;
                    option.textContent = channel.label;
                    option.dataset.fields = JSON.stringify(channel.config_fields);
                    modalChannelSelect.appendChild(option);
                });
            } catch (error) {
                showNotification('åŠ è½½æ¸ é“å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½ç”¨æˆ·ä¸“å±æ¸ é“
        async function loadUserChannels() {
            try {
                const response = await fetch(`${API_BASE}/user/channels`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const data = await response.json();
                userChannels = data.channels;

                renderUserChannels();
            } catch (error) {
                showNotification('åŠ è½½ç”¨æˆ·æ¸ é“å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ¸²æŸ“ç”¨æˆ·æ¸ é“åˆ—è¡¨
        function renderUserChannels() {
            const container = document.getElementById('userChannels');
            if (userChannels.length === 0) {
                container.innerHTML = '<div class="empty-state"><i>ğŸ“­</i><p>æš‚æ— æ¸ é“é…ç½®</p></div>';
                return;
            }

            container.innerHTML = '';
            userChannels.forEach(channel => {
                const channelItem = document.createElement('div');
                channelItem.className = 'channel-item';

                const channelTypeLabel = channels.find(c => c.value === channel.channel_type)?.label || channel.channel_type;

                channelItem.innerHTML = `
                    <div class="channel-info">
                        <div class="channel-name">${channel.channel_name} ${channel.is_default ? '(é»˜è®¤)' : ''}</div>
                        <div class="channel-type">${channelTypeLabel}</div>
                    </div>
                    <div class="channel-actions">
                        <button class="btn btn-sm btn-info" onclick="editUserChannel(${channel.id})">ç¼–è¾‘</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUserChannel(${channel.id})">åˆ é™¤</button>
                    </div>
                `;
                container.appendChild(channelItem);
            });
        }

        // æ‰“å¼€æ¸ é“é…ç½®æ¨¡æ€æ¡†
        function openChannelModal() {
            // ä»¥åˆ›å»ºæ¨¡å¼æ‰“å¼€æ¨¡æ€æ¡†
            document.getElementById('editingChannelId').value = '';
            document.getElementById('channelModal').style.display = 'block';
            document.getElementById('channelForm').reset();
            document.getElementById('channelConfigFields').innerHTML = '';
            document.getElementById('channelType').disabled = false;
            // éšè—æµ‹è¯•æŒ‰é’®å’Œæ¸…ç©ºæµ‹è¯•ç»“æœ
            document.getElementById('channelTestNotificationSection').style.display = 'none';
            document.getElementById('channelTestNotificationResult').innerHTML = '';
            // è®¾ç½®æ ‡é¢˜ä¸º"æ·»åŠ é€šçŸ¥æ¸ é“"
            const title = document.querySelector('#channelModal .modal-content h2');
            if (title) title.textContent = 'æ·»åŠ é€šçŸ¥æ¸ é“';
        }

        // å…³é—­æ¸ é“é…ç½®æ¨¡æ€æ¡†
        function closeChannelModal() {
            document.getElementById('channelModal').style.display = 'none';
            document.getElementById('channelForm').reset();
            document.getElementById('channelConfigFields').innerHTML = '';
            document.getElementById('editingChannelId').value = '';
            document.getElementById('channelType').disabled = false;
            // éšè—æµ‹è¯•æŒ‰é’®å’Œæ¸…ç©ºæµ‹è¯•ç»“æœ
            document.getElementById('channelTestNotificationSection').style.display = 'none';
            document.getElementById('channelTestNotificationResult').innerHTML = '';
        }

        // æ¸ é“ç±»å‹æ”¹å˜æ—¶æ›´æ–°é…ç½®å­—æ®µ
        function onChannelTypeChange() {
            const channelSelect = document.getElementById('channelType');
            const selectedOption = channelSelect.options[channelSelect.selectedIndex];
            const configFieldsDiv = document.getElementById('channelConfigFields');
            const testSection = document.getElementById('channelTestNotificationSection');
            const testResultDiv = document.getElementById('channelTestNotificationResult');

            if (!selectedOption.value) {
                configFieldsDiv.innerHTML = '';
                testSection.style.display = 'none';
                testResultDiv.innerHTML = '';
                return;
            }

            const fields = JSON.parse(selectedOption.dataset.fields || '[]');
            configFieldsDiv.innerHTML = '';

            fields.forEach(field => {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';

                const label = document.createElement('label');
                label.textContent = getFieldLabel(field);
                formGroup.appendChild(label);

                const input = document.createElement('input');
                input.type = field.includes('token') || field.includes('secret') ? 'password' : 'text';
                input.id = `channelConfig_${field}`;
                input.name = field;
                input.placeholder = `è¯·è¾“å…¥${getFieldLabel(field)}`;
                input.required = true;
                formGroup.appendChild(input);

                configFieldsDiv.appendChild(formGroup);
            });

            // æ˜¾ç¤ºæµ‹è¯•æŒ‰é’®
            testSection.style.display = 'block';
            testResultDiv.innerHTML = '';
        }

        // å¤„ç†æ¸ é“è¡¨å•ï¼ˆåˆ›å»ºæˆ–ç¼–è¾‘ï¼‰
        async function handleChannelFormSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const editingId = document.getElementById('editingChannelId').value;
            const channelSelect = document.getElementById('channelType');
            const selectedOption = channelSelect.options[channelSelect.selectedIndex];
            const configFields = JSON.parse(selectedOption?.dataset?.fields || '[]');

            // æ„å»ºé…ç½®å¯¹è±¡
            const channelConfig = {};
            configFields.forEach(field => {
                const el = document.getElementById(`channelConfig_${field}`) || document.getElementById(`editConfig_${field}`) || document.getElementById(`config_${field}`);
                const value = el ? el.value : '';
                channelConfig[field] = value;
            });

            const commonData = {
                channel_name: formData.get('channelName'),
                channel_config: channelConfig,
                is_default: formData.get('isDefault') === 'on'
            };

            try {
                let response;
                if (!editingId) {
                    // åˆ›å»º
                    const postData = Object.assign({}, commonData, { channel_type: formData.get('channelType') });
                    response = await fetch(`${API_BASE}/user/channels`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify(postData)
                    });
                } else {
                    // ç¼–è¾‘ï¼ˆåªå…è®¸ä¿®æ”¹åç§°ã€é…ç½®ã€æ˜¯å¦é»˜è®¤ï¼‰
                    response = await fetch(`${API_BASE}/user/channels/${editingId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify(commonData)
                    });
                }

                const result = await response.json();

                if (response.ok) {
                    showNotification(editingId ? 'æ¸ é“æ›´æ–°æˆåŠŸï¼' : 'æ¸ é“åˆ›å»ºæˆåŠŸï¼', 'success');
                    closeChannelModal();
                    loadUserChannels();
                } else {
                    showNotification(result.error || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                showNotification('æ“ä½œå¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ é™¤ç”¨æˆ·æ¸ é“
        async function deleteUserChannel(channelId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¸ é“é…ç½®å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/user/channels/${channelId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification('æ¸ é“åˆ é™¤æˆåŠŸ', 'success');
                    loadUserChannels();
                } else {
                    showNotification(result.error, 'error');
                }
            } catch ( error) {
                showNotification('åˆ é™¤æ¸ é“å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ç¼–è¾‘ç”¨æˆ·æ¸ é“ï¼ˆæ‰“å¼€æ¨¡æ€æ¡†å¹¶å¡«å……æ•°æ®ï¼‰
        function editUserChannel(channelId) {
            const channel = userChannels.find(uc => uc.id == channelId);
            if (!channel) {
                showNotification('æ¸ é“ä¸å­˜åœ¨', 'error');
                return;
            }

            document.getElementById('editingChannelId').value = channel.id;
            document.getElementById('channelModal').style.display = 'block';
            // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜
            const title = document.querySelector('#channelModal .modal-content h2');
            if (title) title.textContent = 'ç¼–è¾‘é€šçŸ¥æ¸ é“';

            // å¡«å……åŸºæœ¬ä¿¡æ¯
            document.getElementById('channelName').value = channel.channel_name || '';
            const channelTypeSel = document.getElementById('channelType');
            channelTypeSel.value = channel.channel_type;
            channelTypeSel.disabled = true; // ä¸å…è®¸ä¿®æ”¹æ¸ é“ç±»å‹

            // è§¦å‘ç”Ÿæˆé…ç½®å­—æ®µ
            onChannelTypeChange();

            // å¡«å……é…ç½®å­—æ®µ
            const selectedOption = channelTypeSel.options[channelTypeSel.selectedIndex];
            const fields = JSON.parse(selectedOption.dataset.fields || '[]');
            const cfg = channel.channel_config || {};
            fields.forEach(field => {
                const input = document.getElementById(`channelConfig_${field}`);
                if (input) input.value = cfg[field] || '';
            });

            // å¡«å……é»˜è®¤æ¸ é“é€‰é¡¹
            document.getElementById('isDefaultChannel').checked = !!channel.is_default;
        }

        // æ¸ é“æ”¹å˜æ—¶æ›´æ–°é…ç½®å­—æ®µ
        function onChannelChange() {
            const channelSelect = document.getElementById('channel');
            const selectedOption = channelSelect.options[channelSelect.selectedIndex];
            const configFieldsDiv = document.getElementById('configFields');
            const testNotificationSection = document.getElementById('testNotificationSection');

            if (!selectedOption || !selectedOption.value) {
                configFieldsDiv.style.display = 'none';
                testNotificationSection.style.display = 'none';
                return;
            }

            const fields = JSON.parse(selectedOption.dataset.fields || '[]');
            configFieldsDiv.innerHTML = '';

            // å…ˆæ˜¾ç¤ºç”¨æˆ·å·²ä¿å­˜çš„æ¸ é“é€‰é¡¹
            const userChannelSelect = document.createElement('select');
            userChannelSelect.id = 'userChannelSelect';
            userChannelSelect.className = 'user-channel-select';

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'é€‰æ‹©å·²ä¿å­˜çš„æ¸ é“ï¼ˆå¯é€‰ï¼‰';
            userChannelSelect.appendChild(defaultOption);

            userChannels.forEach(userChannel => {
                if (userChannel.channel_type === selectedOption.value) {
                    const option = document.createElement('option');
                    option.value = userChannel.id;
                    option.textContent = `${userChannel.channel_name} ${userChannel.is_default ? '(é»˜è®¤)' : ''}`;
                    userChannelSelect.appendChild(option);
                }
            });

            if (userChannels.some(uc => uc.channel_type === selectedOption.value)) {
                configFieldsDiv.appendChild(userChannelSelect);
            }

            fields.forEach(field => {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';

                const label = document.createElement('label');
                label.textContent = getFieldLabel(field);
                formGroup.appendChild(label);

                const input = document.createElement('input');
                input.type = field.includes('token') || field.includes('secret') ? 'password' : 'text';
                input.id = `config_${field}`;
                input.name = field;
                input.placeholder = `è¯·è¾“å…¥${getFieldLabel(field)}`;
                formGroup.appendChild(input);

                configFieldsDiv.appendChild(formGroup);
            });

            configFieldsDiv.style.display = 'block';

            // æ˜¾ç¤ºæµ‹è¯•é€šçŸ¥æŒ‰é’®
            document.getElementById('testNotificationSection').style.display = 'block';

            // è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®ç”¨æˆ·æ¸ é“IDå¡«å……é…ç½®å­—æ®µ
            function populateFromUserChannel(selectedChannelId) {
                if (!selectedChannelId) return;
                const selectedChannel = userChannels.find(uc => uc.id == selectedChannelId);
                if (selectedChannel) {
                    const config = selectedChannel.channel_config || {};
                    fields.forEach(field => {
                        const input = document.getElementById(`config_${field}`);
                        if (input) input.value = config[field] || '';
                    });
                }
            }

            // ç›‘å¬ç”¨æˆ·æ¸ é“é€‰æ‹©
            userChannelSelect.addEventListener('change', function() {
                const selectedChannelId = this.value;
                if (selectedChannelId) {
                    populateFromUserChannel(selectedChannelId);
                }
            });

            // è‡ªåŠ¨é€‰ä¸­å¹¶åŠ è½½â€œé»˜è®¤â€æ¸ é“ï¼ˆè‹¥å­˜åœ¨ï¼‰ï¼Œè‹¥æ— é»˜è®¤ä½†åªæœ‰ä¸€æ¡å·²ä¿å­˜é…ç½®ä¹Ÿè‡ªåŠ¨åŠ è½½
            const defaultSaved = userChannels.find(uc => uc.channel_type === selectedOption.value && uc.is_default);
            if (defaultSaved) {
                userChannelSelect.value = defaultSaved.id;
                populateFromUserChannel(defaultSaved.id);
            } else {
                const savedForType = userChannels.filter(uc => uc.channel_type === selectedOption.value);
                if (savedForType.length === 1) {
                    userChannelSelect.value = savedForType[0].id;
                    populateFromUserChannel(savedForType[0].id);
                }
            }
        }

        // æµ‹è¯•é€šçŸ¥å‘é€
        async function testNotification() {
            const channelSelect = document.getElementById('channel');
            const selectedOption = channelSelect.options[channelSelect.selectedIndex];
            const resultDiv = document.getElementById('testNotificationResult');

            if (!selectedOption || !selectedOption.value) {
                showNotification('è¯·å…ˆé€‰æ‹©é€šçŸ¥æ¸ é“', 'error');
                return;
            }

            const channel = selectedOption.value;
            const fields = JSON.parse(selectedOption.dataset.fields || '[]');

            // æ„å»ºé…ç½®å¯¹è±¡
            const channelConfig = {};
            let hasEmptyField = false;

            fields.forEach(field => {
                const input = document.getElementById(`config_${field}`);
                const value = input ? input.value : '';
                if (!value) {
                    hasEmptyField = true;
                }
                channelConfig[field] = value;
            });

            if (hasEmptyField) {
                showNotification('è¯·å…ˆå¡«å†™å®Œæ•´çš„æ¸ é“é…ç½®', 'error');
                return;
            }

            // è·å–æ ‡é¢˜å’Œå†…å®¹ï¼ˆå¯é€‰ï¼‰
            const title = document.getElementById('title').value || undefined;
            const content = document.getElementById('content').value || undefined;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            resultDiv.innerHTML = '<div class="loading" style="padding: 10px;"><div class="spinner" style="width: 24px; height: 24px; margin: 0 auto 8px;"></div><p style="margin: 0; font-size: 0.9rem;">æ­£åœ¨å‘é€æµ‹è¯•é€šçŸ¥...</p></div>';

            try {
                const response = await fetch(`${API_BASE}/test-notification`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        channel: channel,
                        channel_config: channelConfig,
                        title: title,
                        content: content
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    resultDiv.innerHTML = `
                        <div style="background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 12px; color: #047857;">
                            âœ… ${result.message}
                        </div>
                    `;
                    showNotification(result.message, 'success');
                } else {
                    const errorMsg = result.error || result.message || 'æµ‹è¯•å¤±è´¥';
                    resultDiv.innerHTML = `
                        <div style="background: rgba(248, 113, 113, 0.18); border: 1px solid rgba(248, 113, 113, 0.3); border-radius: 12px; padding: 12px; color: #b91c1c;">
                            âŒ ${errorMsg}
                        </div>
                    `;
                    showNotification(errorMsg, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="background: rgba(248, 113, 113, 0.18); border: 1px solid rgba(248, 113, 113, 0.3); border-radius: 12px; padding: 12px; color: #b91c1c;">
                        âŒ è¯·æ±‚å¤±è´¥: ${error.message}
                    </div>
                `;
                showNotification('æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•æ¸ é“é…ç½®é€šçŸ¥å‘é€
        async function testChannelNotification() {
            const channelSelect = document.getElementById('channelType');
            const selectedOption = channelSelect.options[channelSelect.selectedIndex];
            const resultDiv = document.getElementById('channelTestNotificationResult');

            if (!selectedOption || !selectedOption.value) {
                showNotification('è¯·å…ˆé€‰æ‹©æ¸ é“ç±»å‹', 'error');
                return;
            }

            const channel = selectedOption.value;
            const fields = JSON.parse(selectedOption.dataset.fields || '[]');

            // æ„å»ºé…ç½®å¯¹è±¡
            const channelConfig = {};
            let hasEmptyField = false;

            fields.forEach(field => {
                const input = document.getElementById(`channelConfig_${field}`);
                const value = input ? input.value : '';
                if (!value) {
                    hasEmptyField = true;
                }
                channelConfig[field] = value;
            });

            if (hasEmptyField) {
                showNotification('è¯·å…ˆå¡«å†™å®Œæ•´çš„æ¸ é“é…ç½®', 'error');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            resultDiv.innerHTML = '<div class="loading" style="padding: 10px;"><div class="spinner" style="width: 24px; height: 24px; margin: 0 auto 8px;"></div><p style="margin: 0; font-size: 0.9rem;">æ­£åœ¨å‘é€æµ‹è¯•é€šçŸ¥...</p></div>';

            try {
                const response = await fetch(`${API_BASE}/test-notification`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        channel: channel,
                        channel_config: channelConfig
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    resultDiv.innerHTML = `
                        <div style="background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 12px; color: #047857;">
                            âœ… ${result.message}
                        </div>
                    `;
                    showNotification(result.message, 'success');
                } else {
                    const errorMsg = result.error || result.message || 'æµ‹è¯•å¤±è´¥';
                    resultDiv.innerHTML = `
                        <div style="background: rgba(248, 113, 113, 0.18); border: 1px solid rgba(248, 113, 113, 0.3); border-radius: 12px; padding: 12px; color: #b91c1c;">
                            âŒ ${errorMsg}
                        </div>
                    `;
                    showNotification(errorMsg, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="background: rgba(248, 113, 113, 0.18); border: 1px solid rgba(248, 113, 113, 0.3); border-radius: 12px; padding: 12px; color: #b91c1c;">
                        âŒ è¯·æ±‚å¤±è´¥: ${error.message}
                    </div>
                `;
                showNotification('æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // è·å–å­—æ®µä¸­æ–‡æ ‡ç­¾
        function getFieldLabel(field) {
            const labels = {
                'corpid': 'ä¼ä¸šID',
                'corpsecret': 'åº”ç”¨Secret',
                'agentid': 'åº”ç”¨ID',
                'webhook_url': 'Webhook URL',
                'appid': 'åº”ç”¨ID',
                'appsecret': 'åº”ç”¨Secret',
                'receiver_type': 'æ¥æ”¶è€…ç±»å‹',
                'receiver_id': 'æ¥æ”¶è€…ID',
                'token': 'Token'
            };
            return labels[field] || field;
        }

        // å°† cron è¡¨è¾¾å¼ä¸­çš„æ˜ŸæœŸæ•°å­—ä» Sunday-first (0=Sun) è½¬æ¢ä¸º Monday-first (0=Mon)
        // è½¬æ¢è§„åˆ™ï¼šnew = (old + 6) % 7
        function convertCronExpressionForBackend(expr) {
            if (!expr || typeof expr !== 'string') return expr;
            const parts = expr.trim().split(/\s+/);
            if (parts.length < 5) return expr; // éæ ‡å‡† 5 å­—æ®µ cronï¼Œç›´æ¥è¿”å›åŸæ ·
            // æ˜ŸæœŸå­—æ®µé€šå¸¸æ˜¯æœ€åä¸€é¡¹ï¼ˆæ”¯æŒ 5+ å­—æ®µæ—¶å–æœ€åä¸€é¡¹ï¼‰
            const idx = parts.length - 1;
            parts[idx] = parts[idx].replace(/\b[0-6]\b/g, (m) => {
                const n = parseInt(m, 10);
                return String((n + 6) % 7);
            });
            return parts.join(' ');
        }

        // åŠ è½½ä»»åŠ¡åˆ—è¡¨
        async function loadTasks() {
            const taskList = document.getElementById('taskList');
            const statusFilter = document.getElementById('statusFilter').value;
            const recurringFilterEl = document.getElementById('recurringFilter');
            const recurringFilter = recurringFilterEl ? recurringFilterEl.value : '';
            const sortFieldSelect = document.getElementById('sortField');
            const sortOrderSelect = document.getElementById('sortOrder');
            const sortField = sortFieldSelect ? sortFieldSelect.value : 'scheduled_time';
            const sortOrder = sortOrderSelect ? sortOrderSelect.value : 'asc';

            taskList.innerHTML = '<div class="loading"><div class="spinner"></div><p>åŠ è½½ä¸­...</p></div>';

            try {
                const params = new URLSearchParams({ page_size: '100' });
                if (statusFilter) params.append('status', statusFilter);
                if (sortField) params.append('sort_by', sortField);
                if (sortOrder) params.append('sort_order', sortOrder.toLowerCase());

                const response = await fetch(`${API_BASE}/tasks?${params.toString()}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const data = await response.json();

                if (data.tasks && data.tasks.length > 0) {
                    taskList.innerHTML = '';
                    let tasks = data.tasks;
                    // å‰ç«¯ç­›é€‰é‡å¤ä»»åŠ¡ï¼ˆåç«¯æš‚ä¸æ”¯æŒè¯¥ query å‚æ•°ï¼‰
                    if (recurringFilter === 'recurring') {
                        tasks = tasks.filter(t => !!t.is_recurring);
                    } else if (recurringFilter === 'non_recurring') {
                        tasks = tasks.filter(t => !t.is_recurring);
                    }

                    if (tasks.length > 0) {
                        tasks.forEach(task => taskList.appendChild(createTaskElement(task)));
                    } else {
                        taskList.innerHTML = '<div class="empty-state"><i>ğŸ“­</i><p>æš‚æ— ä»»åŠ¡</p></div>';
                    }
                } else {
                    taskList.innerHTML = '<div class="empty-state"><i>ğŸ“­</i><p>æš‚æ— ä»»åŠ¡</p></div>';
                }
            } catch (error) {
                taskList.innerHTML = '<div class="empty-state"><i>âŒ</i><p>åŠ è½½å¤±è´¥: ' + error.message + '</p></div>';
            }
        }

        // åˆ›å»ºä»»åŠ¡å…ƒç´ 
        function createTaskElement(task) {
            const div = document.createElement('div');
            div.className = 'task-item';
            if (task.is_recurring) div.classList.add('recurring');

            // æ ‡è®°è¿‡æœŸä»»åŠ¡ï¼šçŠ¶æ€ä¸º pending ä¸”è®¡åˆ’æ—¶é—´æ—©äºå½“å‰æ—¶é—´
            let isExpired = false;
            try {
                const scheduled = task.scheduled_time ? new Date(task.scheduled_time) : null;
                const now = new Date();
                if (task.status === 'pending' && scheduled && scheduled < now) {
                    div.classList.add('expired');
                    isExpired = true;
                }
            } catch (e) {
                // å¿½ç•¥è§£æé”™è¯¯
            }

            const statusClass = `status-${task.status}`;
            const statusText = {
                'pending': 'å¾…å‘é€',
                'sent': 'å·²å‘é€',
                'failed': 'å‘é€å¤±è´¥',
                'cancelled': 'å·²å–æ¶ˆ'
            }[task.status] || task.status;

            const expiredBadgeHTML = isExpired ? `<span class="status-badge status-expired">å·²è¿‡æœŸ</span>` : '';

            const channelText = channels.find(c => c.value === task.channel)?.label || task.channel;
            const scheduleLabel = task.is_recurring ? 'ğŸ“… ä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¶é—´' : 'ğŸ“… è®¡åˆ’æ—¶é—´';

            div.innerHTML = `
                <div class="task-header">
                    <div>
                        <div class="task-title">
                            ${escapeHtml(task.title)}
                            ${task.is_recurring ? `<span class="recurring-badge"></span>` : ''}
                        </div>
                        ${expiredBadgeHTML}
                        <span class="status-badge ${statusClass}">${statusText}</span>
                        <span class="channel-badge">${channelText}</span>
                    </div>
                </div>
                <div class="task-content">${escapeHtml(task.content)}</div>
                <div class="task-meta">
                    <span>${scheduleLabel}: ${formatDateTime(task.scheduled_time)}</span>
                    ${task.sent_time ? `<span>âœ… å‘é€æ—¶é—´: ${formatDateTime(task.sent_time)}</span>` : ''}
                    ${task.is_recurring ? `<span>ğŸ” é‡å¤ä»»åŠ¡: ${task.cron_expression}</span>` : ''}
                    <span>ğŸ†” ID: ${task.id}</span>
                </div>
                ${task.error_msg ? `<div style="color: #e74c3c; margin-top: 10px;">âŒ é”™è¯¯: ${escapeHtml(task.error_msg)}</div>` : ''}
                <div class="task-actions">
                    ${task.status === 'pending' ? `
                        <button class="btn btn-sm btn-info" onclick="editTask(${task.id})">ç¼–è¾‘</button>
                        <button class="btn btn-sm btn-danger" onclick="cancelTask(${task.id})">å–æ¶ˆä»»åŠ¡</button>
                    ` : `
                        <button class="btn btn-sm btn-success" onclick="editTask(${task.id})">é‡æ–°å¯ç”¨</button>
                    `}
                </div>
            `;

            return div;
        }

        // æäº¤ä»»åŠ¡è¡¨å•
        async function submitTaskForm(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const channel = formData.get('channel');
            const channelSelect = document.getElementById('channel');
            const selectedOption = channelSelect.options[channelSelect.selectedIndex];
            const configFields = JSON.parse(selectedOption.dataset.fields || '[]');

            // æ„å»ºé…ç½®å¯¹è±¡
            const channelConfig = {};
            configFields.forEach(field => {
                const value = document.getElementById(`config_${field}`).value;
                channelConfig[field] = value;
            });

            const isRecurring = formData.get('isRecurring') === 'on';

            // å¤„ç†å¹¶å…¼å®¹è½¬æ¢ cron è¡¨è¾¾å¼ï¼ˆåªåœ¨é‡å¤ä»»åŠ¡æ—¶ï¼‰
            let cronForBackend = null;
            if (isRecurring) {
                const rawCron = (formData.get('cronExpression') || '').trim();
                cronForBackend = rawCron ? convertCronExpressionForBackend(rawCron) : null;
            }

            // æ„å»ºä»»åŠ¡æ•°æ®
            const scheduledTimeValue = formData.get('scheduledTime');
            const taskData = {
                title: formData.get('title'),
                content: formData.get('content'),
                channel: channel,
                // é‡å¤ä»»åŠ¡ä¸æäº¤ scheduled_timeï¼Œç”±åç«¯æ ¹æ® cron_expression è®¡ç®—
                scheduled_time: isRecurring ? undefined : (scheduledTimeValue ? `${scheduledTimeValue}:00` : null),
                channel_config: channelConfig,
                is_recurring: isRecurring,
                cron_expression: isRecurring ? cronForBackend : null
            };

            // ç§»é™¤ undefined å­—æ®µï¼Œé¿å…åç«¯ required_fields åˆ¤æ–­è¯¯å·®
            Object.keys(taskData).forEach(k => taskData[k] === undefined && delete taskData[k]);

            try {
                const response = await fetch(`${API_BASE}/tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(taskData)
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification('ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼', 'success');
                    e.target.reset();
                    setDefaultTime();
                    document.getElementById('configFields').style.display = 'none';
                    document.getElementById('cronGroup').style.display = 'none';
                    // é‡ç½®â€œé‡å¤ä»»åŠ¡â€ç¦ç”¨æ€
                    const scheduledTimeInput = document.getElementById('scheduledTime');
                    if (scheduledTimeInput) {
                        scheduledTimeInput.disabled = false;
                        scheduledTimeInput.setAttribute('required', 'required');
                    }
                    loadTasks();
                } else {
                    showNotification('åˆ›å»ºå¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                showNotification('åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // è‡ªå®šä¹‰äºŒæ¬¡ç¡®è®¤å¼¹çª—
        function showConfirmDialog({
            title = 'ç¡®è®¤æ“ä½œ',
            message = 'è¯·ç¡®è®¤æ˜¯å¦ç»§ç»­',
            confirmText = 'ç¡®è®¤',
            cancelText = 'å†æƒ³æƒ³'
        } = {}) {
            return new Promise(resolve => {
                const modal = document.getElementById('confirmModal');
                const titleEl = document.getElementById('confirmTitle');
                const messageEl = document.getElementById('confirmMessage');
                const confirmBtn = document.getElementById('confirmOkBtn');
                const cancelBtn = document.getElementById('confirmCancelBtn');

                // å¦‚æœå…ƒç´ ç¼ºå¤±åˆ™å›é€€åˆ°åŸç”Ÿ confirm
                if (!modal || !titleEl || !messageEl || !confirmBtn || !cancelBtn) {
                    resolve(confirm(message));
                    return;
                }

                titleEl.textContent = title;
                messageEl.textContent = message;
                confirmBtn.textContent = confirmText;
                cancelBtn.textContent = cancelText;

                const removeListeners = () => {
                    confirmBtn.removeEventListener('click', onConfirm);
                    cancelBtn.removeEventListener('click', onCancel);
                    modal.removeEventListener('click', onBackdrop);
                    document.removeEventListener('keydown', onKeydown);
                };

                const closeModal = () => {
                    modal.classList.remove('show');
                    setTimeout(() => {
                        modal.style.display = 'none';
                    }, 180);
                    removeListeners();
                };

                const onConfirm = () => {
                    closeModal();
                    resolve(true);
                };

                const onCancel = () => {
                    closeModal();
                    resolve(false);
                };

                const onBackdrop = (e) => {
                    if (e.target === modal) {
                        onCancel();
                    }
                };

                const onKeydown = (e) => {
                    if (e.key === 'Escape') {
                        onCancel();
                    }
                };

                confirmBtn.addEventListener('click', onConfirm);
                cancelBtn.addEventListener('click', onCancel);
                modal.addEventListener('click', onBackdrop);
                document.addEventListener('keydown', onKeydown);

                modal.style.display = 'block';
                // ä¸‹ä¸€å¸§å†åŠ  show ç±»ï¼Œç¡®ä¿åŠ¨ç”»èƒ½æ­£å¸¸è§¦å‘ï¼›å…œåº•ç”¨ setTimeout
                const addShowClass = () => modal.classList.add('show');
                if (typeof requestAnimationFrame === 'function') {
                    requestAnimationFrame(addShowClass);
                } else {
                    setTimeout(addShowClass, 16);
                }
            });
        }

        // å–æ¶ˆä»»åŠ¡
        async function cancelTask(taskId) {
            const confirmed = await showConfirmDialog({
                title: 'å–æ¶ˆä»»åŠ¡',
                message: 'ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',
                confirmText: 'ç¡®è®¤å–æ¶ˆ',
                cancelText: 'ä¿ç•™ä»»åŠ¡'
            });

            if (!confirmed) return;

            try {
                const response = await fetch(`${API_BASE}/tasks/${taskId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification('ä»»åŠ¡å·²å–æ¶ˆ', 'success');
                    loadTasks();
                } else {
                    showNotification('å–æ¶ˆå¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                showNotification('å–æ¶ˆå¤±è´¥: ' + error.message, 'error');
            }
        }

        // è®¾ç½®é»˜è®¤æ—¶é—´ä¸ºå½“å‰æ—¶é—´+1å°æ—¶ï¼ˆä¸œå…«åŒºæœ¬åœ°æ—¶é—´ï¼‰
        function setDefaultTime() {
            const now = new Date();
            now.setHours(now.getHours() + 1);
            document.getElementById('scheduledTime').value = toLocalInputValue(now);
        }

        // å°† Date è½¬ä¸º datetime-local å¯ç”¨çš„æœ¬åœ°æ—¶é—´å­—ç¬¦ä¸²
        function toLocalInputValue(date) {
            const local = new Date(date.getTime() - date.getTimezoneOffset() * 60000);
            return local.toISOString().slice(0, 16);
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // è‡ªåŠ¨åˆ·æ–°ä»»åŠ¡åˆ—è¡¨ï¼ˆæ¯30ç§’ï¼‰
        setInterval(loadTasks, 30000);

        // å“åº”å¼å¢å¼ºåŠŸèƒ½
        function initResponsiveFeatures() {
            // æ·»åŠ è§¦æ‘¸åé¦ˆ
            document.addEventListener('touchstart', function(e) {
                if (e.target.classList.contains('btn') ||
                    e.target.classList.contains('task-item') ||
                    e.target.closest('.btn') ||
                    e.target.closest('.task-item')) {
                    const element = e.target.classList.contains('btn') ? e.target :
                                  e.target.closest('.btn') || e.target.closest('.task-item');
                    element.style.transform = 'scale(0.98)';
                    element.style.transition = 'transform 0.1s ease';
                }
            });

            document.addEventListener('touchend', function(e) {
                if (e.target.classList.contains('btn') ||
                    e.target.classList.contains('task-item') ||
                    e.target.closest('.btn') ||
                    e.target.closest('.task-item')) {
                    const element = e.target.classList.contains('btn') ? e.target :
                                  e.target.closest('.btn') || e.target.closest('.task-item');
                    setTimeout(() => {
                        element.style.transform = 'scale(1)';
                    }, 100);
                }
            });

            // ä¼˜åŒ–ç§»åŠ¨ç«¯æ»šåŠ¨ä½“éªŒ
            if ('ontouchstart' in window) {
                document.body.style.webkitOverflowScrolling = 'touch';

                // ä¸ºç§»åŠ¨ç«¯ä¼˜åŒ–è¾“å…¥æ¡†ç„¦ç‚¹
                const inputs = document.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    input.addEventListener('focus', function() {
                        // å»¶è¿Ÿæ»šåŠ¨ä»¥ç¡®ä¿è¾“å…¥æ¡†å¯è§
                        setTimeout(() => {
                            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 300);
                    });
                });
            }

            // æ™ºèƒ½å¸ƒå±€è°ƒæ•´
            adjustLayoutForScreenSize();
            window.addEventListener('resize', debounce(adjustLayoutForScreenSize, 250));
            window.addEventListener('orientationchange', debounce(adjustLayoutForScreenSize, 500));
        }

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // æ ¹æ®å±å¹•å°ºå¯¸è°ƒæ•´å¸ƒå±€
        function adjustLayoutForScreenSize() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            const isMobile = width <= 768;
            const isSmallMobile = width <= 480;

            // è°ƒæ•´ä»»åŠ¡åˆ—è¡¨é«˜åº¦
            const taskList = document.getElementById('taskList');
            if (taskList && taskList.style.display !== 'none') {
                if (isMobile) {
                    const viewportHeight = window.innerHeight;
                    const headerHeight = document.querySelector('header')?.offsetHeight || 200;
                    const formHeight = document.querySelector('.card')?.offsetHeight || 400;
                    const maxListHeight = Math.max(300, viewportHeight - headerHeight - formHeight - 150);
                    taskList.style.maxHeight = `${maxListHeight}px`;
                } else if (width >= 1400) {
                    taskList.style.maxHeight = '700px';
                } else {
                    taskList.style.maxHeight = '600px';
                }
            }

            // ç§»åŠ¨ç«¯ä¼˜åŒ–
            if (isMobile) {
                // ç¡®ä¿æ¨¡æ€æ¡†åœ¨ç§»åŠ¨ç«¯æ­£å¸¸æ˜¾ç¤º
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (modal.style.display === 'block') {
                        const modalContent = modal.querySelector('.modal-content');
                        if (modalContent) {
                            modalContent.style.maxHeight = '80vh';
                            modalContent.style.overflowY = 'auto';
                        }
                    }
                });

                // ä¼˜åŒ–é€šçŸ¥æ˜¾ç¤º
                const notifications = document.querySelectorAll('.notification');
                notifications.forEach(notification => {
                    notification.style.fontSize = isSmallMobile ? '14px' : '16px';
                    notification.style.padding = isSmallMobile ? '12px 20px' : '15px 25px';
                });
            }
        }

        // ä¼˜åŒ–ç§»åŠ¨ç«¯è¡¨å•ä½“éªŒ
        function optimizeMobileForms() {
            // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            if (isMobile) {
                // ä¸ºç§»åŠ¨è®¾å¤‡ä¼˜åŒ–è¾“å…¥ç±»å‹
                const emailInputs = document.querySelectorAll('input[type="email"]');
                emailInputs.forEach(input => {
                    input.setAttribute('autocomplete', 'email');
                });

                const passwordInputs = document.querySelectorAll('input[type="password"]');
                passwordInputs.forEach(input => {
                    input.setAttribute('autocomplete', 'current-password');
                });

                // ä¼˜åŒ–æ•°å­—è¾“å…¥
                const numberInputs = document.querySelectorAll('input[type="number"], input[type="tel"]');
                numberInputs.forEach(input => {
                    input.setAttribute('inputmode', 'numeric');
                    input.setAttribute('pattern', '[0-9]*');
                });
            }
        }

        function initMobileSectionToggle() {
            const tabsContainer = document.querySelector('.mobile-tabs');
            const tabs = tabsContainer ? tabsContainer.querySelectorAll('.mobile-tab') : [];
            const sections = document.querySelectorAll('.card-section');

            if (!tabs.length || !sections.length) {
                return;
            }

            let activeTarget = tabs[0].dataset.target;

            const syncSections = (isCompact) => {
                if (isCompact) {
                    sections.forEach(section => {
                        section.classList.toggle('active', section.dataset.section === activeTarget);
                    });
                } else {
                    sections.forEach(section => section.classList.add('active'));
                }
            };

            const setActiveSection = (target) => {
                activeTarget = target;
                tabs.forEach(tab => {
                    const isActive = tab.dataset.target === target;
                    tab.classList.toggle('active', isActive);
                    tab.setAttribute('aria-pressed', isActive ? 'true' : 'false');
                });
                syncSections(window.innerWidth <= 640);
            };

            const handleViewportChange = () => {
                syncSections(window.innerWidth <= 640);
            };

            tabs.forEach(tab => {
                tab.addEventListener('click', () => setActiveSection(tab.dataset.target));
            });

            setActiveSection(activeTarget);
            window.addEventListener('resize', debounce(handleViewportChange, 150));
            window.addEventListener('orientationchange', debounce(handleViewportChange, 150));
        }

        // æ·»åŠ ä¸‹æ‹‰åˆ·æ–°åŠŸèƒ½ï¼ˆä»…ç§»åŠ¨ç«¯ï¼‰
        function initPullToRefresh() {
            let startY = 0;
            let isPulling = false;
            const pullThreshold = 80;

            const taskList = document.getElementById('taskList');
            if (!taskList) return;

            taskList.addEventListener('touchstart', function(e) {
                if (taskList.scrollTop === 0) {
                    startY = e.touches[0].clientY;
                    isPulling = true;
                }
            });

            taskList.addEventListener('touchmove', function(e) {
                if (!isPulling) return;

                const currentY = e.touches[0].clientY;
                const diff = currentY - startY;

                if (diff > 0 && diff < pullThreshold) {
                    taskList.style.transform = `translateY(${diff * 0.5}px)`;
                    taskList.style.transition = 'none';
                }
            });

            taskList.addEventListener('touchend', function(e) {
                if (!isPulling) return;

                isPulling = false;
                taskList.style.transform = '';
                taskList.style.transition = 'transform 0.3s ease';

                const currentY = e.changedTouches[0].clientY;
                const diff = currentY - startY;

                if (diff > pullThreshold) {
                    loadTasks();
                    showNotification('æ­£åœ¨åˆ·æ–°...', 'success');
                }
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–å“åº”å¼åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            // åœ¨åŸæœ‰çš„ checkAuthStatus() è°ƒç”¨åæ·»åŠ 
            setTimeout(() => {
                initMobileSectionToggle();
                initResponsiveFeatures();
                optimizeMobileForms();

                // å¦‚æœæ˜¯ç§»åŠ¨è®¾å¤‡ä¸”æ”¯æŒè§¦æ‘¸ï¼Œå¯ç”¨ä¸‹æ‹‰åˆ·æ–°
                if ('ontouchstart' in window && window.innerWidth <= 768) {
                    initPullToRefresh();
                }
            }, 1000);
        });

        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œä¼˜åŒ–æ€§èƒ½
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // é¡µé¢éšè—æ—¶é™ä½åˆ·æ–°é¢‘ç‡
                clearInterval(window.taskRefreshInterval);
            } else {
                // é¡µé¢æ˜¾ç¤ºæ—¶æ¢å¤æ­£å¸¸åˆ·æ–°é¢‘ç‡
                window.taskRefreshInterval = setInterval(loadTasks, 30000);
                loadTasks(); // ç«‹å³åˆ·æ–°æ•°æ®
            }
        });

        // å­˜å‚¨åˆ·æ–°é—´éš”IDï¼Œä¾¿äºç®¡ç†
        window.taskRefreshInterval = setInterval(loadTasks, 30000);

        // ä»»åŠ¡ç¼–è¾‘ç›¸å…³å‡½æ•°

        // ç¼–è¾‘ä»»åŠ¡
        async function editTask(taskId) {
            try {
                // å…ˆè·å–ä»»åŠ¡è¯¦ç»†ä¿¡æ¯
                const response = await fetch(`${API_BASE}/tasks/${taskId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    showNotification('è·å–ä»»åŠ¡å¤±è´¥: ' + error.error, 'error');
                    return;
                }

                const task = await response.json();

                // è°ƒè¯•è¾“å‡º
                console.log('Task received from API:', {
                    id: task.id,
                    title: task.title,
                    channel: task.channel,
                    channel_config: task.channel_config,
                    channel_config_type: typeof task.channel_config
                });

                // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
                showEditTaskModal(task);

            } catch (error) {
                showNotification('è·å–ä»»åŠ¡å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºç¼–è¾‘ä»»åŠ¡æ¨¡æ€æ¡†
        function showEditTaskModal(task) {
            // æ·»åŠ åŠ è½½åŠ¨ç”»
            const modal = document.getElementById('editTaskModal');
            const modalContent = modal.querySelector('.modal-content');

            // é‡ç½®è¡¨å•
            document.getElementById('editTaskForm').reset();

            // å¡«å……è¡¨å•æ•°æ®
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editTitle').value = task.title;
            document.getElementById('editContent').value = task.content;

            // è®¾ç½®æ¸ é“ä¿¡æ¯
            const channelSelect = document.getElementById('editChannel');
            const channelOption = channels.find(c => c.value === task.channel);
            if (channelOption) {
                channelSelect.innerHTML = `<option value="${task.channel}" selected>${channelOption.label}</option>`;
            }

            // è®¾ç½®æ—¶é—´
            const scheduledTime = new Date(task.scheduled_time);
            // è½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´å¹¶æ ¼å¼åŒ–
            const localTime = new Date(scheduledTime.getTime() - scheduledTime.getTimezoneOffset() * 60000);
            document.getElementById('editScheduledTime').value = localTime.toISOString().slice(0, 16);

            // è®¾ç½®é‡å¤ä»»åŠ¡ä¿¡æ¯
            const isRecurringCheckbox = document.getElementById('editIsRecurring');
            isRecurringCheckbox.checked = task.is_recurring;

            if (task.is_recurring) {
                document.getElementById('editCronGroup').style.display = 'block';
                document.getElementById('editCronExpression').value = task.cron_expression;
            }

            // å¡«å……æ¸ é“é…ç½®å­—æ®µ
            fillEditConfigFields(task.channel, task.channel_config);

            // æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼ˆå¸¦åŠ¨ç”»æ•ˆæœï¼‰
            modal.style.display = 'block';
            setTimeout(() => {
                modalContent.style.transform = 'scale(1)';
                modalContent.style.opacity = '1';
            }, 10);

            // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
            document.getElementById('editTaskForm').addEventListener('submit', handleEditTaskSubmit);

            // èšç„¦åˆ°ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†
            setTimeout(() => {
                document.getElementById('editTitle').focus();
            }, 300);
        }

        // å¡«å……ç¼–è¾‘è¡¨å•çš„é…ç½®å­—æ®µ
        function fillEditConfigFields(channelType, channelConfig) {
            const channel = channels.find(c => c.value === channelType);
            if (!channel) return;

            // channel.config_fields å¯èƒ½æ˜¯æ•°ç»„ï¼ˆæ¥è‡ª API çš„åŸç”Ÿ JSONï¼‰æˆ–å­—ç¬¦ä¸²ï¼ˆå·²åºåˆ—åŒ–çš„ JSONï¼‰ï¼Œ
            // å…¼å®¹ä¸¤ç§æƒ…å†µä»¥é¿å… JSON.parse åœ¨æ¥æ”¶åˆ°æ•°ç»„æ—¶æŠ›å‡ºé”™è¯¯ï¼ˆæ•°ç»„ä¼šè¢« toString æˆé JSON å­—ç¬¦ä¸²ï¼‰ã€‚
            let configFields = [];
            try {
                if (typeof channel.config_fields === 'string') {
                    configFields = JSON.parse(channel.config_fields || '[]');
                } else if (Array.isArray(channel.config_fields)) {
                    configFields = channel.config_fields;
                } else {
                    configFields = [];
                }
            } catch (err) {
                console.error('è§£æ channel.config_fields å‡ºé”™ï¼Œå›é€€ä¸ºç©ºæ•°ç»„:', err, channel.config_fields);
                configFields = [];
            }
            const configFieldsDiv = document.getElementById('editConfigFields');

            // è°ƒè¯•è¾“å‡º
            console.log('fillEditConfigFields called with:', {
                channelType,
                channelConfigType: typeof channelConfig,
                channelConfigValue: channelConfig
            });

            // åç«¯ç°åœ¨è¿”å›æ­£ç¡®çš„JSONå¯¹è±¡ï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨
            let existingConfig = {};
            try {
                existingConfig = channelConfig || {};
                // ç¡®ä¿æ˜¯å¯¹è±¡
                if (typeof existingConfig !== 'object') {
                    console.warn('channelConfig is not an object, trying to parse:', existingConfig);
                    existingConfig = JSON.parse(existingConfig || '{}');
                }
            } catch (error) {
                console.error('Error processing channelConfig:', error);
                existingConfig = {};
            }

            configFieldsDiv.innerHTML = `
                <div class="info-hint">
                    â„¹ï¸ å½“å‰æ¸ é“é…ç½®å·²ä¿å­˜ï¼Œå¯åœ¨æ­¤ä¿®æ”¹
                </div>
            `;

            configFields.forEach(field => {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';

                const label = document.createElement('label');
                label.textContent = getFieldLabel(field);
                formGroup.appendChild(label);

                const input = document.createElement('input');
                input.type = field.includes('token') || field.includes('secret') ? 'password' : 'text';
                input.id = `editConfig_${field}`;
                input.name = field;
                input.placeholder = `è¯·è¾“å…¥${getFieldLabel(field)}`;
                input.value = existingConfig[field] || '';
                input.required = true;
                formGroup.appendChild(input);

                configFieldsDiv.appendChild(formGroup);
            });

            configFieldsDiv.style.display = 'block';
        }

        // å…³é—­ç¼–è¾‘ä»»åŠ¡æ¨¡æ€æ¡†
        function closeEditTaskModal() {
            const modal = document.getElementById('editTaskModal');
            const modalContent = modal.querySelector('.modal-content');

            // æ·»åŠ å…³é—­åŠ¨ç”»
            modalContent.style.transform = 'scale(0.9)';
            modalContent.style.opacity = '0';

            setTimeout(() => {
                modal.style.display = 'none';
                document.getElementById('editTaskForm').reset();
                document.getElementById('editTaskForm').removeEventListener('submit', handleEditTaskSubmit);
                modalContent.style.transform = 'scale(0.9)';
                modalContent.style.opacity = '0';
            }, 300);
        }

        // å¤„ç†ç¼–è¾‘ä»»åŠ¡è¡¨å•æäº¤
        async function handleEditTaskSubmit(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const taskId = formData.get('taskId');
            const channelSelect = document.getElementById('editChannel');
            const channelType = channelSelect.options[0].value;
            const channel = channels.find(c => c.value === channelType);
            // å…¼å®¹ channel.config_fields ä¸ºæ•°ç»„æˆ–å­—ç¬¦ä¸²çš„æƒ…å†µï¼Œé¿å… JSON.parse åœ¨æ¥æ”¶æ•°ç»„æ—¶æŠ¥é”™
            let configFields = [];
            try {
                if (channel) {
                    if (typeof channel.config_fields === 'string') {
                        configFields = JSON.parse(channel.config_fields || '[]');
                    } else if (Array.isArray(channel.config_fields)) {
                        configFields = channel.config_fields;
                    } else {
                        configFields = [];
                    }
                }
            } catch (err) {
                console.error('è§£æ channel.config_fields å‡ºé”™ï¼Œå›é€€ä¸ºç©ºæ•°ç»„:', err, channel && channel.config_fields);
                configFields = [];
            }

            // æ„å»ºé…ç½®å¯¹è±¡
            const channelConfig = {};
            configFields.forEach(field => {
                const value = document.getElementById(`editConfig_${field}`).value;
                channelConfig[field] = value;
            });

            // æ„å»ºä»»åŠ¡æ•°æ®
            const scheduledTimeValue = formData.get('scheduledTime');
            const taskData = {
                title: formData.get('title'),
                content: formData.get('content'),
                channel: channelType,
                scheduled_time: scheduledTimeValue ? `${scheduledTimeValue}:00` : null,
                channel_config: channelConfig
                // æ³¨æ„ï¼šä¸åŒ…å« is_recurring å’Œ cron_expressionï¼Œå› ä¸ºåç«¯ä¸å…è®¸ä¿®æ”¹è¿™äº›å­—æ®µ
            };

            try {
                const response = await fetch(`${API_BASE}/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(taskData)
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification('ä»»åŠ¡æ›´æ–°æˆåŠŸï¼', 'success');
                    closeEditTaskModal();
                    loadTasks();
                } else {
                    showNotification('æ›´æ–°å¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                showNotification('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>