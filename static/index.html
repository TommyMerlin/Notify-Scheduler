<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šçŸ¥å®šæ—¶å‘é€ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .user-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            font-size: 0.9rem;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 15px;
            margin-left: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .config-fields {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .config-fields .form-group {
            margin-bottom: 15px;
        }

        .config-fields .form-group:last-child {
            margin-bottom: 0;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-info {
            background: #3498db;
            color: white;
        }

        .task-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .task-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .task-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .task-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 5px;
        }

        .task-content {
            color: #666;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .task-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            font-size: 0.9rem;
            color: #777;
        }

        .task-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-sent {
            background: #d4edda;
            color: #155724;
        }

        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }

        .status-cancelled {
            background: #e2e3e5;
            color: #383d41;
        }

        .channel-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-bar select {
            flex: 1;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        .notification.success {
            background: #27ae60;
        }

        .notification.error {
            background: #e74c3c;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
        }

        .login-card {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .login-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .login-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .login-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .channel-management {
            margin-top: 20px;
        }

        .channel-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .channel-info {
            flex: 1;
        }

        .channel-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .channel-type {
            color: #666;
            font-size: 0.9rem;
        }

        .channel-actions {
            display: flex;
            gap: 10px;
        }

        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•ç•Œé¢ -->
    <div id="loginPage" style="display: none;">
        <div class="login-container">
            <div class="login-card">
                <div class="login-tabs">
                    <div class="login-tab active" onclick="switchTab('login')">ç™»å½•</div>
                    <div class="login-tab" onclick="switchTab('register')">æ³¨å†Œ</div>
                </div>

                <!-- ç™»å½•è¡¨å• -->
                <div id="loginTab" class="tab-content active">
                    <h2 style="text-align: center; margin-bottom: 30px; color: #333;">ç™»å½•é€šçŸ¥ç³»ç»Ÿ</h2>
                    <form id="loginForm">
                        <div class="form-group">
                            <label for="loginUsername">ç”¨æˆ·åæˆ–é‚®ç®±</label>
                            <input type="text" id="loginUsername" name="username" required placeholder="è¯·è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±">
                        </div>
                        <div class="form-group">
                            <label for="loginPassword">å¯†ç </label>
                            <input type="password" id="loginPassword" name="password" required placeholder="è¯·è¾“å…¥å¯†ç ">
                        </div>
                        <button type="submit" class="btn btn-primary">ç™»å½•</button>
                    </form>
                </div>

                <!-- æ³¨å†Œè¡¨å• -->
                <div id="registerTab" class="tab-content">
                    <h2 style="text-align: center; margin-bottom: 30px; color: #333;">æ³¨å†Œæ–°è´¦å·</h2>
                    <form id="registerForm">
                        <div class="form-group">
                            <label for="registerUsername">ç”¨æˆ·å</label>
                            <input type="text" id="registerUsername" name="username" required placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                        </div>
                        <div class="form-group">
                            <label for="registerEmail">é‚®ç®±</label>
                            <input type="email" id="registerEmail" name="email" required placeholder="è¯·è¾“å…¥é‚®ç®±">
                        </div>
                        <div class="form-group">
                            <label for="registerPassword">å¯†ç </label>
                            <input type="password" id="registerPassword" name="password" required placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" minlength="6">
                        </div>
                        <button type="submit" class="btn btn-primary">æ³¨å†Œ</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ç•Œé¢ -->
    <div id="mainApp" style="display: none;">
        <div class="container">
            <header>
                <div>
                    <h1>ğŸ“¬ é€šçŸ¥å®šæ—¶å‘é€ç³»ç»Ÿ</h1>
                    <p>æ”¯æŒå¤šæ¸ é“å®šæ—¶å‘é€é€šçŸ¥ï¼Œè®©æ‚¨çš„æ¶ˆæ¯å‡†æ—¶åˆ°è¾¾</p>
                </div>
                <div class="user-info">
                    <span>ğŸ‘¤ <span id="currentUsername"></span></span>
                    <button class="logout-btn" onclick="logout()">é€€å‡º</button>
                </div>
            </header>

            <div class="main-content">
                <!-- åˆ›å»ºä»»åŠ¡è¡¨å• -->
                <div class="card">
                    <h2>åˆ›å»ºé€šçŸ¥ä»»åŠ¡</h2>
                    <form id="taskForm">
                        <div class="form-group">
                            <label for="title">é€šçŸ¥æ ‡é¢˜ *</label>
                            <input type="text" id="title" name="title" placeholder="è¯·è¾“å…¥é€šçŸ¥æ ‡é¢˜" required>
                        </div>

                        <div class="form-group">
                            <label for="content">é€šçŸ¥å†…å®¹ *</label>
                            <textarea id="content" name="content" placeholder="è¯·è¾“å…¥é€šçŸ¥å†…å®¹" required></textarea>
                        </div>

                        <div class="form-group">
                            <label for="channel">é€šçŸ¥æ¸ é“ *</label>
                            <select id="channel" name="channel" required>
                                <option value="">è¯·é€‰æ‹©é€šçŸ¥æ¸ é“</option>
                            </select>
                        </div>

                        <div id="configFields" class="config-fields" style="display: none;">
                            <!-- åŠ¨æ€ç”Ÿæˆé…ç½®å­—æ®µ -->
                        </div>

                        <div class="form-group">
                            <label for="scheduledTime">è®¡åˆ’å‘é€æ—¶é—´ *</label>
                            <input type="datetime-local" id="scheduledTime" name="scheduledTime" required>
                        </div>

                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="isRecurring" name="isRecurring">
                                <label for="isRecurring" style="margin-bottom: 0;">é‡å¤ä»»åŠ¡</label>
                            </div>
                        </div>

                        <div class="form-group" id="cronGroup" style="display: none;">
                            <label for="cronExpression">Cron è¡¨è¾¾å¼</label>
                            <input type="text" id="cronExpression" name="cronExpression" placeholder="å¦‚: 0 9 * * * (æ¯å¤©9ç‚¹)">
                            <small style="color: #999; display: block; margin-top: 5px;">
                                ç¤ºä¾‹: 0 9 * * * (æ¯å¤©9ç‚¹) | 0 */2 * * * (æ¯2å°æ—¶) | 0 9 * * 1 (æ¯å‘¨ä¸€9ç‚¹)
                            </small>
                        </div>

                        <button type="submit" class="btn btn-primary">åˆ›å»ºä»»åŠ¡</button>
                    </form>

                    <!-- æ¸ é“ç®¡ç† -->
                    <div class="channel-management">
                        <h3 style="margin-top: 30px; margin-bottom: 15px; color: #333; font-size: 1.2rem;">æˆ‘çš„é€šçŸ¥æ¸ é“</h3>
                        <button class="btn btn-sm btn-info" onclick="openChannelModal()">æ·»åŠ æ¸ é“</button>
                        <div id="userChannels" class="channel-list">
                            <!-- åŠ¨æ€ç”Ÿæˆç”¨æˆ·æ¸ é“åˆ—è¡¨ -->
                        </div>
                    </div>
                </div>

                <!-- ä»»åŠ¡åˆ—è¡¨ -->
                <div class="card">
                    <h2>ä»»åŠ¡åˆ—è¡¨</h2>
                    <div class="filter-bar">
                        <select id="statusFilter">
                            <option value="">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="pending">å¾…å‘é€</option>
                            <option value="sent">å·²å‘é€</option>
                            <option value="failed">å‘é€å¤±è´¥</option>
                            <option value="cancelled">å·²å–æ¶ˆ</option>
                        </select>
                        <button class="btn btn-info btn-sm" onclick="loadTasks()">åˆ·æ–°</button>
                    </div>
                    <div id="taskList" class="task-list">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>åŠ è½½ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¸ é“é…ç½®æ¨¡æ€æ¡† -->
    <div id="channelModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeChannelModal()">&times;</span>
            <h2>æ·»åŠ é€šçŸ¥æ¸ é“</h2>
            <form id="channelForm">
                <div class="form-group">
                    <label for="channelName">æ¸ é“åç§° *</label>
                    <input type="text" id="channelName" name="channelName" required placeholder="å¦‚ï¼šä¼ä¸šå¾®ä¿¡é€šçŸ¥">
                </div>

                <div class="form-group">
                    <label for="channelType">æ¸ é“ç±»å‹ *</label>
                    <select id="channelType" name="channelType" required>
                        <option value="">è¯·é€‰æ‹©æ¸ é“ç±»å‹</option>
                    </select>
                </div>

                <div id="channelConfigFields" class="config-fields">
                    <!-- åŠ¨æ€ç”Ÿæˆé…ç½®å­—æ®µ -->
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="isDefaultChannel" name="isDefault">
                        <label for="isDefaultChannel" style="margin-bottom: 0;">è®¾ä¸ºé»˜è®¤æ¸ é“</label>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">æ·»åŠ æ¸ é“</button>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let channels = [];
        let currentUser = null;
        let userChannels = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
        });

        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        async function checkAuthStatus() {
            const token = localStorage.getItem('token');
            if (!token) {
                showLoginPage();
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    showMainApp();
                } else {
                    localStorage.removeItem('token');
                    showLoginPage();
                }
            } catch (error) {
                localStorage.removeItem('token');
                showLoginPage();
            }
        }

        // æ˜¾ç¤ºç™»å½•é¡µé¢
        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            initLoginEvents();
        }

        // æ˜¾ç¤ºä¸»åº”ç”¨
        function showMainApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('currentUsername').textContent = currentUser.username;
            loadChannels();
            loadUserChannels();
            loadTasks();
            initAppEvents();
            setDefaultTime();
        }

        // åˆ‡æ¢ç™»å½•/æ³¨å†Œæ ‡ç­¾
        function switchTab(tab) {
            const tabs = document.querySelectorAll('.login-tab');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));

            if (tab === 'login') {
                tabs[0].classList.add('active');
                document.getElementById('loginTab').classList.add('active');
            } else {
                tabs[1].classList.add('active');
                document.getElementById('registerTab').classList.add('active');
            }
        }

        // åˆå§‹åŒ–ç™»å½•äº‹ä»¶
        function initLoginEvents() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
        }

        // å¤„ç†ç™»å½•
        async function handleLogin(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const loginData = {
                username: formData.get('username'),
                password: formData.get('password')
            };

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(loginData)
                });

                const result = await response.json();

                if (response.ok) {
                    localStorage.setItem('token', result.data.token);
                    currentUser = result.data.user;
                    showMainApp();
                    showNotification('ç™»å½•æˆåŠŸï¼', 'success');
                } else {
                    showNotification(result.error, 'error');
                }
            } catch (error) {
                showNotification('ç™»å½•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¤„ç†æ³¨å†Œ
        async function handleRegister(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const registerData = {
                username: formData.get('username'),
                email: formData.get('email'),
                password: formData.get('password')
            };

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(registerData)
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•', 'success');
                    switchTab('login');
                    e.target.reset();
                } else {
                    showNotification(result.error, 'error');
                }
            } catch (error) {
                showNotification('æ³¨å†Œå¤±è´¥: ' + error.message, 'error');
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('token');
            currentUser = null;
            checkAuthStatus();
        }

        // åˆå§‹åŒ–åº”ç”¨äº‹ä»¶
        function initAppEvents() {
            document.getElementById('taskForm').addEventListener('submit', submitTaskForm);
            document.getElementById('channel').addEventListener('change', onChannelChange);
            document.getElementById('statusFilter').addEventListener('change', loadTasks);
            document.getElementById('isRecurring').addEventListener('change', function() {
                document.getElementById('cronGroup').style.display = this.checked ? 'block' : 'none';
            });
        }

        // åŠ è½½é€šçŸ¥æ¸ é“ç±»å‹
        async function loadChannels() {
            try {
                const response = await fetch(`${API_BASE}/channels`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const data = await response.json();
                channels = data.channels;

                // å¡«å……ä»»åŠ¡è¡¨å•ä¸­çš„æ¸ é“é€‰æ‹©
                const taskChannelSelect = document.getElementById('channel');
                channels.forEach(channel => {
                    const option = document.createElement('option');
                    option.value = channel.value;
                    option.textContent = channel.label;
                    option.dataset.fields = JSON.stringify(channel.config_fields);
                    taskChannelSelect.appendChild(option);
                });

                // å¡«å……æ¸ é“æ¨¡æ€æ¡†ä¸­çš„æ¸ é“ç±»å‹é€‰æ‹©
                const modalChannelSelect = document.getElementById('channelType');
                channels.forEach(channel => {
                    const option = document.createElement('option');
                    option.value = channel.value;
                    option.textContent = channel.label;
                    option.dataset.fields = JSON.stringify(channel.config_fields);
                    modalChannelSelect.appendChild(option);
                });
            } catch (error) {
                showNotification('åŠ è½½æ¸ é“å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½ç”¨æˆ·ä¸“å±æ¸ é“
        async function loadUserChannels() {
            try {
                const response = await fetch(`${API_BASE}/user/channels`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const data = await response.json();
                userChannels = data.channels;

                renderUserChannels();
            } catch (error) {
                showNotification('åŠ è½½ç”¨æˆ·æ¸ é“å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ¸²æŸ“ç”¨æˆ·æ¸ é“åˆ—è¡¨
        function renderUserChannels() {
            const container = document.getElementById('userChannels');
            if (userChannels.length === 0) {
                container.innerHTML = '<div class="empty-state"><i>ğŸ“­</i><p>æš‚æ— æ¸ é“é…ç½®</p></div>';
                return;
            }

            container.innerHTML = '';
            userChannels.forEach(channel => {
                const channelItem = document.createElement('div');
                channelItem.className = 'channel-item';

                const channelTypeLabel = channels.find(c => c.value === channel.channel_type)?.label || channel.channel_type;

                channelItem.innerHTML = `
                    <div class="channel-info">
                        <div class="channel-name">${channel.channel_name} ${channel.is_default ? '(é»˜è®¤)' : ''}</div>
                        <div class="channel-type">${channelTypeLabel}</div>
                    </div>
                    <div class="channel-actions">
                        <button class="btn btn-sm btn-danger" onclick="deleteUserChannel(${channel.id})">åˆ é™¤</button>
                    </div>
                `;
                container.appendChild(channelItem);
            });
        }

        // æ‰“å¼€æ¸ é“é…ç½®æ¨¡æ€æ¡†
        function openChannelModal() {
            document.getElementById('channelModal').style.display = 'block';
            document.getElementById('channelForm').addEventListener('submit', handleCreateChannel);
            document.getElementById('channelType').addEventListener('change', onChannelTypeChange);
        }

        // å…³é—­æ¸ é“é…ç½®æ¨¡æ€æ¡†
        function closeChannelModal() {
            document.getElementById('channelModal').style.display = 'none';
            document.getElementById('channelForm').reset();
            document.getElementById('channelConfigFields').innerHTML = '';
        }

        // æ¸ é“ç±»å‹æ”¹å˜æ—¶æ›´æ–°é…ç½®å­—æ®µ
        function onChannelTypeChange() {
            const channelSelect = document.getElementById('channelType');
            const selectedOption = channelSelect.options[channelSelect.selectedIndex];
            const configFieldsDiv = document.getElementById('channelConfigFields');

            if (!selectedOption.value) {
                configFieldsDiv.innerHTML = '';
                return;
            }

            const fields = JSON.parse(selectedOption.dataset.fields || '[]');
            configFieldsDiv.innerHTML = '';

            fields.forEach(field => {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';

                const label = document.createElement('label');
                label.textContent = getFieldLabel(field);
                formGroup.appendChild(label);

                const input = document.createElement('input');
                input.type = field.includes('token') || field.includes('secret') ? 'password' : 'text';
                input.id = `channelConfig_${field}`;
                input.name = field;
                input.placeholder = `è¯·è¾“å…¥${getFieldLabel(field)}`;
                input.required = true;
                formGroup.appendChild(input);

                configFieldsDiv.appendChild(formGroup);
            });
        }

        // å¤„ç†åˆ›å»ºæ¸ é“
        async function handleCreateChannel(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const channelSelect = document.getElementById('channelType');
            const selectedOption = channelSelect.options[channelSelect.selectedIndex];
            const configFields = JSON.parse(selectedOption.dataset.fields || '[]');

            // æ„å»ºé…ç½®å¯¹è±¡
            const channelConfig = {};
            configFields.forEach(field => {
                const value = document.getElementById(`channelConfig_${field}`).value;
                channelConfig[field] = value;
            });

            const channelData = {
                channel_name: formData.get('channelName'),
                channel_type: formData.get('channelType'),
                channel_config: channelConfig,
                is_default: formData.get('isDefault') === 'on'
            };

            try {
                const response = await fetch(`${API_BASE}/user/channels`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(channelData)
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification('æ¸ é“åˆ›å»ºæˆåŠŸï¼', 'success');
                    closeChannelModal();
                    loadUserChannels();
                } else {
                    showNotification(result.error, 'error');
                }
            } catch (error) {
                showNotification('åˆ›å»ºæ¸ é“å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ é™¤ç”¨æˆ·æ¸ é“
        async function deleteUserChannel(channelId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¸ é“é…ç½®å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/user/channels/${channelId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification('æ¸ é“åˆ é™¤æˆåŠŸ', 'success');
                    loadUserChannels();
                } else {
                    showNotification(result.error, 'error');
                }
            } catch (error) {
                showNotification('åˆ é™¤æ¸ é“å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ¸ é“æ”¹å˜æ—¶æ›´æ–°é…ç½®å­—æ®µ
        function onChannelChange() {
            const channelSelect = document.getElementById('channel');
            const selectedOption = channelSelect.options[channelSelect.selectedIndex];
            const configFieldsDiv = document.getElementById('configFields');

            if (!selectedOption.value) {
                configFieldsDiv.style.display = 'none';
                return;
            }

            const fields = JSON.parse(selectedOption.dataset.fields || '[]');
            configFieldsDiv.innerHTML = '';

            // å…ˆæ˜¾ç¤ºç”¨æˆ·å·²ä¿å­˜çš„æ¸ é“é€‰é¡¹
            const userChannelSelect = document.createElement('select');
            userChannelSelect.id = 'userChannelSelect';
            userChannelSelect.style.marginBottom = '15px';

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'é€‰æ‹©å·²ä¿å­˜çš„æ¸ é“ï¼ˆå¯é€‰ï¼‰';
            userChannelSelect.appendChild(defaultOption);

            userChannels.forEach(userChannel => {
                if (userChannel.channel_type === selectedOption.value) {
                    const option = document.createElement('option');
                    option.value = userChannel.id;
                    option.textContent = `${userChannel.channel_name} ${userChannel.is_default ? '(é»˜è®¤)' : ''}`;
                    userChannelSelect.appendChild(option);
                }
            });

            if (userChannels.some(uc => uc.channel_type === selectedOption.value)) {
                configFieldsDiv.appendChild(userChannelSelect);
            }

            fields.forEach(field => {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';

                const label = document.createElement('label');
                label.textContent = getFieldLabel(field);
                formGroup.appendChild(label);

                const input = document.createElement('input');
                input.type = field.includes('token') || field.includes('secret') ? 'password' : 'text';
                input.id = `config_${field}`;
                input.name = field;
                input.placeholder = `è¯·è¾“å…¥${getFieldLabel(field)}`;
                formGroup.appendChild(input);

                configFieldsDiv.appendChild(formGroup);
            });

            configFieldsDiv.style.display = 'block';

            // ç›‘å¬ç”¨æˆ·æ¸ é“é€‰æ‹©
            userChannelSelect.addEventListener('change', function() {
                const selectedChannelId = this.value;
                if (selectedChannelId) {
                    const selectedChannel = userChannels.find(uc => uc.id == selectedChannelId);
                    if (selectedChannel) {
                        const config = selectedChannel.channel_config;
                        fields.forEach(field => {
                            const input = document.getElementById(`config_${field}`);
                            if (input && config[field]) {
                                input.value = config[field];
                            }
                        });
                    }
                }
            });
        }

        // è·å–å­—æ®µä¸­æ–‡æ ‡ç­¾
        function getFieldLabel(field) {
            const labels = {
                'corpid': 'ä¼ä¸šID',
                'corpsecret': 'åº”ç”¨Secret',
                'agentid': 'åº”ç”¨ID',
                'webhook_url': 'Webhook URL',
                'appid': 'åº”ç”¨ID',
                'appsecret': 'åº”ç”¨Secret',
                'receiver_type': 'æ¥æ”¶è€…ç±»å‹',
                'receiver_id': 'æ¥æ”¶è€…ID',
                'token': 'Token'
            };
            return labels[field] || field;
        }

        // åŠ è½½ä»»åŠ¡åˆ—è¡¨
        async function loadTasks() {
            const taskList = document.getElementById('taskList');
            const statusFilter = document.getElementById('statusFilter').value;

            taskList.innerHTML = '<div class="loading"><div class="spinner"></div><p>åŠ è½½ä¸­...</p></div>';

            try {
                const url = statusFilter
                    ? `${API_BASE}/tasks?status=${statusFilter}&page_size=100`
                    : `${API_BASE}/tasks?page_size=100`;

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const data = await response.json();

                if (data.tasks && data.tasks.length > 0) {
                    taskList.innerHTML = '';
                    data.tasks.forEach(task => {
                        taskList.appendChild(createTaskElement(task));
                    });
                } else {
                    taskList.innerHTML = '<div class="empty-state"><i>ğŸ“­</i><p>æš‚æ— ä»»åŠ¡</p></div>';
                }
            } catch (error) {
                taskList.innerHTML = '<div class="empty-state"><i>âŒ</i><p>åŠ è½½å¤±è´¥: ' + error.message + '</p></div>';
            }
        }

        // åˆ›å»ºä»»åŠ¡å…ƒç´ 
        function createTaskElement(task) {
            const div = document.createElement('div');
            div.className = 'task-item';

            const statusClass = `status-${task.status}`;
            const statusText = {
                'pending': 'å¾…å‘é€',
                'sent': 'å·²å‘é€',
                'failed': 'å‘é€å¤±è´¥',
                'cancelled': 'å·²å–æ¶ˆ'
            }[task.status] || task.status;

            const channelText = channels.find(c => c.value === task.channel)?.label || task.channel;

            div.innerHTML = `
                <div class="task-header">
                    <div>
                        <div class="task-title">${escapeHtml(task.title)}</div>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                        <span class="channel-badge">${channelText}</span>
                    </div>
                </div>
                <div class="task-content">${escapeHtml(task.content)}</div>
                <div class="task-meta">
                    <span>ğŸ“… è®¡åˆ’æ—¶é—´: ${formatDateTime(task.scheduled_time)}</span>
                    ${task.sent_time ? `<span>âœ… å‘é€æ—¶é—´: ${formatDateTime(task.sent_time)}</span>` : ''}
                    ${task.is_recurring ? `<span>ğŸ” é‡å¤ä»»åŠ¡: ${task.cron_expression}</span>` : ''}
                    <span>ğŸ†” ID: ${task.id}</span>
                </div>
                ${task.error_msg ? `<div style="color: #e74c3c; margin-top: 10px;">âŒ é”™è¯¯: ${escapeHtml(task.error_msg)}</div>` : ''}
                ${task.status === 'pending' ? `
                <div class="task-actions">
                    <button class="btn btn-sm btn-danger" onclick="cancelTask(${task.id})">å–æ¶ˆä»»åŠ¡</button>
                </div>
                ` : ''}
            `;

            return div;
        }

        // æäº¤ä»»åŠ¡è¡¨å•
        async function submitTaskForm(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const channel = formData.get('channel');
            const channelSelect = document.getElementById('channel');
            const selectedOption = channelSelect.options[channelSelect.selectedIndex];
            const configFields = JSON.parse(selectedOption.dataset.fields || '[]');

            // æ„å»ºé…ç½®å¯¹è±¡
            const channelConfig = {};
            configFields.forEach(field => {
                const value = document.getElementById(`config_${field}`).value;
                channelConfig[field] = value;
            });

            // æ„å»ºä»»åŠ¡æ•°æ®
            const scheduledTimeValue = formData.get('scheduledTime');
            const taskData = {
                title: formData.get('title'),
                content: formData.get('content'),
                channel: channel,
                scheduled_time: scheduledTimeValue ? `${scheduledTimeValue}:00` : null,
                channel_config: channelConfig,
                is_recurring: formData.get('isRecurring') === 'on',
                cron_expression: formData.get('isRecurring') === 'on' ? formData.get('cronExpression') : null
            };

            try {
                const response = await fetch(`${API_BASE}/tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(taskData)
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification('ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼', 'success');
                    e.target.reset();
                    setDefaultTime();
                    document.getElementById('configFields').style.display = 'none';
                    document.getElementById('cronGroup').style.display = 'none';
                    loadTasks();
                } else {
                    showNotification('åˆ›å»ºå¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                showNotification('åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // å–æ¶ˆä»»åŠ¡
        async function cancelTask(taskId) {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/tasks/${taskId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification('ä»»åŠ¡å·²å–æ¶ˆ', 'success');
                    loadTasks();
                } else {
                    showNotification('å–æ¶ˆå¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                showNotification('å–æ¶ˆå¤±è´¥: ' + error.message, 'error');
            }
        }

        // è®¾ç½®é»˜è®¤æ—¶é—´ä¸ºå½“å‰æ—¶é—´+1å°æ—¶ï¼ˆä¸œå…«åŒºæœ¬åœ°æ—¶é—´ï¼‰
        function setDefaultTime() {
            const now = new Date();
            now.setHours(now.getHours() + 1);
            document.getElementById('scheduledTime').value = toLocalInputValue(now);
        }

        // å°† Date è½¬ä¸º datetime-local å¯ç”¨çš„æœ¬åœ°æ—¶é—´å­—ç¬¦ä¸²
        function toLocalInputValue(date) {
            const local = new Date(date.getTime() - date.getTimezoneOffset() * 60000);
            return local.toISOString().slice(0, 16);
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // è‡ªåŠ¨åˆ·æ–°ä»»åŠ¡åˆ—è¡¨ï¼ˆæ¯30ç§’ï¼‰
        setInterval(loadTasks, 30000);
    </script>
</body>
</html>