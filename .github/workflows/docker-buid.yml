name: Build and Push Docker Image

on:
  push:
    branches:
      - master
    tags:
      - 'v*'  # å¯é€‰ï¼šå½“æ¨é€vå¼€å¤´çš„tagæ—¶ä¹Ÿè§¦å‘
  pull_request:
    branches:
      - master

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # è·å–å®Œæ•´gitå†å²ï¼ˆå¯é€‰ï¼‰

      # 2. å®‰è£… YAML å¤„ç†å·¥å…·
      - name: Install yq (YAML processor)
        run: |
          sudo wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq
          echo "yq version: $(yq --version)"

      # 3. ä» version.yml è¯»å–ç‰ˆæœ¬å·
      - name: Extract version from version.yml
        id: version
        run: |
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "version.yml" ]; then
            echo "âŒ é”™è¯¯ï¼šversion.yml æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi

          echo "=== version.yml å†…å®¹ ==="
          cat version.yml
          echo "======================"

          # ä½¿ç”¨ yq æå–ç‰ˆæœ¬å·
          RAW_VERSION=$(yq eval '.version' version.yml 2>/dev/null || echo "")
          
          if [ -z "$RAW_VERSION" ]; then
            echo "âŒ é”™è¯¯ï¼šæ— æ³•ä» version.yml è¯»å– version å­—æ®µ"
            exit 1
          fi

          # æ¸…ç†ç‰ˆæœ¬å·ï¼ˆç§»é™¤å¼•å·å’Œç©ºæ ¼ï¼‰
          CLEAN_VERSION=$(echo "$RAW_VERSION" | tr -d '"'"'"' | sed 's/^v//' | xargs)
          
          # éªŒè¯ç‰ˆæœ¬æ ¼å¼ (x.y.z)
          if [[ ! "$CLEAN_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ é”™è¯¯ï¼šç‰ˆæœ¬å·æ ¼å¼æ— æ•ˆï¼Œåº”ä¸º x.y.zï¼ˆä¾‹å¦‚ 1.0.1ï¼‰"
            echo "å½“å‰å€¼: '$CLEAN_VERSION'"
            exit 1
          fi

          echo "âœ… ç‰ˆæœ¬å·: $CLEAN_VERSION"
          echo "version=$CLEAN_VERSION" >> $GITHUB_OUTPUT

      # 4. è®¾ç½® Docker å…ƒæ•°æ®ï¼ˆå¯é€‰ï¼Œç”¨äºæ›´å¥½çš„é•œåƒæ ‡ç­¾ï¼‰
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: 7ommymerlin/notify-scheduler
          tags: |
            type=raw,value=latest
            type=raw,value={{steps.version.outputs.version}}

      # 5. ç™»å½• Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 6. è®¾ç½® Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 7. æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            7ommymerlin/notify-scheduler:${{ steps.version.outputs.version }}
            7ommymerlin/notify-scheduler:latest
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 8. éªŒè¯æ¨é€ç»“æœï¼ˆå¯é€‰ï¼‰
      - name: Verify pushed tags
        run: |
          echo "âœ… é•œåƒå·²æˆåŠŸæ¨é€è‡³ Docker Hub"
          echo "ğŸ“¦ é•œåƒæ ‡ç­¾:"
          echo "  - 7ommymerlin/notify-scheduler:${{ steps.version.outputs.version }}"
          echo "  - 7ommymerlin/notify-scheduler:latest"
          echo ""
          echo "ğŸ”— æŸ¥çœ‹åœ°å€: https://hub.docker.com/r/7ommymerlin/notify-scheduler/tags"