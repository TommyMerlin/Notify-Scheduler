name: Build and Push Docker Image

on:
  push:
    branches:
      - master
      - dev
    tags:
      - 'v*'
  pull_request:
    branches:
      - master
      - dev

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. ä» version.yml è¯»å–ç‰ˆæœ¬å· (ä¿®å¤ç‰ˆ)
      - name: Extract version from version.yml
        id: version
        run: |
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "version.yml" ]; then
            echo "âŒ é”™è¯¯ï¼šversion.yml æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi

          echo "=== version.yml å†…å®¹ ==="
          cat version.yml
          echo "======================"

          # æ–¹æ³•1: ä½¿ç”¨ç®€å•çš„grepå’Œsedæå–ï¼ˆæ— éœ€å®‰è£…yqï¼‰
          RAW_VERSION=$(grep -E '^version:' version.yml | cut -d':' -f2 | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          
          if [ -z "$RAW_VERSION" ]; then
            echo "âŒ é”™è¯¯ï¼šæ— æ³•ä» version.yml è¯»å– version å­—æ®µ"
            exit 1
          fi

          # æ¸…ç†ç‰ˆæœ¬å·ï¼ˆç§»é™¤å¼•å·å’Œvå‰ç¼€ï¼‰
          CLEAN_VERSION=$(echo "$RAW_VERSION" | tr -d '\"'"'" | sed 's/^v//')
          
          # éªŒè¯ç‰ˆæœ¬æ ¼å¼ (x.y.z, x.y.z-dev, æˆ– dev)
          if [[ ! "$CLEAN_VERSION" =~ ^([0-9]+\.[0-9]+\.[0-9]+(-dev)?|dev)$ ]]; then
            echo "âŒ é”™è¯¯ï¼šç‰ˆæœ¬å·æ ¼å¼æ— æ•ˆï¼Œåº”ä¸º x.y.zã€x.y.z-dev æˆ– devï¼ˆä¾‹å¦‚ 1.0.1ã€1.0.1-dev æˆ– devï¼‰"
            echo "å½“å‰å€¼: '$CLEAN_VERSION'"
            exit 1
          fi

          # æ£€æŸ¥æ˜¯å¦ä¸ºdevç‰ˆæœ¬
          if [[ "$CLEAN_VERSION" == *"dev"* ]]; then
            echo "âš ï¸ æ£€æµ‹åˆ°devç‰ˆæœ¬ï¼Œå°†ä¸æ¨é€latestæ ‡ç­¾"
            echo "is_dev=true" >> $GITHUB_OUTPUT
          else
            echo "is_dev=false" >> $GITHUB_OUTPUT
          fi

          echo "âœ… ç‰ˆæœ¬å·: $CLEAN_VERSION"
          echo "version=$CLEAN_VERSION" >> $GITHUB_OUTPUT

      # 3. ç™»å½• Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 4. è®¾ç½® Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 5. æ„å»ºå¹¶æ¨é€ Docker é•œåƒï¼ˆå¸¦ç‰ˆæœ¬æ ‡ç­¾ï¼‰
      - name: Build and push with version tag
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: 7ommymerlin/notify-scheduler:${{ steps.version.outputs.version }}

      # 6. æ¨é€ latest æ ‡ç­¾ï¼ˆä»…édevç‰ˆæœ¬ï¼‰
      - name: Push latest tag
        if: steps.version.outputs.is_dev == 'false'
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: 7ommymerlin/notify-scheduler:latest

      # 7. éªŒè¯æ¨é€ç»“æœ
      - name: Verify pushed tags
        run: |
          echo "âœ… é•œåƒå·²æˆåŠŸæ¨é€è‡³ Docker Hub"
          echo "ğŸ“¦ é•œåƒæ ‡ç­¾:"
          echo "  - 7ommymerlin/notify-scheduler:${{ steps.version.outputs.version }}"
          if [ "${{ steps.version.outputs.is_dev }}" == "false" ]; then
            echo "  - 7ommymerlin/notify-scheduler:latest"
          else
            echo "  âš ï¸ devç‰ˆæœ¬ï¼Œæœªæ¨é€latestæ ‡ç­¾"
          fi